<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }

        /* ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .date-picker { padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; font-size: 16px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ */
        .student-row { display: flex; flex-direction: column; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: 0.3s; }
        .student-info { display: flex; align-items: center; margin-bottom: 10px; }
        .student-number { font-size: 18px; font-weight: bold; color: #64748b; width: 40px; text-align: center; }
        
        /* ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
        .img-container { position: relative; width: 60px; height: 60px; margin-right: 15px; }
        .student-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .upload-btn { position: absolute; bottom: -5px; right: -5px; background: var(--primary); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center;}
        
        .student-name { flex-grow: 1; font-size: 16px; font-weight: 600; color: #15283c; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-group { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;}
        .btn-status { flex: 1; padding: 8px 5px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-family: 'Prompt'; font-size: 14px; transition: 0.2s; text-align: center; font-weight: bold; color: #666;}
        
        /* ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */
        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}
        
        /* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .status-present.active { background-color: #28a745; color: white; border-color: #28a745; }
        .status-sick.active { background-color: #dc3545; color: white; border-color: #dc3545; }
        .status-leave.active { background-color: #ffc107; color: #000; border-color: #ffc107; }
        .status-absent.active { background-color: #fd7e14; color: white; border-color: #fd7e14; }

        /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .row-present { background-color: #e8f5e9; border-left: 6px solid #28a745; }
        .row-sick { background-color: #ffebee; border-left: 6px solid #dc3545; }
        .row-leave { background-color: #fff8e1; border-left: 6px solid #ffc107; }
        .row-absent { background-color: #fff3e0; border-left: 6px solid #fd7e14; }

        .save-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: 'Prompt'; margin-top: 10px;}
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h2 style="color: #1e56a0;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="text" id="username" style="width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; font-family: 'Prompt';" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" style="width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; font-family: 'Prompt';" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; padding: 12px; background: #1e56a0; color: white; border: none; border-radius: 8px; font-size: 16px; font-family: 'Prompt'; cursor: pointer;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker">
        </div>

        <div id="student-list-container">
            </div>

        <button class="save-btn" id="save-btn" onclick="saveAttendance()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="daily-page" class="page">
        <div class="card">
            <h2>üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
            <p style="color: #666; font-size: 13px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
            <input type="date" id="view-date" class="date-picker" style="margin-bottom: 15px;">
            <button onclick="loadDailyData()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Prompt';">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            
            <table id="daily-table">
                <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead>
                <tbody id="daily-body"><tr><td colspan='4' style='text-align:center;'>‡∏Å‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="summary-page" class="page">
        <div class="card">
            <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <p style="color: #666; font-size: 13px;">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏õ‡πà‡∏ß‡∏¢ ‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô</p>
            <button onclick="loadSummaryData()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: 'Prompt'; margin-bottom: 15px;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <table id="summary-table">
                <thead>
                    <tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th style="color:#28a745;">‡∏°‡∏≤</th><th style="color:#dc3545;">‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:#ffc107;">‡∏•‡∏≤</th><th style="color:#fd7e14;">‡∏Ç‡∏≤‡∏î</th></tr>
                </thead>
                <tbody id="summary-body"><tr><td colspan='6' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
            </table>
        </div>
    </div>

</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
</div>

<script>
    // üîó API ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxNLZgmZHDBLm5AtyRu30QjdWDqMlC_gJewTPtPHX3agFAnGCkfLthgtv864_2wFIsY/exec";

    document.getElementById('check-date').valueAsDate = new Date();
    document.getElementById('view-date').valueAsDate = new Date();

    let students = []; 
    let attendanceData = {}; 
    let currentTeacher = "";
    let currentClass = "";

    // ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    document.getElementById('check-date').addEventListener('change', fetchStudents);

    // --- üîê 1. ‡∏£‡∏∞‡∏ö‡∏ö Login ---
    function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const btn = document.getElementById('login-btn');

        if (!u || !p) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"); return; }

        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
        btn.disabled = true;

        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json())
            .then(data => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                btn.disabled = false;

                if (data.status === "success") {
                    currentTeacher = data.name;
                    currentClass = data.className || ""; 
                    
                    document.getElementById('user-display').innerText = `${currentTeacher} (${currentClass}) - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    document.getElementById('class-title').innerText = `(${currentClass})`;
                    document.getElementById('bottom-nav').style.display = 'flex';
                    
                    switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]);
                    
                    fetchStudents(); 
                } else {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            })
            .catch(err => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                btn.disabled = false;
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
            });
    }

    function logout() {
        location.reload(); 
    }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }
        document.getElementById(pageId).classList.add('active');
    }

    // --- üìã 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
    function fetchStudents() {
        const container = document.getElementById('student-list-container');
        container.innerHTML = `<div style="text-align:center; padding: 30px; color:#1e56a0; font-weight:bold;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        document.getElementById('save-btn').style.display = 'none';

        let dateRaw = document.getElementById('check-date').value;

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json())
            .then(dataStd => {
                if(dataStd.status === "success" && dataStd.data.length > 0) {
                    students = dataStd.data; 
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                    fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${dateRaw}`)
                        .then(res => res.json())
                        .then(dataCheck => {
                            if(dataCheck.status === "found") {
                                renderChecklist(dataCheck.data, dataCheck.recordedBy); // ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß = ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            } else {
                                renderChecklist(null, null); // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• = ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                            }
                        });
                } else {
                    container.innerHTML = `<div style="text-align:center; padding: 20px; color:red;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${currentClass} ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå D ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Students</div>`;
                }
            })
            .catch(err => {
                container.innerHTML = `<div style="text-align:center; padding: 20px; color:red;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</div>`;
            });
    }

    // --- üìù 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
    function renderChecklist(existingData, recordedBy) {
        const container = document.getElementById('student-list-container');
        container.innerHTML = "";

        if(existingData) {
            container.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; margin-bottom:15px; font-weight:bold;">
                ‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${document.getElementById('check-date').value} <br>‡∏´‡πâ‡∏≠‡∏á ${currentClass} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recordedBy}
            </div>`;
            document.getElementById('save-btn').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        } else {
            document.getElementById('save-btn').style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ã‡∏ü‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        }

        students.forEach(std => {
            let initStatus = 'present';
            let initNote = '';
            
            if(existingData && existingData[std.id]) {
                let thStat = existingData[std.id].status;
                if(thStat === "‡∏õ‡πà‡∏ß‡∏¢") initStatus = "sick";
                else if(thStat === "‡∏•‡∏≤") initStatus = "leave";
                else if(thStat === "‡∏Ç‡∏≤‡∏î") initStatus = "absent";
                initNote = existingData[std.id].note;
            }

            attendanceData[std.id] = { status: initStatus, note: initNote };
            let defaultImg = `https://ui-avatars.com/api/?name=${std.name}&background=f3f5f9`;

            let row = document.createElement('div');
            row.className = `student-row row-${initStatus}`; 
            row.id = `row-${std.id}`;

            let editModeHtml = "";
            let displayModeHtml = "";

            if (existingData) {
                let colorStat = initStatus==='present' ? 'green' : initStatus==='sick' ? 'red' : initStatus==='leave' ? '#ffc107' : 'orange';
                let thText = initStatus==='present' ? '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : initStatus==='sick' ? 'ü§í ‡∏õ‡πà‡∏ß‡∏¢' : initStatus==='leave' ? 'üìù ‡∏•‡∏≤' : '‚ùå ‡∏Ç‡∏≤‡∏î';
                
                displayModeHtml = `
                    <div id="display-mode-${std.id}" style="display:flex; justify-content:space-between; align-items:center; width:100%; margin-top:5px; background:#f8f9fa; padding:10px; border-radius:8px; box-sizing:border-box;">
                        <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b style="color:${colorStat}">${thText}</b></div>
                        <button onclick="enableEdit('${std.id}')" style="padding:5px 15px; background:#17a2b8; color:white; border:none; border-radius:5px; cursor:pointer; font-family:'Prompt';">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                `;
            }

            let btnStyle = existingData ? "display:none;" : "display:flex;";
            
            row.innerHTML = `
                <div class="student-info">
                    <div class="student-number">${std.number}</div>
                    <div class="img-container">
                        <img src="${defaultImg}" id="img-${std.id}" class="student-img">
                        <label class="upload-btn">üì∑<input type="file" accept="image/*" style="display:none;" onchange="previewImage(event, '${std.id}')"></label>
                    </div>
                    <div class="student-name">${std.name}<br><small style="color:#666;">‡∏£‡∏´‡∏±‡∏™: ${std.id}</small></div>
                </div>
                
                ${displayModeHtml}

                <div id="edit-mode-${std.id}" style="${btnStyle} flex-direction:column;">
                    <div class="status-group">
                        <div class="btn-status status-present ${initStatus==='present'?'active':''}" onclick="setStatus('${std.id}', 'present')">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="btn-status status-sick ${initStatus==='sick'?'active':''}" onclick="setStatus('${std.id}', 'sick')">ü§í ‡∏õ‡πà‡∏ß‡∏¢</div>
                        <div class="btn-status status-leave ${initStatus==='leave'?'active':''}" onclick="setStatus('${std.id}', 'leave')">üìù ‡∏•‡∏≤</div>
                        <div class="btn-status status-absent ${initStatus==='absent'?'active':''}" onclick="setStatus('${std.id}', 'absent')">‚ùå ‡∏Ç‡∏≤‡∏î</div>
                    </div>
                    <textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">${initNote}</textarea>
                    
                    ${existingData ? `<div style="display:flex; gap:10px; margin-top:10px;">
                        <button onclick="saveSingleUpdate('${std.id}')" style="flex:1; padding:8px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; font-family:'Prompt';">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="cancelEdit('${std.id}')" style="padding:8px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer; font-family:'Prompt';">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>` : ''}
                </div>
            `;
            container.appendChild(row);
        });
    }

    function enableEdit(id) {
        document.getElementById(`display-mode-${id}`).style.display = 'none';
        document.getElementById(`edit-mode-${id}`).style.display = 'flex';
    }

    function cancelEdit(id) {
        document.getElementById(`display-mode-${id}`).style.display = 'flex';
        document.getElementById(`edit-mode-${id}`).style.display = 'none';
    }

    function setStatus(id, status) {
        attendanceData[id].status = status;
        let row = document.getElementById(`row-${id}`);
        row.className = `student-row row-${status}`;
        row.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
        row.querySelector(`.status-${status}`).classList.add('active');
    }

    function previewImage(event, id) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById(`img-${id}`).src = e.target.result; }
            reader.readAsDataURL(file);
        }
    }

    // --- üíæ 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á (‡πÉ‡∏´‡∏°‡πà) ---
    function saveAttendance() {
        let date = document.getElementById('check-date').value;
        let saveBtn = document.getElementById('save-btn');
        let records = [];
        
        students.forEach(std => {
            records.push({
                id: std.id,
                name: std.name,
                className: std.className || currentClass,
                status: attendanceData[std.id].status,
                note: document.getElementById(`note-${std.id}`).value
            });
        });

        let payload = { action: "save_bulk", date: date, teacherName: currentTeacher, records: records };

        saveBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        saveBtn.disabled = true;

        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(data => {
            saveBtn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            saveBtn.disabled = false;
            if(data.status === "success") {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                populateDailyDataLocally(date, records); 
                fetchStudents(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î View
            } else {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
            }
        })
        .catch(err => {
            saveBtn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            saveBtn.disabled = false;
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ");
        });
    }

    // --- ‚úèÔ∏è 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ---
    function saveSingleUpdate(id) {
        let date = document.getElementById('check-date').value;
        let note = document.getElementById(`note-${id}`).value;
        let status = attendanceData[id].status;

        fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "update_single", date: date, id: id, className: currentClass, status: status, note: note, teacherName: currentTeacher })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
                fetchStudents(); 
            }
        });
    }

    function populateDailyDataLocally(date, records) {
        document.getElementById('view-date').value = date;
        let tbody = document.getElementById('daily-body');
        tbody.innerHTML = "";
        
        records.forEach((d, index) => {
            let statusTh = d.status === 'present' ? '<span style="color:green">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>' : 
                           d.status === 'sick' ? '<span style="color:red">‡∏õ‡πà‡∏ß‡∏¢</span>' :
                           d.status === 'leave' ? '<span style="color:#ffc107">‡∏•‡∏≤</span>' : '<span style="color:orange">‡∏Ç‡∏≤‡∏î</span>';
            
            tbody.innerHTML += `<tr>
                <td>${index + 1}</td>
                <td>${d.name}</td>
                <td><b>${statusTh}</b></td>
                <td style="color:#666; font-size:12px;">${d.note || '-'}</td>
            </tr>`;
        });
    }

    // --- üìÖ 6. ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á) ---
    function loadDailyData() {
        let viewDate = document.getElementById('view-date').value;
        if (!viewDate) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
        
        let tbody = document.getElementById('daily-body');
        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
        
        fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${viewDate}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = "";
                    if(data.data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                        return;
                    }
                    
                    data.data.forEach((d, index) => {
                        let statusTh = (d.status === '‡∏°‡∏≤' || d.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ? '<span style="color:green; font-weight:bold;">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>' : 
                                       d.status === '‡∏õ‡πà‡∏ß‡∏¢' ? '<span style="color:red; font-weight:bold;">‡∏õ‡πà‡∏ß‡∏¢</span>' :
                                       d.status === '‡∏•‡∏≤' ? '<span style="color:#ffc107; font-weight:bold;">‡∏•‡∏≤</span>' : '<span style="color:orange; font-weight:bold;">‡∏Ç‡∏≤‡∏î</span>';
                        
                        tbody.innerHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${d.name}</td>
                            <td>${statusTh}</td>
                            <td style="color:#666; font-size:12px;">${d.note || '-'}</td>
                        </tr>`;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan='4' style='text-align:center; color:red;'>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</td></tr>`;
                }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan='4' style='text-align:center; color:red;'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</td></tr>`;
            });
    }

    // --- üìä 7. ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á) ---
    function loadSummaryData() {
        let tbody = document.getElementById('summary-body');
        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</td></tr>`;
        
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = "";
                    if(data.data.length === 0) {
                        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢</td></tr>`;
                        return;
                    }
                    
                    data.data.forEach((d, index) => {
                        tbody.innerHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${d.name}</td>
                            <td style="color: #28a745; font-weight:bold;">${d.present}</td>
                            <td style="color: #dc3545;">${d.sick}</td>
                            <td style="color: #ffc107;">${d.leave}</td>
                            <td style="color: #fd7e14;">${d.absent}</td>
                        </tr>`;
                    });
                } else {
                    tbody.innerHTML = `<tr><td colspan='6' style='text-align:center; color:red;'>‚ùå ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</td></tr>`;
                }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan='6' style='text-align:center; color:red;'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</td></tr>`;
            });
    }
</script>

</body>
</html>
