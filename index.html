<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 15px auto; padding: 0 10px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        /* ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Dashboard */
        .live-status-bar { background: #fff; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: none; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600; color: #1e293b; border-bottom: 3px solid var(--primary); }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠: ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß + ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏° + ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≠ */
        .student-row { display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; gap: 8px; position: relative; }
        .student-number { font-size: 13px; font-weight: bold; color: #64748b; min-width: 20px; text-align: center; flex-shrink: 0; }
        .student-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 1.5px solid #e2e8f0; flex-shrink: 0; }
        .student-name { flex: 1; font-size: 14px; color: #15283c; font-weight: 500; line-height: 1.3; white-space: normal; word-wrap: break-word;}
        .status-dropdown { width: auto; min-width: 85px; margin-bottom: 0 !important; padding: 6px 4px !important; font-size: 13px !important; border-radius: 6px; flex-shrink: 0; cursor: pointer;}
        .btn-note { background: none; border: 1px solid #ccc; color: #666; border-radius: 50%; width: 32px; height: 32px; padding: 0; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer;}
        
        .row-present { border-left: 5px solid #28a745; background-color: #f0fdf4; }
        .row-absent { border-left: 5px solid #dc3545; background-color: #fef2f2; }
        .row-leave { border-left: 5px solid #ffc107; background-color: #fffbeb; }
        .row-sick { border-left: 5px solid #ef4444; background-color: #fff1f2; }

        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á AI */
        .ai-box { background: #f0f7ff; border-left: 5px solid #1e56a0; padding: 15px; border-radius: 8px; margin-bottom: 15px;}
        .ai-box h3 { margin-top: 0; color: #1e56a0; display:flex; align-items:center; gap:8px; font-size:15px; margin-bottom: 5px;}

        .footer-credit { text-align: center; padding: 25px; margin-top: 40px; color: #64748b; font-size: 13px; border-top: 1px dashed #ddd; line-height: 1.8; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="status-bar" class="live-status-bar">
        <span id="display-date"></span>
        <span id="display-clock" style="color:var(--primary);"></span>
    </div>

    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h2 style="color: #1e56a0; margin-bottom: 10px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <p id="login-clock" style="font-size:14px; font-weight:bold; color:#475569; margin-bottom:20px;"></p>
            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; font-size:16px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0; font-size: 18px;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker" style="padding: 6px; font-size: 14px;">
        </div>

        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô</h3>
            <p id="teacher-quick-ai" style="font-size:13px; margin:0; line-height:1.5; color:#333;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
        </div>

        <div id="student-list-container"></div>
        <button class="save-btn" id="save-btn" onclick="saveAttendance()" style="width:100%; padding:15px; font-size: 16px; margin-top: 10px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button>
    </div>

    <div id="daily-page" class="page">
        <div class="card">
            <h2 style="margin-top:0;">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
            <input type="date" id="view-date" class="date-picker" style="margin-bottom: 15px; width:100%;" onchange="loadDailyData()">
            <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                <h3 style="font-size:14px;">ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
                <p id="teacher-daily-ai" style="font-size:13px; margin:0;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            <div style="overflow-x:auto;">
                <table style="margin-top:0;"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="daily-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="summary-page" class="page">
        <div class="card">
            <h2 style="margin-top:0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                <h3 style="font-size:14px;">ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                <p id="teacher-summary-ai" style="font-size:13px; margin:0;"></p>
            </div>
            <div style="overflow-x:auto;">
                <table style="margin-top:0;"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th style="color:green;">‡∏°‡∏≤</th><th style="color:red;">‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:orange;">‡∏•‡∏≤</th><th style="color:red;">‡∏Ç‡∏≤‡∏î</th></tr></thead><tbody id="summary-body"></tbody></table>
            </div>
        </div>
    </div>

    <div class="footer-credit">
        ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢<br>
        <b>‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå</b><br>
        ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>
</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
</div>

<script>
    // üîó API ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á‡∏Ø
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby5v9D0fYSqrePeJM8G0zPOE6o96FMbdt5E0SdzTJfExgDWpmZvjaXHjdfZ1eWrLNNe/exec";
    
    // --- ‚è∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ---
    function updateClock() {
        const now = new Date();
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateStr = now.toLocaleDateString('th-TH', dateOptions);
        const timeStr = now.toLocaleTimeString('th-TH');
        
        if(document.getElementById('login-clock')) document.getElementById('login-clock').innerHTML = `${dateStr}<br>${timeStr} ‡∏ô.`;
        if(document.getElementById('display-date')) document.getElementById('display-date').innerText = dateStr;
        if(document.getElementById('display-clock')) document.getElementById('display-clock').innerText = `üïí ${timeStr} ‡∏ô.`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- ‚úÇÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ---
    function cleanName(fullName) {
        if (!fullName) return "";
        return fullName.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.)\s*/g, "").trim();
    }

    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "";

    function handleLogin() {
        const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim();
        if (!u || !p) return;
        document.getElementById('login-btn').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
        document.getElementById('login-btn').disabled = true;

        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json()).then(data => {
                document.getElementById('login-btn').innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('login-btn').disabled = false;
                
                if (data.status === "success") {
                    document.getElementById('user-display').innerText = `${data.name} - ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    document.getElementById('status-bar').style.display = 'flex';
                    
                    if (data.role === "teacher") { 
                        currentTeacher = data.name; currentClass = data.className; 
                        document.getElementById('class-title').innerText = `(${currentClass})`;
                        document.getElementById('bottom-nav').style.display = 'flex';
                        switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]);
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                        fetchStudents();
                        loadQuickAIInsight(); 
                    } 
                } else {
                    alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            }).catch(err => {
                document.getElementById('login-btn').innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
                document.getElementById('login-btn').disabled = false;
            });
    }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
        document.getElementById(pageId).classList.add('active');
        
        // Auto Update Content
        if (pageId === 'daily-page' && currentClass) loadDailyData();
        if (pageId === 'summary-page' && currentClass) loadSummaryData();
    }

    // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô AI Insight ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà Login
    function loadQuickAIInsight() {
        document.getElementById('teacher-quick-ai').innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...";
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    if(data.data.length === 0) {
                        document.getElementById('teacher-quick-ai').innerHTML = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‚úåÔ∏è";
                        return;
                    }
                    let sumTotal = 0, sumPres = 0;
                    let riskList = [];
                    
                    data.data.forEach(d => {
                        let stTotal = d.present + d.sick + d.leave + d.absent;
                        if(stTotal > 0) {
                            sumTotal += stTotal;
                            sumPres += d.present;
                            let perc = (d.present / stTotal) * 100;
                            // ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 80% ‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢)
                            if(perc < 80) riskList.push(cleanName(d.name)); 
                        }
                    });
                    
                    if(sumTotal === 0) {
                        document.getElementById('teacher-quick-ai').innerHTML = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö";
                        return;
                    }
                    
                    let avgPerc = ((sumPres / sumTotal) * 100).toFixed(1);
                    let aiMsg = `üìä <b>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°:</b> <b style="color:${avgPerc>=80?'green':'red'}; font-size:14px;">${avgPerc}%</b><br>`;
                    
                    if(riskList.length > 0) {
                        aiMsg += `‚ö†Ô∏è <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö (‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô < 80%) <b>${riskList.length} ‡∏Ñ‡∏ô</b> ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà <span style="color:#e63946;">${riskList.slice(0,3).join(', ')}${riskList.length>3?'...':''}</span> ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡∏ö`;
                    } else {
                        aiMsg += `üåü <b>‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80% ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö`;
                    }
                    document.getElementById('teacher-quick-ai').innerHTML = aiMsg;
                }
            });
    }

    // --- üìù ‡∏î‡∏∂‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ---
    function fetchStudents() {
        document.getElementById('student-list-container').innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</div>`;
        document.getElementById('check-date').valueAsDate = new Date(); 
        
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json()).then(data => {
                if(data.status === "success") {
                    students = data.data;
                    fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${document.getElementById('check-date').value}`)
                        .then(res => res.json()).then(check => {
                            renderChecklist(check.status === "found" ? check.data : null, check.recordedBy);
                        });
                }
            });
    }

    function renderChecklist(existing, recorder) {
        const container = document.getElementById('student-list-container'); 
        container.innerHTML = "";
        
        if(existing) {
            container.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; font-size:13px;">‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${document.getElementById('check-date').value} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recorder}</div>`;
            document.getElementById('save-btn').style.display = 'none'; 
        } else {
            document.getElementById('save-btn').style.display = 'block'; 
        }

        students.forEach(std => {
            let st = 'present', nt = ''; 
            if(existing && existing[std.id]) {
                let thStat = existing[std.id].status;
                st = thStat === "‡∏õ‡πà‡∏ß‡∏¢" ? "sick" : thStat === "‡∏•‡∏≤" ? "leave" : thStat === "‡∏Ç‡∏≤‡∏î" ? "absent" : "present";
                nt = existing[std.id].note;
            }
            attendanceData[std.id] = { status: st, note: nt };
            
            const displayName = cleanName(std.name);
            const imgUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1e56a0&color=fff&size=128&rounded=true`;

            let row = document.createElement('div');
            row.className = `student-row row-${st}`; 
            row.id = `row-${std.id}`;
            
            let displayModeHtml = "";
            if (existing) {
                let thText = st==='present' ? '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : st==='sick' ? 'ü§í ‡∏õ‡πà‡∏ß‡∏¢' : st==='leave' ? 'üìù ‡∏•‡∏≤' : '‚ùå ‡∏Ç‡∏≤‡∏î';
                let colorStat = st==='present' ? 'green' : st==='sick' ? 'red' : st==='leave' ? '#ffc107' : 'orange';
                displayModeHtml = `<div style="text-align:right; font-size:13px; font-weight:bold; color:${colorStat}; width:80px;">${thText}</div>`;
            }

            let selectHtml = existing ? "" : `
                <select class="status-dropdown" onchange="setStatus('${std.id}', this.value)">
                    <option value="present" ${st==='present'?'selected':''}>‚úÖ ‡∏°‡∏≤</option>
                    <option value="absent" ${st==='absent'?'selected':''}>‚ùå ‡∏Ç‡∏≤‡∏î</option>
                    <option value="leave" ${st==='leave'?'selected':''}>üìù ‡∏•‡∏≤</option>
                    <option value="sick" ${st==='sick'?'selected':''}>ü§í ‡∏õ‡πà‡∏ß‡∏¢</option>
                </select>
                <button class="btn-note" onclick="toggleNote('${std.id}')">üìù</button>
            `;

            row.innerHTML = `
                <div class="student-number">${std.number}</div>
                <img src="${imgUrl}" class="student-img" alt="student">
                <div class="student-name">${displayName}</div>
                ${displayModeHtml}
                ${selectHtml}
                
                <div id="note-box-${std.id}" style="display:none; position:absolute; right:10px; top:50px; z-index:100; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.15); width:220px; border:1px solid #eee;">
                    <textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">${nt}</textarea>
                    <button onclick="toggleNote('${std.id}')" style="width:100%; margin-top:8px; background:var(--primary); font-size:12px; padding:6px;">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function setStatus(id, s) { 
        attendanceData[id].status = s; 
        document.getElementById(`row-${id}`).className = `student-row row-${s}`; 
    }
    
    function toggleNote(id) { 
        let b = document.getElementById(`note-box-${id}`); 
        b.style.display = b.style.display === 'none' ? 'block' : 'none'; 
    }

    function saveAttendance() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; 
        btn.disabled = true;
        
        let records = [];
        students.forEach(s => records.push({ 
            id: s.id, 
            name: s.name, 
            className: currentClass, 
            status: attendanceData[s.id].status, 
            note: document.getElementById(`note-${s.id}`).value 
        }));
        
        fetch(GAS_API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "save_bulk", 
                date: document.getElementById('check-date').value, 
                teacherName: currentTeacher, 
                records: records 
            }) 
        })
        .then(res => res.json()).then(data => {
            btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)"; 
            btn.disabled = false;
            if(data.status === "success") {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                fetchStudents();
                loadQuickAIInsight(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ AI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü
            } else {
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
            }
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ) ---
    function loadDailyData() {
        let viewDate = document.getElementById('view-date').value;
        if (!viewDate) return;
        let tbody = document.getElementById('daily-body');
        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
        document.getElementById('teacher-daily-ai').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";
        fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${viewDate}`)
            .then(res => res.json()).then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = ""; let tPres = 0, tAbs = 0, tSick = 0;
                    if(data.data.length === 0) { 
                        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; 
                        document.getElementById('teacher-daily-ai').innerHTML = `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö`; return; 
                    }
                    data.data.forEach((d, index) => {
                        if(d.status === '‡∏°‡∏≤' || d.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') tPres++; else if(d.status === '‡∏Ç‡∏≤‡∏î') tAbs++; else tSick++;
                        let statusTh = (d.status === '‡∏°‡∏≤' || d.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ? '<span style="color:green; font-weight:bold;">‡∏°‡∏≤</span>' : d.status === '‡∏õ‡πà‡∏ß‡∏¢' ? '<span style="color:red; font-weight:bold;">‡∏õ‡πà‡∏ß‡∏¢</span>' : d.status === '‡∏•‡∏≤' ? '<span style="color:#ffc107; font-weight:bold;">‡∏•‡∏≤</span>' : '<span style="color:orange; font-weight:bold;">‡∏Ç‡∏≤‡∏î</span>';
                        tbody.innerHTML += `<tr><td>${index + 1}</td><td>${cleanName(d.name)}</td><td>${statusTh}</td><td style="font-size:12px;">${d.note || '-'}</td></tr>`;
                    });
                    let aiMsg = tPres === data.data.length ? `üåü <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</b> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏ö 100% ‡∏Ñ‡∏£‡∏±‡∏ö` : tAbs > 0 ? `‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${tAbs} ‡∏Ñ‡∏ô</b> ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö` : `üí° ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤ ${tSick} ‡∏Ñ‡∏ô</b> ‡∏Ñ‡∏£‡∏±‡∏ö`;
                    document.getElementById('teacher-daily-ai').innerHTML = aiMsg;
                }
            });
    }

    function loadSummaryData() {
        let tbody = document.getElementById('summary-body');
        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</td></tr>`;
        document.getElementById('teacher-summary-ai').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...";
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json()).then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = "";
                    if(data.data.length === 0) { 
                        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; 
                        document.getElementById('teacher-summary-ai').innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; return; 
                    }
                    let sumTotal = 0, sumPres = 0, riskStudents = [];
                    data.data.forEach((d, index) => {
                        let stTotal = d.present + d.sick + d.leave + d.absent;
                        if(stTotal > 0) {
                            sumTotal += stTotal; sumPres += d.present;
                            if((d.present / stTotal) * 100 < 80) riskStudents.push(cleanName(d.name));
                        }
                        tbody.innerHTML += `<tr><td>${index + 1}</td><td>${cleanName(d.name)}</td><td style="color:green;">${d.present}</td><td style="color:red;">${d.sick}</td><td style="color:orange;">${d.leave}</td><td style="color:red;">${d.absent}</td></tr>`;
                    });
                    let avgPerc = sumTotal > 0 ? (sumPres / sumTotal) * 100 : 0;
                    let sumAi = `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: <b style="color:${avgPerc>=80?'green':'red'};">${avgPerc.toFixed(1)}%</b><br>`;
                    sumAi += riskStudents.length > 0 ? `‚ö†Ô∏è ‡∏û‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${riskStudents.length} ‡∏Ñ‡∏ô: ${riskStudents.slice(0,3).join(', ')}` : `üåü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏£‡∏±‡∏ö`;
                    document.getElementById('teacher-summary-ai').innerHTML = sumAi;
                }
            });
    }

    function logout() { location.reload(); }
</script>

</body>
</html>
