<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å User (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) */
        .live-status-bar { background: #fff; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; display: none; justify-content: space-between; align-items: center; font-size: 14px; font-weight: bold; color: #1e293b; border-bottom: 3px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ñ‡∏£‡∏π) */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .date-picker { padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; font-size: 16px; margin-bottom:0; width:auto;}
        .student-row { display: flex; flex-direction: column; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; transition: 0.3s; }
        .student-info { display: flex; align-items: center; margin-bottom: 10px; }
        .student-number { font-size: 18px; font-weight: bold; color: #64748b; width: 40px; text-align: center; }
        .img-container { position: relative; width: 60px; height: 60px; margin-right: 15px; }
        .student-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .upload-btn { position: absolute; bottom: -5px; right: -5px; background: var(--primary); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center;}
        .student-name { flex-grow: 1; font-size: 16px; font-weight: 600; color: #15283c; }
        .status-group { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;}
        .btn-status { flex: 1; padding: 8px 5px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-family: 'Prompt'; font-size: 14px; transition: 0.2s; text-align: center; font-weight: bold; color: #666;}
        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}
        
        .status-present.active { background-color: #28a745; color: white; border-color: #28a745; }
        .status-sick.active { background-color: #dc3545; color: white; border-color: #dc3545; }
        .status-leave.active { background-color: #ffc107; color: #000; border-color: #ffc107; }
        .status-absent.active { background-color: #fd7e14; color: white; border-color: #fd7e14; }
        .row-present { background-color: #e8f5e9; border-left: 6px solid #28a745; }
        .row-sick { background-color: #ffebee; border-left: 6px solid #dc3545; }
        .row-leave { background-color: #fff8e1; border-left: 6px solid #ffc107; }
        .row-absent { background-color: #fff3e0; border-left: 6px solid #fd7e14; }
        .save-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; font-family: 'Prompt'; margin-top: 10px;}

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; background: white;}
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        
        .stat-grid { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
        .stat-card { flex: 1; min-width:80px; padding: 15px; border-radius: 10px; color: white; text-align: center; }
        .stat-blue { background: linear-gradient(135deg, #1e56a0, #2a6fcc); }
        .stat-green { background: linear-gradient(135deg, #28a745, #34ce57); }
        .stat-red { background: linear-gradient(135deg, #dc3545, #e4606d); }
        .stat-card h3 { margin: 0; font-size: 13px; opacity: 0.9; }
        .stat-card h2 { margin: 5px 0 0 0; font-size: 24px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏•‡πà‡∏≠‡∏á AI ü§ñ */
        .ai-box { background: #f0f7ff; border-left: 5px solid #1e56a0; padding: 15px; border-radius: 8px; margin-bottom: 20px;}
        .ai-box h3 { margin-top: 0; color: #1e56a0; display:flex; align-items:center; gap:8px; font-size:16px;}
        
        .exec-filters { display:flex; gap:10px; flex-wrap:wrap; background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .exec-filters div { flex: 1; min-width:140px;}
        .exec-filters label { font-size:12px; color:#666; font-weight:bold; }
        
        /* Footer ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ */
        .footer-credit { text-align: center; padding: 20px; margin-top: 40px; margin-bottom: 40px; color: #64748b; font-size: 13px; border-top: 1px dashed #ddd; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="status-bar" class="live-status-bar">
        <span id="display-date"></span>
        <span id="display-clock" style="color:var(--primary);"></span>
    </div>

    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h2 style="color: #1e56a0; margin-bottom: 5px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div id="live-clock" style="margin-bottom: 20px; color: #475569; font-size: 14px; font-weight: bold; background: #eef2f5; padding: 10px; border-radius: 8px; line-height: 1.6;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
            </div>

            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π, admin, ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; font-size:16px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="student-page" class="page">
        <h2 style="color: #1e56a0;">üéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        <div class="card stat-blue">
            <h3 id="st-name-display" style="margin:0; font-size: 20px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <p id="st-id-display" style="margin:5px 0 0 0; opacity: 0.9;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        <div class="stat-grid">
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><h2 id="st-stat-present">0</h2></div>
            <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î</h3><h2 id="st-stat-absent">0</h2></div>
            <div class="stat-card" style="background:#f59e0b;"><h3>‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤</h3><h2 id="st-stat-leave">0</h2></div>
        </div>
        <div class="ai-box">
            <h3>ü§ñ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
            <p id="ai-assessment-text" style="color:#333; line-height:1.6; margin-bottom:0; font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        <div class="card">
            <h3>üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
            <div style="overflow-x: auto;">
                <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="student-history-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker">
        </div>
        <div id="student-list-container"></div>
        <button class="save-btn" id="save-btn" onclick="saveAttendance()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="daily-page" class="page">
        <div class="card">
            <h2>üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Real-time)</h2>
            <input type="date" id="view-date" class="date-picker" style="margin-bottom: 15px; width:100%;" onchange="loadDailyData()">
            
            <div class="ai-box">
                <h3>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                <p id="teacher-daily-ai" style="color:#333; line-height:1.6; margin-bottom:0; font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</p>
            </div>

            <table id="daily-table" style="margin-top: 0;">
                <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead>
                <tbody id="daily-body"><tr><td colspan='4' style='text-align:center;'>‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="summary-page" class="page">
        <div class="card">
            <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Real-time)</h2>
            
            <div class="ai-box">
                <h3>ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <p id="teacher-summary-ai" style="color:#333; line-height:1.6; margin-bottom:0; font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°...</p>
            </div>

            <table id="summary-table" style="margin-top:0;">
                <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th style="color:#28a745;">‡∏°‡∏≤</th><th style="color:#dc3545;">‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:#ffc107;">‡∏•‡∏≤</th><th style="color:#fd7e14;">‡∏Ç‡∏≤‡∏î</th></tr></thead>
                <tbody id="summary-body"><tr><td colspan='6' style='text-align:center;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="admin-page" class="page">
        <h2 style="color: #1e56a0;">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h2>
        
        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p id="admin-system-ai" style="color:#333; line-height:1.6; margin-bottom:0; font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö...</p>
        </div>

        <div class="card">
            <h3>üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h3>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" id="admin-start"></div><div style="flex:1"><label>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="admin-end"></div></div>
        </div>
        <div class="card">
            <h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <div style="overflow-x: auto;"><table id="admin-users-table"><thead><tr><th>User</th><th>Pass</th><th>Role</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="admin-users-body"></tbody></table></div>
            <button onclick="addUserRow()" style="margin-top:10px; background:#28a745;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap;">
                <h3 style="margin:0;">üéì ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <select id="admin-class-filter" onchange="renderAdminStudents()" style="width:150px; margin:0; padding:8px;"><option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option></select>
            </div>
            <div style="overflow-x: auto; max-height: 400px; margin-top:15px; border-top: 1px solid #eee;">
                <table id="admin-students-table"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="admin-students-body"></tbody></table>
            </div>
            <button onclick="addStudentRow()" style="margin-top:15px; background:#28a745;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>
        <button onclick="saveAdminData()" style="width:100%; padding:15px; font-size:18px; margin-bottom: 20px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="exec-page" class="page">
        <h2 style="color: #1e56a0; margin-bottom:5px;">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</h2>
        
        <button onclick="fetchFullExecData()" style="width:100%; padding:10px; margin-bottom:15px; background:#17a2b8; color:white; border:none; border-radius:8px; font-family:'Prompt'; font-weight:bold; cursor:pointer;">
            üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Real-time)
        </button>

        <div class="exec-filters">
            <div>
                <label>üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                <select id="exec-view-type" onchange="updateExecViewDropdown()">
                    <option value="school">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    <option value="grade">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                    <option value="class">‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</option>
                    <option value="student">‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</option>
                </select>
            </div>
            <div id="exec-sub-filter-container" style="display:none;">
                <label>üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <select id="exec-sub-filter" onchange="processExecData()"></select>
                <input type="text" id="exec-sub-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." style="display:none;" onkeyup="if(event.keyCode===13) processExecData()">
            </div>
            <div>
                <label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="exec-date-start" onchange="processExecData()" style="padding:8px; font-size:12px;">
                    <input type="date" id="exec-date-end" onchange="processExecData()" style="padding:8px; font-size:12px;">
                </div>
            </div>
        </div>
        
        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h3>
            <p id="exec-ai-text" style="color:#333; line-height:1.6; margin-bottom:0; font-size:14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•...</p>
        </div>

        <div class="stat-grid">
            <div class="stat-card stat-blue"><h3>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô)</h3><h2 id="exec-total">0</h2></div>
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°</h3><h2 id="exec-present">0</h2></div>
            <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏∞‡∏™‡∏°</h3><h2 id="exec-absent">0</h2></div>
        </div>
        <div class="card" style="position: relative; height: 350px;">
            <h3>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h3>
            <canvas id="execChart"></canvas>
        </div>
        <div class="card">
            <h3 id="exec-table-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
            <div style="overflow-x: auto; max-height: 400px;">
                <table>
                    <thead id="exec-detail-head"><tr><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th style="color:green;">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th style="color:red;">‡∏Ç‡∏≤‡∏î</th><th style="color:orange;">‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤</th><th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô</th></tr></thead>
                    <tbody id="exec-detail-body"><tr><td colspan='5' style='text-align:center;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-credit">
        <b>‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢:</b> ‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå<br>
        ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>

</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
</div>

<script>
    // üîó API ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏•‡πâ‡∏ß)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwQ4v8pY_iQv9J8eL-p_zN3h1bI7XWzZ8E2gZkM9H92Qk_k8_e8V8C8Z6K1t7K0v0M/exec"; 
    
    document.getElementById('check-date').valueAsDate = new Date();
    document.getElementById('view-date').valueAsDate = new Date();
    
    let d = new Date();
    document.getElementById('exec-date-end').valueAsDate = d;
    d.setDate(d.getDate() - 30); 
    document.getElementById('exec-date-start').valueAsDate = d;

    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "";
    let allAdminStudentsData = []; 
    let execFullAttendance = [];
    let execFullStudents = [];
    let execChartInstance = null;

    document.getElementById('check-date').addEventListener('change', fetchStudents);

    // ==========================================
    // ‚è∞ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ Real-time (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 2 ‡∏à‡∏∏‡∏î)
    // ==========================================
    setInterval(() => {
        let now = new Date();
        let options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        let dateStr = now.toLocaleDateString('th-TH', options);
        let timeStr = now.toLocaleTimeString('th-TH');
        
        let loginClock = document.getElementById('live-clock');
        if(loginClock) loginClock.innerHTML = `üìÖ ‡∏ß‡∏±‡∏ô${dateStr} <br> ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr} ‡∏ô.`;

        let dispDate = document.getElementById('display-date');
        let dispClock = document.getElementById('display-clock');
        if(dispDate) dispDate.innerText = `üìÖ ${dateStr}`;
        if(dispClock) dispClock.innerText = `üïí ${timeStr} ‡∏ô.`;
    }, 1000);

    // ==========================================
    // üîê ‡∏£‡∏∞‡∏ö‡∏ö Login
    // ==========================================
    function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const btn = document.getElementById('login-btn');
        if (!u || !p) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"); return; }
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."; btn.disabled = true;

        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json())
            .then(data => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false;
                if (data.status === "success") {
                    document.getElementById('user-display').innerText = `${data.name} - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    
                    // üí° ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ñ‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å Role ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    document.getElementById('status-bar').style.display = 'flex'; 

                    if (data.role === "admin") {
                        document.getElementById('bottom-nav').style.display = 'none'; 
                        switchPage('admin-page', null); loadAdminData();
                    } else if (data.role === "executive" || data.role === "boss") {
                        document.getElementById('bottom-nav').style.display = 'none'; 
                        switchPage('exec-page', null); fetchFullExecData();
                    } else if (data.role === "teacher") {
                        currentTeacher = data.name; currentClass = data.className || ""; 
                        document.getElementById('class-title').innerText = `(${currentClass})`;
                        document.getElementById('bottom-nav').style.display = 'flex'; 
                        switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]); fetchStudents(); 
                    } else if (data.role === "student") {
                        document.getElementById('bottom-nav').style.display = 'none'; 
                        switchPage('student-page', null);
                        document.getElementById('st-name-display').innerText = data.name;
                        document.getElementById('st-id-display').innerText = `‡∏£‡∏´‡∏±‡∏™: ${u} | ‡∏ä‡∏±‡πâ‡∏ô: ${data.className}`;
                        loadStudentReport(u); 
                    }
                } else { alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
            }).catch(err => { btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false; });
    }

    function logout() { location.reload(); }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÇ‡∏ï‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (Real-time Experience)
    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
        document.getElementById(pageId).classList.add('active');
        
        // Auto Real-time fetch
        if (pageId === 'daily-page' && currentClass) loadDailyData();
        if (pageId === 'summary-page' && currentClass) loadSummaryData();
    }

    // ==========================================
    // üë©‚Äçüè´ ‡πÇ‡∏´‡∏°‡∏î TEACHER
    // ==========================================
    function fetchStudents() {
        const container = document.getElementById('student-list-container');
        container.innerHTML = `<div style="text-align:center; padding: 30px; font-weight:bold;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        document.getElementById('save-btn').style.display = 'none';
        let dateRaw = document.getElementById('check-date').value;

        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json())
            .then(dataStd => {
                if(dataStd.status === "success" && dataStd.data.length > 0) {
                    students = dataStd.data; 
                    fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${dateRaw}`)
                        .then(res => res.json())
                        .then(dataCheck => {
                            if(dataCheck.status === "found") renderChecklist(dataCheck.data, dataCheck.recordedBy);
                            else renderChecklist(null, null); 
                        });
                } else {
                    container.innerHTML = `<div style="text-align:center; color:red;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á ${currentClass}</div>`;
                }
            });
    }

    function renderChecklist(existingData, recordedBy) {
        const container = document.getElementById('student-list-container');
        container.innerHTML = "";
        if(existingData) {
            container.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; margin-bottom:15px; font-weight:bold;">‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${document.getElementById('check-date').value} <br>‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recordedBy}</div>`;
            document.getElementById('save-btn').style.display = 'none'; 
        } else {
            document.getElementById('save-btn').style.display = 'block'; 
        }

        students.forEach(std => {
            let initStatus = 'present', initNote = '';
            if(existingData && existingData[std.id]) {
                let thStat = existingData[std.id].status;
                initStatus = thStat === "‡∏õ‡πà‡∏ß‡∏¢" ? "sick" : thStat === "‡∏•‡∏≤" ? "leave" : thStat === "‡∏Ç‡∏≤‡∏î" ? "absent" : "present";
                initNote = existingData[std.id].note;
            }
            attendanceData[std.id] = { status: initStatus, note: initNote };
            let defaultImg = `https://ui-avatars.com/api/?name=${std.name}&background=f3f5f9`;
            let row = document.createElement('div');
            row.className = `student-row row-${initStatus}`; row.id = `row-${std.id}`;

            let displayModeHtml = "";
            if (existingData) {
                let colorStat = initStatus==='present' ? 'green' : initStatus==='sick' ? 'red' : initStatus==='leave' ? '#ffc107' : 'orange';
                let thText = initStatus==='present' ? '‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : initStatus==='sick' ? 'ü§í ‡∏õ‡πà‡∏ß‡∏¢' : initStatus==='leave' ? 'üìù ‡∏•‡∏≤' : '‚ùå ‡∏Ç‡∏≤‡∏î';
                displayModeHtml = `<div id="display-mode-${std.id}" style="display:flex; justify-content:space-between; align-items:center; width:100%; margin-top:5px; background:#f8f9fa; padding:10px; border-radius:8px; box-sizing:border-box;">
                    <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <b style="color:${colorStat}">${thText}</b></div>
                    <button onclick="enableEdit('${std.id}')" style="padding:5px 15px; background:#17a2b8;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>`;
            }
            let btnStyle = existingData ? "display:none;" : "display:flex;";
            row.innerHTML = `
                <div class="student-info">
                    <div class="student-number">${std.number}</div>
                    <div class="img-container"><img src="${defaultImg}" id="img-${std.id}" class="student-img"></div>
                    <div class="student-name">${std.name}<br><small style="color:#666;">‡∏£‡∏´‡∏±‡∏™: ${std.id}</small></div>
                </div>
                ${displayModeHtml}
                <div id="edit-mode-${std.id}" style="${btnStyle} flex-direction:column;">
                    <div class="status-group">
                        <div class="btn-status status-present ${initStatus==='present'?'active':''}" onclick="setStatus('${std.id}', 'present')">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div class="btn-status status-sick ${initStatus==='sick'?'active':''}" onclick="setStatus('${std.id}', 'sick')">ü§í ‡∏õ‡πà‡∏ß‡∏¢</div>
                        <div class="btn-status status-leave ${initStatus==='leave'?'active':''}" onclick="setStatus('${std.id}', 'leave')">üìù ‡∏•‡∏≤</div>
                        <div class="btn-status status-absent ${initStatus==='absent'?'active':''}" onclick="setStatus('${std.id}', 'absent')">‚ùå ‡∏Ç‡∏≤‡∏î</div>
                    </div>
                    <textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏... (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">${initNote}</textarea>
                    ${existingData ? `<div style="display:flex; gap:10px; margin-top:10px;"><button onclick="saveSingleUpdate('${std.id}')" style="flex:1; background:#28a745;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="cancelEdit('${std.id}')" style="background:#6c757d;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>` : ''}
                </div>`;
            container.appendChild(row);
        });
    }

    function enableEdit(id) { document.getElementById(`display-mode-${id}`).style.display = 'none'; document.getElementById(`edit-mode-${id}`).style.display = 'flex'; }
    function cancelEdit(id) { document.getElementById(`display-mode-${id}`).style.display = 'flex'; document.getElementById(`edit-mode-${id}`).style.display = 'none'; }
    function setStatus(id, status) {
        attendanceData[id].status = status;
        let row = document.getElementById(`row-${id}`);
        row.className = `student-row row-${status}`;
        row.querySelectorAll('.btn-status').forEach(btn => btn.classList.remove('active'));
        row.querySelector(`.status-${status}`).classList.add('active');
    }

    function saveAttendance() {
        let date = document.getElementById('check-date').value;
        let saveBtn = document.getElementById('save-btn');
        let records = [];
        students.forEach(std => {
            records.push({ id: std.id, name: std.name, className: std.className || currentClass, status: attendanceData[std.id].status, note: document.getElementById(`note-${std.id}`).value });
        });
        saveBtn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; saveBtn.disabled = true;
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "save_bulk", date: date, teacherName: currentTeacher, records: records }) })
        .then(res => res.json())
        .then(data => {
            saveBtn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; saveBtn.disabled = false;
            if(data.status === "success") { alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); fetchStudents(); } else alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
        });
    }

    function saveSingleUpdate(id) {
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "update_single", date: document.getElementById('check-date').value, id: id, className: currentClass, status: attendanceData[id].status, note: document.getElementById(`note-${id}`).value, teacherName: currentTeacher }) })
        .then(res => res.json()).then(data => { if(data.status === "success") { alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); fetchStudents(); } });
    }

    function loadDailyData() {
        let viewDate = document.getElementById('view-date').value;
        if (!viewDate) return;
        let tbody = document.getElementById('daily-body');
        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
        document.getElementById('teacher-daily-ai').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...";

        fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${viewDate}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = "";
                    let totalStd = data.data.length;
                    let tPres = 0, tAbs = 0, tSick = 0;

                    if(totalStd === 0) { 
                        tbody.innerHTML = `<tr><td colspan='4' style='text-align:center;'>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; 
                        document.getElementById('teacher-daily-ai').innerHTML = `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö`;
                        return; 
                    }
                    
                    data.data.forEach((d, index) => {
                        if(d.status === '‡∏°‡∏≤' || d.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') tPres++;
                        else if(d.status === '‡∏Ç‡∏≤‡∏î') tAbs++;
                        else tSick++;

                        let statusTh = (d.status === '‡∏°‡∏≤' || d.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ? '<span style="color:green; font-weight:bold;">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>' : d.status === '‡∏õ‡πà‡∏ß‡∏¢' ? '<span style="color:red; font-weight:bold;">‡∏õ‡πà‡∏ß‡∏¢</span>' : d.status === '‡∏•‡∏≤' ? '<span style="color:#ffc107; font-weight:bold;">‡∏•‡∏≤</span>' : '<span style="color:orange; font-weight:bold;">‡∏Ç‡∏≤‡∏î</span>';
                        tbody.innerHTML += `<tr><td>${index + 1}</td><td>${d.name}</td><td>${statusTh}</td><td style="color:#666; font-size:12px;">${d.note || '-'}</td></tr>`;
                    });

                    // ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
                    let aiMsg = "";
                    if(tPres === totalStd) aiMsg = `üåü <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</b> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${currentClass} ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏ö 100% ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°`;
                    else if(tAbs > 0) aiMsg = `‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${tAbs} ‡∏Ñ‡∏ô</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
                    else aiMsg = `üí° ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤ ${tSick} ‡∏Ñ‡∏ô</b> ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö`;
                    document.getElementById('teacher-daily-ai').innerHTML = aiMsg;
                }
            });
    }

    function loadSummaryData() {
        let tbody = document.getElementById('summary-body');
        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</td></tr>`;
        document.getElementById('teacher-summary-ai').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...";

        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    tbody.innerHTML = "";
                    if(data.data.length === 0) { 
                        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; 
                        document.getElementById('teacher-summary-ai').innerHTML = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                        return; 
                    }

                    let sumTotal = 0, sumPres = 0;
                    let riskStudents = [];

                    data.data.forEach((d, index) => {
                        let stTotal = d.present + d.sick + d.leave + d.absent;
                        if(stTotal > 0) {
                            sumTotal += stTotal;
                            sumPres += d.present;
                            let perc = (d.present / stTotal) * 100;
                            if(perc < 80) riskStudents.push(`<b>${d.name}</b> (${perc.toFixed(1)}%)`);
                        }
                        tbody.innerHTML += `<tr><td>${index + 1}</td><td>${d.name}</td><td style="color: #28a745; font-weight:bold;">${d.present}</td><td style="color: #dc3545;">${d.sick}</td><td style="color: #ffc107;">${d.leave}</td><td style="color: #fd7e14;">${d.absent}</td></tr>`;
                    });

                    // ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏£‡∏∏‡∏õ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
                    let avgPerc = sumTotal > 0 ? (sumPres / sumTotal) * 100 : 0;
                    let sumAi = `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ${currentClass} ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b style="color:${avgPerc>=80?'green':'red'}; font-size:16px;">${avgPerc.toFixed(1)}%</b><br><br>`;
                    
                    if(riskStudents.length > 0) {
                        sumAi += `‚ö†Ô∏è <b>‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 80%):</b><br>‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ${riskStudents.slice(0,3).join(', ')} ${riskStudents.length>3 ? ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏£‡∏ß‡∏° ${riskStudents.length} ‡∏Ñ‡∏ô` : ''}<br>üí° <b>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</b> ‡∏Ñ‡∏£‡∏π‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö`;
                    } else {
                        sumAi += `üåü <b>‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•!</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80% ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏≠‡∏≤‡πÉ‡∏à‡πÉ‡∏™‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö`;
                    }
                    document.getElementById('teacher-summary-ai').innerHTML = sumAi;
                }
            });
    }

    // ==========================================
    // ‚öôÔ∏è ‡πÇ‡∏´‡∏°‡∏î ADMIN
    // ==========================================
    function loadAdminData() {
        document.getElementById('admin-system-ai').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...";
        fetch(`${GAS_API_URL}?action=get_admin_data`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    document.getElementById('admin-start').value = data.config.startDate;
                    document.getElementById('admin-end').value = data.config.endDate;
                    let uBody = document.getElementById('admin-users-body');
                    uBody.innerHTML = "";
                    data.users.forEach((u, i) => {
                        uBody.innerHTML += `<tr>
                            <td><input type="text" value="${u[0]}" id="u-user-${i}"></td>
                            <td><input type="text" value="${u[1]}" id="u-pass-${i}"></td>
                            <td><select id="u-role-${i}"><option value="teacher" ${u[2]=='teacher'?'selected':''}>Teacher</option><option value="admin" ${u[2]=='admin'?'selected':''}>Admin</option><option value="executive" ${u[2]=='executive'?'selected':''}>Executive</option><option value="student" ${u[2]=='student'?'selected':''}>Student</option></select></td>
                            <td><input type="text" value="${u[3]}" id="u-name-${i}"></td>
                            <td><input type="text" value="${u[4]||''}" id="u-class-${i}"></td>
                            <td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td>
                        </tr>`;
                    });

                    // ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏∞‡∏ö‡∏ö Admin
                    let aiAdm = `üìä <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô:</b> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <b>${data.users.length}</b> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ | ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>${data.students.length}</b> ‡∏Ñ‡∏ô<br><br>`;
                    if(data.config.startDate && data.config.endDate) {
                        aiAdm += `‚úÖ <b>‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ô:</b> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà ${data.config.startDate} ‡∏ñ‡∏∂‡∏á ${data.config.endDate} ‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö`;
                    } else {
                        aiAdm += `‚ùå <b>‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</b> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡∏≠‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö!`;
                    }
                    document.getElementById('admin-system-ai').innerHTML = aiAdm;

                    allAdminStudentsData = data.students; 
                    updateClassDropdown(); renderAdminStudents(); 
                }
            });
    }

    function updateClassDropdown() {
        let filter = document.getElementById('admin-class-filter');
        let currentVal = filter.value;
        let classes = new Set();
        allAdminStudentsData.forEach(s => { if(s[3]) classes.add(s[3]); });
        filter.innerHTML = `<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>`;
        [...classes].sort().forEach(c => { filter.innerHTML += `<option value="${c}">${c}</option>`; });
        if(Array.from(filter.options).some(opt => opt.value === currentVal)) filter.value = currentVal;
    }

    function renderAdminStudents() {
        let sBody = document.getElementById('admin-students-body');
        sBody.innerHTML = "";
        let filterClass = document.getElementById('admin-class-filter').value;
        allAdminStudentsData.forEach((s, index) => {
            if (filterClass === 'all' || s[3] === filterClass) {
                sBody.innerHTML += `<tr>
                    <td><input type="text" value="${s[0]}" style="width:50px;" onchange="updateStudentData(${index}, 0, this.value)"></td>
                    <td><input type="text" value="${s[1]}" onchange="updateStudentData(${index}, 1, this.value)"></td>
                    <td><input type="text" value="${s[2]}" onchange="updateStudentData(${index}, 2, this.value)"></td>
                    <td><input type="text" value="${s[3]}" onchange="updateStudentData(${index}, 3, this.value); updateClassDropdown();"></td>
                    <td><button style="background:red;" onclick="removeStudent(${index})">‡∏•‡∏ö</button></td>
                </tr>`;
            }
        });
    }

    function updateStudentData(index, col, val) { allAdminStudentsData[index][col] = val; }
    function removeStudent(index) { if(confirm("‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?")) { allAdminStudentsData.splice(index, 1); updateClassDropdown(); renderAdminStudents(); } }
    
    function addUserRow() {
        let i = Date.now();
        document.getElementById('admin-users-body').innerHTML += `<tr><td><input type="text" id="u-user-${i}"></td><td><input type="text" id="u-pass-${i}"></td><td><select id="u-role-${i}"><option value="teacher">Teacher</option><option value="student">Student</option><option value="admin">Admin</option><option value="executive">Executive</option></select></td><td><input type="text" id="u-name-${i}"></td><td><input type="text" id="u-class-${i}"></td><td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`;
    }

    function addStudentRow() {
        let filterClass = document.getElementById('admin-class-filter').value;
        allAdminStudentsData.push(['', '', '', filterClass === 'all' ? '' : filterClass]);
        updateClassDropdown(); renderAdminStudents();
        let container = document.querySelector('#admin-students-table').parentElement; container.scrollTop = container.scrollHeight;
    }

    function saveAdminData() {
        let btn = document.querySelector('#admin-page > button'); btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        let users = [];
        document.querySelectorAll('#admin-users-body tr').forEach(tr => { let inputs = tr.querySelectorAll('input, select'); users.push([inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value, inputs[4].value]); });
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "admin_update", settings: { startDate: document.getElementById('admin-start').value, endDate: document.getElementById('admin-end').value }, users: users, students: allAdminStudentsData }) })
        .then(res => res.json()).then(data => { btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; if(data.status === "success") {alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); loadAdminData();} });
    }

    // ==========================================
    // üéì ‡πÇ‡∏´‡∏°‡∏î STUDENT 
    // ==========================================
    function loadStudentReport(studentId) {
        let tbody = document.getElementById('student-history-body'); tbody.innerHTML = `<tr><td colspan='3' style='text-align:center;'>‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>`;
        fetch(`${GAS_API_URL}?action=get_student_report&studentId=${encodeURIComponent(studentId)}`)
            .then(res => res.json())
            .then(data => {
                if(data.status === "success") {
                    let st = data.stats;
                    document.getElementById('st-stat-present').innerText = st.present;
                    document.getElementById('st-stat-absent').innerText = st.absent;
                    document.getElementById('st-stat-leave').innerText = st.sick + st.leave;
                    
                    let aiText = "";
                    if(st.total === 0) aiText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö! ‚úåÔ∏è";
                    else {
                        let presentPercent = (st.present / st.total) * 100;
                        if(presentPercent >= 90) aiText = `üåü <b>‡∏Ñ‡∏≥‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏™‡∏π‡∏á‡∏ñ‡∏∂‡∏á <b>${presentPercent.toFixed(1)}%</b> ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!`;
                        else if(presentPercent >= 70) aiText = `üëç <b>‡∏ô‡πà‡∏≤‡∏û‡∏≠‡πÉ‡∏à‡∏Ñ‡∏£‡∏±‡∏ö:</b> (<b>${presentPercent.toFixed(1)}%</b>) ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏ß‡∏±‡∏ô‡∏Ç‡∏≤‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô!`;
                        else aiText = `‚ö†Ô∏è <b>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å (<b>${presentPercent.toFixed(1)}%</b>) ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö! ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏î‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏π‡πâ‡πÜ!`;
                    }
                    document.getElementById('ai-assessment-text').innerHTML = aiText;
                    
                    tbody.innerHTML = "";
                    if(data.history.length === 0) tbody.innerHTML = `<tr><td colspan='3' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>`;
                    else { data.history.reverse().forEach(h => { let color = (h.status === '‡∏°‡∏≤' || h.status === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ? 'green' : h.status === '‡∏õ‡πà‡∏ß‡∏¢' ? 'red' : h.status === '‡∏•‡∏≤' ? '#ffc107' : 'orange'; tbody.innerHTML += `<tr><td>${h.date}</td><td><b style="color:${color}">${h.status}</b></td><td style="color:#666; font-size:12px;">${h.note || '-'}</td></tr>`; }); }
                }
            });
    }

    // ==========================================
    // üíº ‡πÇ‡∏´‡∏°‡∏î EXECUTIVE
    // ==========================================
    function fetchFullExecData() {
        document.getElementById('exec-ai-text').innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...";
        fetch(`${GAS_API_URL}?action=get_full_exec_data`).then(res => res.json()).then(data => { if(data.status === "success") { execFullAttendance = data.attendance; execFullStudents = data.students; updateExecViewDropdown(); } });
    }

    function updateExecViewDropdown() {
        let viewType = document.getElementById('exec-view-type').value;
        let container = document.getElementById('exec-sub-filter-container'), sel = document.getElementById('exec-sub-filter'), inp = document.getElementById('exec-sub-input');
        sel.style.display = 'none'; inp.style.display = 'none';
        if(viewType === 'school') { container.style.display = 'none'; } 
        else if(viewType === 'grade') {
            container.style.display = 'block'; sel.style.display = 'block';
            let grades = new Set(); execFullStudents.forEach(s => { if(s[3]) grades.add(s[3].split('/')[0]); }); 
            sel.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>`; [...grades].sort().forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
        } else if(viewType === 'class') {
            container.style.display = 'block'; sel.style.display = 'block';
            let classes = new Set(); execFullStudents.forEach(s => { if(s[3]) classes.add(s[3]); });
            sel.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>`; [...classes].sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        } else if(viewType === 'student') { container.style.display = 'block'; inp.style.display = 'block'; inp.value = ""; }
        processExecData(); 
    }

    function parseThaiDate(dtStr) { if(!dtStr) return new Date(0); let p = String(dtStr).trim().split('/'); return new Date(`${p[2]}-${p[1]}-${p[0]}`); }

    function processExecData() {
        let viewType = document.getElementById('exec-view-type').value;
        let subFilter = viewType === 'student' ? document.getElementById('exec-sub-input').value.trim() : document.getElementById('exec-sub-filter').value;
        let startD = document.getElementById('exec-date-start').valueAsDate || new Date(0), endD = document.getElementById('exec-date-end').valueAsDate || new Date();
        startD.setHours(0,0,0,0); endD.setHours(23,59,59,999);

        let stats = { present:0, absent:0, sick:0, leave:0, totalRecords:0 }, groupStats = {}; 

        execFullAttendance.forEach(row => {
            let rowDate = parseThaiDate(row[0]);
            if(rowDate >= startD && rowDate <= endD) {
                let id = String(row[1]).trim(), cName = String(row[3]).trim(), grade = cName.split('/')[0], stat = String(row[4]).trim();
                let match = false, groupKey = "";

                if(viewType === 'school') { match = true; groupKey = cName; } 
                else if(viewType === 'grade') { if(subFilter === 'all' || grade === subFilter) { match = true; groupKey = cName; } }
                else if(viewType === 'class') { if(subFilter === 'all' || cName === subFilter) { match = true; groupKey = row[2]; } }
                else if(viewType === 'student') { if(id === subFilter) { match = true; groupKey = row[0]; } }

                if(match) {
                    stats.totalRecords++;
                    if(!groupStats[groupKey]) groupStats[groupKey] = {present:0, absent:0, leave:0};
                    if(stat === "‡∏°‡∏≤" || stat === "‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô") { stats.present++; groupStats[groupKey].present++; }
                    else if(stat === "‡∏Ç‡∏≤‡∏î") { stats.absent++; groupStats[groupKey].absent++; }
                    else { stats.sick++; groupStats[groupKey].leave++; } 
                }
            }
        });

        document.getElementById('exec-total').innerText = stats.totalRecords; document.getElementById('exec-present').innerText = stats.present; document.getElementById('exec-absent').innerText = stats.absent + stats.sick + stats.leave;
        drawExecChart(viewType, groupStats, stats); drawExecTable(viewType, groupStats); generateAIRecommendation(viewType, stats, groupStats);
    }

    function drawExecChart(viewType, groupStats, totalStats) {
        let ctx = document.getElementById('execChart').getContext('2d');
        if(execChartInstance) execChartInstance.destroy();
        if(viewType === 'school' && Object.keys(groupStats).length > 5) {
            execChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏Ç‡∏≤‡∏î', '‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤'], datasets: [{ data: [totalStats.present, totalStats.absent, totalStats.sick + totalStats.leave], backgroundColor: ['#28a745', '#dc3545', '#ffc107'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        } else {
            let labels = Object.keys(groupStats).sort(), dPres = labels.map(k => groupStats[k].present), dAbs = labels.map(k => groupStats[k].absent), dLev = labels.map(k => groupStats[k].leave);
            execChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', data: dPres, backgroundColor: '#28a745' }, { label: '‡∏Ç‡∏≤‡∏î', data: dAbs, backgroundColor: '#dc3545' }, { label: '‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤', data: dLev, backgroundColor: '#ffc107' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
        }
    }

    function drawExecTable(viewType, groupStats) {
        let head = document.getElementById('exec-detail-head'), body = document.getElementById('exec-detail-body');
        head.innerHTML = `<tr><th>${viewType === 'class' ? "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" : viewType === 'student' ? "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" : "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"}</th><th style="color:green;">‡∏°‡∏≤</th><th style="color:red;">‡∏Ç‡∏≤‡∏î</th><th style="color:orange;">‡∏•‡∏≤</th><th>% ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th></tr>`;
        body.innerHTML = ""; let keys = Object.keys(groupStats).sort();
        if(keys.length === 0) { body.innerHTML = `<tr><td colspan='5' style='text-align:center;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
        keys.forEach(k => {
            let g = groupStats[k], tot = g.present + g.absent + g.leave, perc = tot > 0 ? ((g.present/tot)*100).toFixed(1) : 0, pColor = perc >= 80 ? 'green' : perc >= 60 ? 'orange' : 'red';
            body.innerHTML += `<tr><td><b>${k}</b></td><td>${g.present}</td><td>${g.absent}</td><td>${g.leave}</td><td><b style="color:${pColor};">${perc}%</b></td></tr>`;
        });
    }

    function generateAIRecommendation(viewType, stats, groupStats) {
        let aiBox = document.getElementById('exec-ai-text');
        if(stats.totalRecords === 0) { aiBox.innerHTML = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö"; return; }
        let presentRate = ((stats.present / stats.totalRecords) * 100).toFixed(1);
        let text = `<b>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <b style="font-size:16px; color:${presentRate>=80?'green':'red'};">${presentRate}%</b><br><br>`;
        if(viewType === 'school' || viewType === 'grade') {
            let worstClass = "", lowestRate = 100;
            for(let k in groupStats) { let r = (groupStats[k].present / (groupStats[k].present+groupStats[k].absent+groupStats[k].leave))*100; if(r < lowestRate) { lowestRate = r; worstClass = k; } }
            if(presentRate >= 85) text += `üåü <b>‡∏Ñ‡∏≥‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û<br>üí° <b>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</b> ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${worstClass} (${lowestRate.toFixed(1)}%)</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏π‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö`;
            else text += `‚ö†Ô∏è <b>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå 85% ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ <b>${worstClass} (${lowestRate.toFixed(1)}%)</b><br>üí° <b>‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
        } 
        else if (viewType === 'class') text += `üí° <b>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</b> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`;
        else text += `üí° <b>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</b> ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡∏ö`;
        aiBox.innerHTML = text;
    }
</script>

</body>
</html>
