<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 20px auto; padding: 0 10px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; font-size: 14px; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPad/Mobile */
        .student-row { display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; gap: 8px; transition: 0.3s; position: relative; }
        .student-number { font-size: 14px; font-weight: bold; color: #64748b; width: 25px; text-align: center; }
        .student-name { flex: 1; font-size: 14px; color: #15283c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .status-dropdown { width: 105px !important; margin-bottom: 0 !important; padding: 5px !important; font-size: 13px !important; background: #f8fafc; border: 1.5px solid #cbd5e1; border-radius: 6px;}
        
        /* ‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .row-present { border-left: 5px solid #28a745; background-color: #f0fdf4; }
        .row-absent { border-left: 5px solid #dc3545; background-color: #fef2f2; }
        .row-leave { border-left: 5px solid #ffc107; background-color: #fffbeb; }
        .row-sick { border-left: 5px solid #ef4444; background-color: #fff1f2; }

        /* Footer ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï */
        .footer-credit { text-align: center; padding: 20px; margin-top: 30px; color: #64748b; font-size: 12px; border-top: 1px dashed #ddd; line-height: 1.6; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h2 style="color: #1e56a0; margin-bottom: 5px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            
            <div id="live-clock" style="margin-bottom: 20px; color: #1e293b; font-size: 14px; font-weight: bold; background: #f1f5f9; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; line-height: 1.6;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô...
            </div>

            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0; font-size: 18px;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker">
        </div>
        <div id="student-list-container"></div>
        <button class="save-btn" id="save-btn" onclick="saveAttendance()" style="width:100%; padding:15px; margin-top:10px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div class="footer-credit">
        ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢<br>
        <b>‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå</b><br>
        ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>
</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
</div>

<script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby5v9D0fYSqrePeJM8G0zPOE6o96FMbdt5E0SdzTJfExgDWpmZvjaXHjdfZ1eWrLNNe/exec";
    
    // ‚è∞ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    function updateClock() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const datePart = now.toLocaleDateString('th-TH', options);
        const timePart = now.toLocaleTimeString('th-TH');
        const clockEl = document.getElementById('live-clock');
        if(clockEl) clockEl.innerHTML = `üìÖ ‡∏ß‡∏±‡∏ô${datePart}<br>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ ${timePart} ‡∏ô.`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "";

    function handleLogin() {
        const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim(), btn = document.getElementById('login-btn');
        if (!u || !p) return;
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..."; btn.disabled = true;
        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json()).then(data => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false;
                if (data.status === "success") {
                    document.getElementById('user-display').innerText = `${data.name} - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    if (data.role === "teacher") { 
                        currentTeacher = data.name; currentClass = data.className; 
                        document.getElementById('class-title').innerText = `(${currentClass})`;
                        document.getElementById('bottom-nav').style.display = 'flex';
                        switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]);
                        fetchStudents();
                    } 
                    // [‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Role ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°]
                } else alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }).catch(() => { btn.disabled = false; alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); });
    }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
        document.getElementById(pageId).classList.add('active');
        const isTeacherPage = ['checklist-page', 'daily-page', 'summary-page'].includes(pageId);
        document.getElementById('bottom-nav').style.display = isTeacherPage ? 'flex' : 'none';
    }

    function fetchStudents() {
        document.getElementById('student-list-container').innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>`;
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json()).then(data => {
                if(data.status === "success") {
                    students = data.data;
                    renderChecklist(null, "");
                }
            });
    }

    function renderChecklist(existing, recorder) {
        const container = document.getElementById('student-list-container'); container.innerHTML = "";
        students.forEach(std => {
            let st = 'present'; // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"
            attendanceData[std.id] = { status: st, note: "" };
            let row = document.createElement('div');
            row.className = `student-row row-${st}`; row.id = `row-${std.id}`;
            row.innerHTML = `
                <div class="student-number">${std.number}</div>
                <div class="student-name">${std.name}</div>
                <select class="status-dropdown" onchange="setStatus('${std.id}', this.value)">
                    <option value="present" selected>‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                    <option value="absent">‚ùå ‡∏Ç‡∏≤‡∏î</option>
                    <option value="leave">üìù ‡∏•‡∏≤</option>
                    <option value="sick">ü§í ‡∏õ‡πà‡∏ß‡∏¢</option>
                </select>
                <button onclick="toggleNote('${std.id}')" style="background:none; border:1px solid #ccc; color:#666; border-radius:50%; width:32px; height:32px; padding:0;">üìù</button>
                <div id="note-box-${std.id}" style="display:none; position:absolute; right:10px; top:45px; z-index:100; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:220px;">
                    <textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
                    <button onclick="toggleNote('${std.id}')" style="width:100%; margin-top:5px; background:var(--primary); font-size:12px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</button>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function setStatus(id, s) { 
        attendanceData[id].status = s; 
        document.getElementById(`row-${id}`).className = `student-row row-${s}`; 
    }
    
    function toggleNote(id) { 
        let b = document.getElementById(`note-box-${id}`); 
        b.style.display = b.style.display === 'none' ? 'block' : 'none'; 
    }

    function saveAttendance() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        let records = [];
        students.forEach(s => records.push({ id: s.id, name: s.name, className: currentClass, status: attendanceData[s.id].status, note: document.getElementById(`note-${s.id}`).value }));
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "save_bulk", date: document.getElementById('check-date').value, teacherName: currentTeacher, records: records }) })
        .then(res => res.json()).then(data => {
            btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; btn.disabled = false;
            alert(data.status === "success" ? "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        });
    }

    function logout() { location.reload(); }
</script>

</body>
</html>
