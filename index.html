<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö */
        .student-row { display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 12px; margin-bottom: 8px; gap: 10px; transition: 0.3s; position: relative; }
        .student-number { font-size: 14px; font-weight: bold; color: #64748b; width: 25px; text-align: center; }
        .student-name { flex: 1; font-size: 14px; color: #15283c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .status-group { display: flex; gap: 4px; flex: 2; margin-bottom: 0; }
        .btn-status { flex: 1; padding: 6px 2px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 11px; text-align: center; font-weight: bold; color: #666; transition: 0.2s;}
        
        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}
        
        /* Footer */
        .footer-credit { text-align: center; padding: 20px; margin-top: 40px; color: #64748b; font-size: 13px; border-top: 1px dashed #ddd; line-height: 1.6; }
        
        .ai-box { background: #f0f7ff; border-left: 5px solid #1e56a0; padding: 15px; border-radius: 8px; margin-bottom: 20px;}
        .ai-box h3 { margin-top: 0; color: #1e56a0; display:flex; align-items:center; gap:8px; font-size:16px;}
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <h2 style="color: #1e56a0; margin-bottom:5px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div id="live-clock" style="margin-bottom: 20px; color: #475569; font-size: 14px; font-weight: bold; background: #eef2f5; padding: 10px; border-radius: 8px;">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
            </div>
            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; font-size:16px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="student-page" class="page">
        <h2 style="color: #1e56a0;">üéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
        <div class="card stat-blue">
            <h3 id="st-name-display" style="margin:0; font-size: 18px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <p id="st-id-display" style="margin:5px 0 0 0; opacity: 0.9; font-size:14px;"></p>
        </div>
        <div class="stat-grid">
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><h2 id="st-stat-present">0</h2></div>
            <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î</h3><h2 id="st-stat-absent">0</h2></div>
            <div class="stat-card" style="background:#f59e0b;"><h3>‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤</h3><h2 id="st-stat-leave">0</h2></div>
        </div>
        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
            <p id="ai-assessment-text" style="font-size:14px;"></p>
        </div>
        <div class="card">
            <h3>üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</h3>
            <div style="overflow-x: auto;">
                <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="student-history-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker">
        </div>
        <div id="student-list-container"></div>
        <button class="save-btn" id="save-btn" onclick="saveAttendance()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="daily-page" class="page">
        <div class="card">
            <h2>üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Real-time)</h2>
            <input type="date" id="view-date" class="date-picker" style="margin-bottom: 15px; width:100%;" onchange="loadDailyData()">
            <div class="ai-box">
                <h3>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</h3>
                <p id="teacher-daily-ai" style="font-size:14px;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            <table id="daily-table"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="daily-body"></tbody></table>
        </div>
    </div>

    <div id="summary-page" class="page">
        <div class="card">
            <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Real-time)</h2>
            <div class="ai-box">
                <h3>ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                <p id="teacher-summary-ai" style="font-size:14px;"></p>
            </div>
            <table id="summary-table"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th style="color:green;">‡∏°‡∏≤</th><th style="color:red;">‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:orange;">‡∏•‡∏≤</th><th style="color:red;">‡∏Ç‡∏≤‡∏î</th></tr></thead><tbody id="summary-body"></tbody></table>
        </div>
    </div>

    <div id="admin-page" class="page">
        <h2 style="color: #1e56a0;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h2>
        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p id="admin-system-ai" style="font-size:14px;"></p>
        </div>
        <div class="card">
            <div style="display:flex; gap:10px;"><div style="flex:1"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" id="admin-start"></div><div style="flex:1"><label>‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input type="date" id="admin-end"></div></div>
        </div>
        <div class="card">
            <h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
            <div style="overflow-x: auto;"><table id="admin-users-table"><thead><tr><th>User</th><th>Pass</th><th>Role</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="admin-users-body"></tbody></table></div>
            <button onclick="addUserRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0;">üéì ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ô‡∏£.</h3><select id="admin-class-filter" onchange="renderAdminStudents()" style="width:120px; margin:0;"><option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option></select></div>
            <div style="overflow-x: auto; max-height:300px; margin-top:10px;"><table id="admin-students-table"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="admin-students-body"></tbody></table></div>
            <button onclick="addStudentRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ô‡∏£.</button>
        </div>
        <button onclick="saveAdminData()" style="width:100%; padding:15px; font-size:16px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="exec-page" class="page">
        <h2 style="color: #1e56a0;">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</h2>
        <button onclick="fetchFullExecData()" style="width:100%; margin-bottom:10px; background:#17a2b8;">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Real-time)</button>
        <div class="exec-filters">
            <div><label>üìå ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label><select id="exec-view-type" onchange="updateExecViewDropdown()"><option value="school">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option value="grade">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option><option value="class">‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</option><option value="student">‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option></select></div>
            <div id="exec-sub-filter-container" style="display:none;"><label>üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label><select id="exec-sub-filter" onchange="processExecData()"></select><input type="text" id="exec-sub-input" placeholder="‡∏£‡∏´‡∏±‡∏™ ‡∏ô‡∏£." style="display:none;" onkeyup="if(event.keyCode===13) processExecData()"></div>
            <div><label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><div style="display:flex; gap:5px;"><input type="date" id="exec-date-start" onchange="processExecData()"><input type="date" id="exec-date-end" onchange="processExecData()"></div></div>
        </div>
        <div class="ai-box"><h3>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h3><p id="exec-ai-text" style="font-size:14px;"></p></div>
        <div class="stat-grid">
            <div class="stat-card stat-blue"><h3>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h3><h2 id="exec-total">0</h2></div>
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><h2 id="exec-present">0</h2></div>
            <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î/‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤</h3><h2 id="exec-absent">0</h2></div>
        </div>
        <div class="card" style="height: 300px;"><canvas id="execChart"></canvas></div>
        <div class="card"><div style="overflow-x: auto;"><table><thead id="exec-detail-head"></thead><tbody id="exec-detail-body"></tbody></table></div></div>
    </div>

    <div class="footer-credit">
        ‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢<br>
        <b>‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå</b><br>
        ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>
</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
</div>

<script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby5v9D0fYSqrePeJM8G0zPOE6o96FMbdt5E0SdzTJfExgDWpmZvjaXHjdfZ1eWrLNNe/exec";
    
    // ‚è∞ ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ Real-time
    setInterval(() => {
        let now = new Date();
        document.getElementById('live-clock').innerHTML = `üìÖ ‡∏ß‡∏±‡∏ô${now.toLocaleDateString('th-TH', {weekday:'long', year:'numeric', month:'long', day:'numeric'})} <br> ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤ ${now.toLocaleTimeString('th-TH')} ‡∏ô.`;
    }, 1000);

    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "", allAdminStudentsData = [], execFullAttendance = [], execFullStudents = [], execChartInstance = null;

    // --- üîê 1. ‡∏£‡∏∞‡∏ö‡∏ö Login ---
    function handleLogin() {
        const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim(), btn = document.getElementById('login-btn');
        if (!u || !p) return;
        btn.innerText = "‚è≥ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö..."; btn.disabled = true;
        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json()).then(data => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false;
                if (data.status === "success") {
                    document.getElementById('user-display').innerText = `${data.name} - ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    if (data.role === "admin") { switchPage('admin-page'); loadAdminData(); }
                    else if (data.role === "executive" || data.role === "boss") { switchPage('exec-page'); fetchFullExecData(); }
                    else if (data.role === "teacher") { currentTeacher = data.name; currentClass = data.className; document.getElementById('class-title').innerText = `(${currentClass})`; document.getElementById('bottom-nav').style.display = 'flex'; switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]); fetchStudents(); }
                    else if (data.role === "student") { switchPage('student-page'); document.getElementById('st-name-display').innerText = data.name; document.getElementById('st-id-display').innerText = `‡∏£‡∏´‡∏±‡∏™: ${u} | ‡∏ä‡∏±‡πâ‡∏ô: ${data.className}`; loadStudentReport(u); }
                } else alert("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }).catch(() => { btn.disabled = false; });
    }

    function logout() { location.reload(); }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
        document.getElementById(pageId).classList.add('active');
        document.getElementById('bottom-nav').style.display = (pageId === 'checklist-page' || pageId === 'daily-page' || pageId === 'summary-page') ? 'flex' : 'none';
        if (pageId === 'daily-page') loadDailyData();
        if (pageId === 'summary-page') loadSummaryData();
    }

    // --- üìù 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ñ‡∏£‡∏π) ---
    function fetchStudents() {
        const container = document.getElementById('student-list-container');
        container.innerHTML = `<div style="text-align:center; padding: 20px;">‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>`;
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json()).then(data => {
                if(data.status === "success") {
                    students = data.data;
                    fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${document.getElementById('check-date').value}`)
                        .then(res => res.json()).then(check => renderChecklist(check.status === "found" ? check.data : null, check.recordedBy));
                }
            });
    }

    function renderChecklist(existing, recorder) {
        const container = document.getElementById('student-list-container'); container.innerHTML = "";
        if(existing) container.innerHTML = `<div style="background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:10px; font-size:13px;">‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recorder}</div>`;
        document.getElementById('save-btn').style.display = existing ? 'none' : 'block';

        students.forEach(std => {
            let st = 'present', nt = '';
            if(existing && existing[std.id]) { st = existing[std.id].status === "‡∏õ‡πà‡∏ß‡∏¢" ? "sick" : existing[std.id].status === "‡∏•‡∏≤" ? "leave" : existing[std.id].status === "‡∏Ç‡∏≤‡∏î" ? "absent" : "present"; nt = existing[std.id].note; }
            attendanceData[std.id] = { status: st, note: nt };

            let row = document.createElement('div');
            row.className = `student-row row-${st}`; row.id = `row-${std.id}`;
            row.innerHTML = `
                <div class="student-number">${std.number}</div>
                <div class="student-name">${std.name}<br><small style="color:#666;">‡∏£‡∏´‡∏±‡∏™: ${std.id}</small></div>
                <div class="status-group">
                    <div class="btn-status status-present ${st==='present'?'active':''}" onclick="setStatus('${std.id}','present')">‡∏°‡∏≤</div>
                    <div class="btn-status status-sick ${st==='sick'?'active':''}" onclick="setStatus('${std.id}','sick')">‡∏õ‡πà‡∏ß‡∏¢</div>
                    <div class="btn-status status-leave ${st==='leave'?'active':''}" onclick="setStatus('${std.id}','leave')">‡∏•‡∏≤</div>
                    <div class="btn-status status-absent ${st==='absent'?'active':''}" onclick="setStatus('${std.id}','absent')">‡∏Ç‡∏≤‡∏î</div>
                </div>
                <button onclick="toggleNote('${std.id}')" style="background:none; border:1px solid #ccc; color:#666; border-radius:50%; width:30px; height:30px; padding:0;">üìù</button>
                <div id="note-box-${std.id}" style="display:none; position:absolute; right:10px; top:45px; z-index:100; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.2); width:200px;">
                    <textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">${nt}</textarea>
                    <button onclick="toggleNote('${std.id}')" style="width:100%; margin-top:5px; background:var(--primary); font-size:12px;">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function toggleNote(id) { let b = document.getElementById(`note-box-${id}`); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }
    function setStatus(id, s) { attendanceData[id].status = s; let r = document.getElementById(`row-${id}`); r.className = `student-row row-${s}`; r.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active')); r.querySelector(`.status-${s}`).classList.add('active'); }

    function saveAttendance() {
        let records = []; students.forEach(s => records.push({ id: s.id, name: s.name, className: s.className || currentClass, status: attendanceData[s.id].status, note: document.getElementById(`note-${s.id}`).value }));
        document.getElementById('save-btn').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "save_bulk", date: document.getElementById('check-date').value, teacherName: currentTeacher, records: records }) })
        .then(res => res.json()).then(data => { alert(data.status==="success"?"‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à":"‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); fetchStudents(); document.getElementById('save-btn').innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; });
    }

    // --- üìÖ 3. ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏™‡∏£‡∏∏‡∏õ (Real-time) ---
    function loadDailyData() {
        let tbody = document.getElementById('daily-body'); tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
        fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${document.getElementById('view-date').value}`)
            .then(res => res.json()).then(data => {
                tbody.innerHTML = "";
                let tP = 0, tA = 0;
                data.data.forEach((d, i) => {
                    if(d.status==='‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') tP++; else tA++;
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${d.name}</td><td>${d.status}</td><td style="font-size:11px; color:#666;">${d.note||'-'}</td></tr>`;
                });
                document.getElementById('teacher-daily-ai').innerHTML = tP > tA ? `üåü ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö (${tP} ‡∏Ñ‡∏ô)` : `‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤ ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ (${tA} ‡∏Ñ‡∏ô) ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö`;
            });
    }

    function loadSummaryData() {
        let tbody = document.getElementById('summary-body'); tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`)
            .then(res => res.json()).then(data => {
                tbody.innerHTML = "";
                let risk = 0;
                data.data.forEach((d, i) => {
                    if(d.absent > 3) risk++;
                    tbody.innerHTML += `<tr><td>${i+1}</td><td>${d.name}</td><td>${d.present}</td><td>${d.sick}</td><td>${d.leave}</td><td>${d.absent}</td></tr>`;
                });
                document.getElementById('teacher-summary-ai').innerHTML = risk > 0 ? `‚ö†Ô∏è ‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${risk} ‡∏Ñ‡∏ô ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö` : `üåü ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
            });
    }

    // --- ‚öôÔ∏è 4. Admin ---
    function loadAdminData() {
        fetch(`${GAS_API_URL}?action=get_admin_data`).then(res => res.json()).then(data => {
            document.getElementById('admin-start').value = data.config.startDate; document.getElementById('admin-end').value = data.config.endDate;
            let uBody = document.getElementById('admin-users-body'); uBody.innerHTML = "";
            data.users.forEach((u, i) => { uBody.innerHTML += `<tr><td><input type="text" value="${u[0]}"></td><td><input type="text" value="${u[1]}"></td><td>${u[2]}</td><td><input type="text" value="${u[3]}"></td><td><input type="text" value="${u[4]||''}"></td><td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; });
            allAdminStudentsData = data.students; updateClassDropdown(); renderAdminStudents();
            document.getElementById('admin-system-ai').innerHTML = `üìä ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ${data.users.length} ‡∏£‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${data.students.length} ‡∏£‡∏≤‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö`;
        });
    }
    function updateClassDropdown() { let f = document.getElementById('admin-class-filter'); let s = new Set(); allAdminStudentsData.forEach(x => s.add(x[3])); f.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...s].sort().forEach(c => f.innerHTML += `<option value="${c}">${c}</option>`); }
    function renderAdminStudents() { let b = document.getElementById('admin-students-body'); b.innerHTML = ""; let f = document.getElementById('admin-class-filter').value; allAdminStudentsData.forEach((s, i) => { if (f==='all'||s[3]===f) b.innerHTML += `<tr><td>${s[0]}</td><td>${s[1]}</td><td>${s[2]}</td><td>${s[3]}</td><td><button style="background:red;" onclick="removeStudent(${i})">‡∏•‡∏ö</button></td></tr>`; }); }
    function removeStudent(i) { if(confirm("‡∏•‡∏ö?")) { allAdminStudentsData.splice(i,1); renderAdminStudents(); } }
    function addUserRow() { document.getElementById('admin-users-body').innerHTML += `<tr><td><input type="text"></td><td><input type="text"></td><td><select><option value="teacher">Teacher</option><option value="admin">Admin</option></select></td><td><input type="text"></td><td><input type="text"></td><td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; }
    function addStudentRow() { allAdminStudentsData.push(['','','',document.getElementById('admin-class-filter').value==='all'?'':document.getElementById('admin-class-filter').value]); renderAdminStudents(); }
    function saveAdminData() {
        let u = []; document.querySelectorAll('#admin-users-body tr').forEach(tr => { let i = tr.querySelectorAll('input, select'); u.push([i[0].value, i[1].value, i[2].value, i[3].value, i[4].value]); });
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "admin_update", settings: { startDate: document.getElementById('admin-start').value, endDate: document.getElementById('admin-end').value }, users: u, students: allAdminStudentsData }) }).then(() => alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
    }

    // --- üìä 5. Executive ---
    function fetchFullExecData() { fetch(`${GAS_API_URL}?action=get_full_exec_data`).then(res => res.json()).then(data => { execFullAttendance = data.attendance; execFullStudents = data.students; updateExecViewDropdown(); }); }
    function updateExecViewDropdown() {
        let v = document.getElementById('exec-view-type').value, c = document.getElementById('exec-sub-filter-container'), s = document.getElementById('exec-sub-filter'), i = document.getElementById('exec-sub-input');
        s.style.display = 'none'; i.style.display = 'none'; c.style.display = v === 'school' ? 'none' : 'block';
        if(v === 'grade') { s.style.display = 'block'; let g = new Set(); execFullStudents.forEach(x => g.add(x[3].split('/')[0])); s.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>'; [...g].sort().forEach(x => s.innerHTML += `<option value="${x}">${x}</option>`); }
        else if(v === 'class') { s.style.display = 'block'; let cl = new Set(); execFullStudents.forEach(x => cl.add(x[3])); s.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...cl].sort().forEach(x => s.innerHTML += `<option value="${x}">${x}</option>`); }
        else if(v === 'student') { i.style.display = 'block'; }
        processExecData();
    }
    function processExecData() {
        let v = document.getElementById('exec-view-type').value, sub = v === 'student' ? document.getElementById('exec-sub-input').value : document.getElementById('exec-sub-filter').value;
        let st = document.getElementById('exec-date-start').valueAsDate || new Date(0), en = document.getElementById('exec-date-end').valueAsDate || new Date();
        let stats = { p:0, a:0, total:0 }, gStat = {};
        execFullAttendance.forEach(row => {
            let dArr = row[0].split('/'); let rD = new Date(dArr[2], dArr[1]-1, dArr[0]);
            if(rD >= st && rD <= en) {
                let match = (v==='school') || (v==='grade' && (sub==='all'||row[3].startsWith(sub))) || (v==='class' && (sub==='all'||row[3]===sub)) || (v==='student' && row[1]===sub);
                if(match) {
                    stats.total++; let key = v==='school'?row[3]:(v==='class'?row[2]:row[0]);
                    if(!gStat[key]) gStat[key]={p:0, a:0};
                    if(row[4]==='‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'||row[4]==='‡∏°‡∏≤') { stats.p++; gStat[key].p++; } else { stats.a++; gStat[key].a++; }
                }
            }
        });
        document.getElementById('exec-total').innerText = stats.total; document.getElementById('exec-present').innerText = stats.p; document.getElementById('exec-absent').innerText = stats.a;
        updateExecUI(v, gStat, stats);
    }
    function updateExecUI(v, g, s) {
        let ctx = document.getElementById('execChart').getContext('2d'); if(execChartInstance) execChartInstance.destroy();
        let labels = Object.keys(g).sort(), dp = labels.map(k=>g[k].p), da = labels.map(k=>g[k].a);
        execChartInstance = new Chart(ctx, { type:'bar', data:{ labels:labels, datasets:[{label:'‡∏°‡∏≤', data:dp, backgroundColor:'#28a745'},{label:'‡∏Ç‡∏≤‡∏î', data:da, backgroundColor:'#dc3545'}] }, options:{ responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}} } });
        let h = document.getElementById('exec-detail-head'); h.innerHTML = `<tr><th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th><th>‡∏°‡∏≤</th><th>‡∏Ç‡∏≤‡∏î</th><th>%</th></tr>`;
        let b = document.getElementById('exec-detail-body'); b.innerHTML = "";
        labels.forEach(k => { let p = (g[k].p/(g[k].p+g[k].a)*100).toFixed(1); b.innerHTML += `<tr><td>${k}</td><td>${g[k].p}</td><td>${g[k].a}</td><td style="color:${p>=80?'green':'red'}">${p}%</td></tr>`; });
        document.getElementById('exec-ai-text').innerHTML = s.total > 0 ? `<b>‡∏™‡∏£‡∏∏‡∏õ:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏∑‡∏≠ <b>${(s.p/s.total*100).toFixed(1)}%</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 80% ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏£‡∏±‡∏ö` : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
    }

    // --- üßë‚Äçüéì 6. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ---
    function loadStudentReport(id) {
        fetch(`${GAS_API_URL}?action=get_student_report&studentId=${id}`).then(res=>res.json()).then(data => {
            document.getElementById('st-stat-present').innerText = data.stats.present;
            document.getElementById('st-stat-absent').innerText = data.stats.absent;
            document.getElementById('st-stat-leave').innerText = data.stats.sick + data.stats.leave;
            let p = (data.stats.present / data.stats.total * 100).toFixed(1);
            document.getElementById('ai-assessment-text').innerHTML = p >= 80 ? `üåü <b>‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å (${p}%) ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!` : `‚ö†Ô∏è <b>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∑‡∏≠ ${p}% ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö`;
            let b = document.getElementById('student-history-body'); b.innerHTML = "";
            data.history.reverse().forEach(x => { b.innerHTML += `<tr><td>${x.date}</td><td>${x.status}</td><td>${x.note||'-'}</td></tr>`; });
        });
    }
</script>
</body>
</html>
