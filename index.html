<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    
    <script>
        // üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå API ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxAOND9wcpAyclUb8tGDN9Ye7HAYRbMZl8wxBAju7-QqNgoVnVOEIXWqhIGYhLToj9M/exec"; 
        
        // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö Logout ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
        const IDLE_TIMEOUT = 5 * 60 * 1000; 
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 15px auto; padding: 0 10px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0 15px 0; border-top: 1px solid #ddd; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);}
        .nav-item { text-align: center; font-size: 12px; color: #64748b; cursor: pointer; flex: 1; transition: 0.3s; padding: 5px 0; border-radius: 8px;}
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 20px; display: block; margin-bottom: 2px;}
        .nav-item.active span { transform: scale(1.1); }
        
        input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        .btn-logout { background: #ef4444; color: white; border: 1px solid #dc2626; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-family: 'Prompt'; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.2s;}
        .btn-logout:hover { background: #dc2626; }

        .live-status-bar { background: #fff; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: none; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600; color: #1e293b; border-bottom: 3px solid var(--primary); }

        .student-row { display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; gap: 8px; position: relative; flex-wrap: wrap;}
        .student-number { font-size: 13px; font-weight: bold; color: #64748b; min-width: 20px; text-align: center; flex-shrink: 0; }
        .student-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 1.5px solid #e2e8f0; flex-shrink: 0; }
        .student-name { flex: 1; font-size: 14px; color: #15283c; font-weight: 500; line-height: 1.3; white-space: normal; word-wrap: break-word;}
        
        .status-dropdown { width: auto; min-width: 105px; margin-bottom: 0 !important; padding: 6px 4px !important; font-size: 13px !important; border-radius: 6px; flex-shrink: 0; cursor: pointer;}
        
        .row-‡∏°‡∏≤ { border-left: 5px solid #10b981; background-color: #f0fdf4; }
        .row-‡∏•‡∏≤‡∏Å‡∏¥‡∏à { border-left: 5px solid #f59e0b; background-color: #fffbeb; }
        .row-‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ { border-left: 5px solid #f43f5e; background-color: #fff1f2; }
        .row-‡∏Ç‡∏≤‡∏î { border-left: 5px solid #991b1b; background-color: #fee2e2; }
        .row-‡∏™‡∏≤‡∏¢ { border-left: 5px solid #eab308; background-color: #fef9c3; }
        .row-‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô { border-left: 5px solid #3b82f6; background-color: #eff6ff; }

        .btn-note { background: none; border: 1px solid #ccc; color: #666; border-radius: 50%; width: 32px; height: 32px; padding: 0; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer;}
        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; background: white;}
        th, td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: center; }
        th:nth-child(2), td:nth-child(2) { text-align: left; } 
        th { background: #f8f9fa; font-weight: 600;}
        .risk-row { background-color: #fee2e2 !important; }

        .stat-grid { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;}
        .stat-card { flex: 1; min-width:70px; padding: 12px; border-radius: 10px; color: white; text-align: center; }
        .stat-blue { background: linear-gradient(135deg, #1e56a0, #2a6fcc); }
        .stat-green { background: #10b981; }
        .stat-red { background: #ef4444; }
        .stat-card h3 { margin: 0; font-size: 12px; opacity: 0.9; }
        .stat-card h2 { margin: 3px 0 0 0; font-size: 20px; }

        .ai-box { background: #f0f7ff; border-left: 5px solid #1e56a0; padding: 15px; border-radius: 8px; margin-bottom: 15px;}
        .ai-box h3 { margin-top: 0; color: #1e56a0; display:flex; align-items:center; gap:8px; font-size:15px; margin-bottom: 5px;}

        .ai-exec-box { background: #fff; border: 1px solid #e2e8f0; border-left: 6px solid #8b5cf6; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);}
        .ai-exec-box h3 { margin-top: 0; color: #6d28d9; display:flex; align-items:center; gap:8px; font-size:16px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .ai-exec-box p { margin: 0; line-height: 1.6; font-size: 14px; color: #334155; }
        .ai-exec-box ul { margin: 10px 0 0 0; padding-left: 20px; }
        .ai-exec-box li { margin-bottom: 8px; }

        .calendar-month { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px;}
        .calendar-month h4 { margin: 0 0 10px 0; text-align: center; color: #1e56a0; font-size: 14px;}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-header { font-weight: bold; font-size: 11px; color: #64748b; padding-bottom: 5px; }
        .calendar-day { padding: 8px 0; border-radius: 6px; font-size: 12px; cursor: pointer; background: #f1f5f9; border: 1px solid #e2e8f0; transition: 0.2s; }
        .calendar-day:hover:not(.blank) { background: #cbd5e1; }
        .calendar-day.holiday { background: #ef4444; color: white; border-color: #ef4444; font-weight: bold; box-shadow: 0 2px 5px rgba(239,68,68,0.3);}
        .calendar-day.selected-leave { background: #f59e0b; color: white; border-color: #d97706; font-weight: bold; box-shadow: 0 2px 5px rgba(245,158,11,0.3);}
        .calendar-day.blank { background: transparent; border: none; cursor: default; color: #cbd5e1; }

        .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px;}
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(18px); }

        .admin-tabs, .student-tabs { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 0; }
        .admin-tab-btn, .student-tab-btn { flex: 1; min-width: 90px; padding: 12px 5px; text-align: center; background: #e2e8f0; color: #475569; border-radius: 12px 12px 0 0; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.3s; white-space: nowrap;}
        .admin-tab-btn.active, .student-tab-btn.active { background: #1e56a0; color: white; }
        .admin-tab-content, .student-tab-content, .exec-tab-content { display: none; background: #fff; border-radius: 0 12px 12px 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-tab-content.active, .student-tab-content.active, .exec-tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        /* üåü CSS ‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• */
        .id-card-container { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto 20px auto; position: relative; overflow: hidden; }
        .id-card-header { display: flex; align-items: center; border-bottom: 3px solid #1e56a0; padding-bottom: 10px; margin-bottom: 15px; justify-content: center; }
        .id-card-logo { width: 45px; height: auto; margin-right: 10px; }
        .id-card-title { color: #1e56a0; font-weight: bold; font-size: 16px; line-height: 1.2; text-align: left;}
        .id-card-body { display: flex; gap: 15px; align-items: flex-start; }
        .id-card-photo { width: 90px; height: 120px; background: #e2e8f0; border: 2px solid #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 11px; text-align: center; object-fit: cover; flex-shrink: 0; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);}
        .id-card-info { flex: 1; font-size: 13px; color: #334155; line-height: 1.8; }
        .id-card-info b { color: #0f172a; display: inline-block; width: 60px;}
        .id-card-footer { margin-top: 15px; text-align: center; font-family: 'Libre Barcode 39', cursive; font-size: 40px; color: #1e293b; padding-top: 10px; border-top: 1px dashed #cbd5e1;}

        .footer-credit { text-align: center; padding: 25px; margin-top: 30px; color: #64748b; font-size: 12px; border-top: 1px dashed #ddd; line-height: 1.8; background: #f8fafc; border-radius: 12px; }
        .swal2-title, .swal2-html-container, .swal2-confirm, .swal2-cancel { font-family: 'Prompt', sans-serif !important; }

        .live-dot { width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; display: inline-block; animation: pulseLive 1.5s infinite; }
        @keyframes pulseLive { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 5px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes floatMascot { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes popupScale { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .ai-help-btn { display: block; width: 100%; text-align: left; background: #f1f5f9; border: 1px solid #cbd5e1; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; font-family: 'Prompt'; font-size: 13px; color: #1e56a0; transition: 0.2s; font-weight: 500;}
        .ai-help-btn:hover { background: #e0f2fe; border-color: #38bdf8; }

        .exec-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .exec-tab-btn { flex: 1; text-align: center; padding: 12px; background: #e2e8f0; color: #475569; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .exec-tab-btn.active { background: #1e56a0; color: white; }
        
        .leaderboard-row { display: flex; align-items: center; background: #fff; padding: 10px 12px; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; transition: transform 0.2s; gap: 10px;}
        .leaderboard-row:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .rank-badge { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; font-size: 14px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .rank-1 { background: linear-gradient(135deg, #fcd34d, #f59e0b); font-size: 18px; width: 40px; height: 40px;}
        .rank-2 { background: linear-gradient(135deg, #e2e8f0, #94a3b8); font-size: 16px; width: 36px; height: 36px;}
        .rank-3 { background: linear-gradient(135deg, #fecaca, #ef4444); font-size: 16px; width: 36px; height: 36px;}
        .rank-other { background: #f1f5f9; color: #64748b; font-size: 13px; box-shadow: none; border: 1px solid #cbd5e1;}
        .std-lb-info { flex: 1; display: flex; flex-direction: column; }
        .std-lb-name { font-size: 14px; font-weight: bold; color: #1e293b; }
        .std-lb-class { font-size: 11px; color: #64748b; }
        .std-lb-score { font-size: 18px; font-weight: 900; color: #059669; }
        .std-lb-merit { font-size: 12px; color: #f59e0b; background: #fffbeb; padding: 2px 6px; border-radius: 10px; border: 1px solid #fde68a;}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
        üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="user-display" style="font-size: 12px; font-weight: normal;"></span>
        <button id="logout-btn" class="btn-logout" onclick="logout()" style="display: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</div>

<div class="container">
    <div id="status-bar" class="live-status-bar">
        <span id="display-date"></span>
        <span id="display-clock" style="color:var(--primary);"></span>
    </div>

    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgb1oewS_bG2frmr1y3aOrwykh-wBZiipEUv9BbTxGSQh2d-Ergv_Ez4MWoO4AO8_wdCG19Nrravj8iJCc33arzt3ZXi2lmQ2v1hKGvEIBcLdjcCkZdfdZF-p8DWehYl3lzSWhWSOI4NKeNhWRzWkUHRJnMs1KFVMW_BwwUq83DafDaQpwu3-hOs-Ieix0/s225/304789124_573612801071886_7852363760169451884_n.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" style="width: 120px; height: auto; margin-bottom: 15px;">
            <p id="login-clock" style="font-size:14px; font-weight:bold; color:#475569; margin-bottom:20px;"></p>
            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; font-size:16px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="teacher-pages" style="display:none;">
        <div id="checklist-page" class="page active">
            <div class="toolbar">
                <h2 style="margin: 0; font-size: 18px;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
                <input type="date" id="check-date" class="date-picker" style="padding: 6px; font-size: 14px;" onchange="fetchStudents()">
            </div>
            <div class="ai-box">
                <h3>ü§ñ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô</h3>
                <p id="teacher-quick-ai" style="font-size:13px; margin:0; line-height:1.5; color:#333;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
            </div>
            <div id="student-list-container"></div>
            <button class="save-btn" id="save-btn" onclick="saveAttendance()" style="width:100%; padding:15px; font-size:16px; margin-top: 10px; display:none;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div id="daily-page" class="page">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin:0; font-size: 18px; color: #1e56a0;">üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                    <span id="weekly-date-range" style="font-size:12px; font-weight:bold; background:#e0f2fe; color:#0369a1; padding:5px 10px; border-radius:6px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
                <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                    <h3 style="font-size:14px;">ü§ñ AI ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                    <p id="teacher-daily-ai" style="font-size:13px; margin:0;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
                <div style="overflow-x:auto;">
                    <table style="margin-top:0;">
                        <thead><tr><th style="width:30px;">‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th id="th-mon" style="width:40px;">‡∏à.</th><th id="th-tue" style="width:40px;">‡∏≠.</th><th id="th-wed" style="width:40px;">‡∏û.</th><th id="th-thu" style="width:40px;">‡∏û‡∏§.</th><th id="th-fri" style="width:40px;">‡∏®.</th></tr></thead>
                        <tbody id="daily-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="summary-page" class="page">
            <h2 style="color: #1e56a0; margin-bottom: 10px; margin-top:0;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß (‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á)</h2>
            <div class="stat-grid" id="teacher-stat-grid" style="display:none;">
                <div class="stat-card stat-blue"><h3>‡∏ô‡∏£. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><h2 id="tc-total-std">0</h2></div>
                <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><h2 id="tc-avg-perc">0%</h2></div>
                <div class="stat-card stat-red"><h3>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (<80%)</h3><h2 id="tc-risk-std">0</h2></div>
            </div>
            <div class="card" style="padding-top:10px;">
                <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                    <h3 style="font-size:14px;">ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                    <p id="teacher-summary-ai" style="font-size:13px; margin:0;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</p>
                </div>
                <div style="overflow-x:auto;">
                    <table style="margin-top:0; border: 1px solid #eee; white-space: nowrap;">
                        <thead><tr><th style="width: 30px;">‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th style="color:#10b981;">‡∏°‡∏≤</th><th style="color:#eab308;">‡∏™‡∏≤‡∏¢</th><th style="color:#f97316;">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th><th style="color:#f43f5e;">‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:#991b1b;">‡∏Ç‡∏≤‡∏î</th><th style="color:#3b82f6;">‡∏ô‡∏≠‡∏Å‡∏£.‡∏£.</th><th>%</th></tr></thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="behavior-page" class="page">
            <h2 style="color: #1e56a0; margin-bottom: 10px; margin-top:0;">üíØ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° <span id="beh-class-title" style="color:var(--primary);"></span></h2>
            <div class="card" style="padding-top:10px;">
                <div style="overflow-x:auto;">
                    <table style="margin-top:0; border: 1px solid #eee; white-space: nowrap;">
                        <thead>
                            <tr>
                                <th style="width: 30px;">‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th style="color:#ef4444;">üî¥ ‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å</th>
                                <th style="color:#10b981;">üåü ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</th>
                                <th style="color:#1e56a0;">üèÜ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th style="width: 60px;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="behavior-body">
                            <tr><td colspan='6' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="notifications-page" class="page">
            <h2 style="color: #1e56a0; margin-bottom: 10px; margin-top:0;">üîî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î <span id="notif-class-title" style="color:var(--primary);"></span></h2>
            <div class="card" style="background: #fffbeb; border: 1px solid #fcd34d;">
                <h3 style="margin-top:0; color: #b45309; display:flex; align-items:center; gap:8px;">üì® ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
                <div id="leave-notifications-container"><div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>
            </div>
        </div>
    </div>

    <div id="admin-pages" style="display:none;">
        <h2 style="color: #1e56a0; margin-bottom: 15px;">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)</h2>
        <div class="admin-tabs">
            <div class="admin-tab-btn active" onclick="switchAdminTab('tab-settings', this)">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="admin-tab-btn" onclick="switchAdminTab('tab-users', this)">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="admin-tab-btn" onclick="switchAdminTab('tab-students', this)">üéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
        </div>
        
        <div id="tab-settings" class="admin-tab-content active">
            <h3 style="color:#ef4444; margin-top:0;">‚è∞ ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <label class="switch"><input type="checkbox" id="admin-time-limit-toggle"><span class="slider"></span></label>
                <span id="time-limit-status-text" style="font-size:13px; font-weight:bold; color:#64748b;">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
            </div>
            <div id="time-limit-inputs" style="display:none; gap:10px; background:#f0fdf4; padding:15px; border-radius:8px; border:1px solid #bbf7d0;">
                <div style="flex:1"><label style="font-size:12px; font-weight:bold; color:#166534;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ô.)</label><input type="time" id="admin-start-time" value="07:30" style="margin-bottom:0;"></div>
                <div style="flex:1"><label style="font-size:12px; font-weight:bold; color:#166534;">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ô.)</label><input type="time" id="admin-end-time" value="08:30" style="margin-bottom:0;"></div>
            </div>
            <h3 style="margin-top:20px;">üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ & ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label style="font-size:12px; font-weight:bold;">‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</label><input type="date" id="admin-start" onchange="renderAdminCalendar()"></div>
                <div style="flex:1"><label style="font-size:12px; font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</label><input type="date" id="admin-end" onchange="renderAdminCalendar()"></div>
            </div>
            <div id="school-days-count" style="margin-top: 15px; font-weight: bold; color: #1e56a0; background: #e0f2fe; padding: 12px; border-radius: 8px; border-left: 5px solid #1e56a0; display: flex; justify-content: space-between; align-items: center;">
                <div>üéì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á: <span id="working-days-text" style="font-size:18px; color:#ef4444;">0</span> ‡∏ß‡∏±‡∏ô</div>
            </div>
            <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top:15px;">
                <label style="font-weight:bold; color:#ef4444; display:block; margin-bottom:10px;">‚õî ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô)</label>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; font-size:12px; flex-wrap: wrap;">
                    <div style="width:15px; height:15px; background:#f1f5f9; border:1px solid #ccc; border-radius:3px;"></div> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
                    <div style="width:15px; height:15px; background:#ef4444; border-radius:3px; margin-left:10px;"></div> ‡∏´‡∏¢‡∏∏‡∏î
                    <button id="fetch-holidays-btn" onclick="fetchPublicHolidays()" style="background:#10b981; margin-left:auto; font-size:12px; padding:6px 12px; border-radius: 6px;">üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢</button>
                </div>
                <div id="admin-calendar-container" style="max-height: 400px; overflow-y: auto; padding-right:5px;"></div>
            </div>
            <button class="btn-save-admin" onclick="saveAdminData(this)" style="width:100%; padding:15px; font-size:16px; margin-top:20px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div id="tab-users" class="admin-tab-content">
            <h3 style="margin-top:0;">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <div style="overflow-x: auto;">
                <table id="admin-users-table">
                    <thead><tr><th>User</th><th>Pass</th><th>Role</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="admin-users-body"></tbody>
                </table>
            </div>
            <button onclick="addUserRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
            <button class="btn-save-admin" onclick="saveAdminData(this)" style="width:100%; padding:15px; font-size:16px; margin-top:20px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
        </div>

        <div id="tab-students" class="admin-tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üéì ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <select id="admin-class-filter" onchange="renderAdminStudents()" style="width:120px; margin:0;"><option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option></select>
            </div>
            <div style="overflow-x: auto; max-height:400px; margin-top:15px;">
                <table id="admin-students-table">
                    <thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody id="admin-students-body"></tbody>
                </table>
            </div>
            <button onclick="addStudentRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ô‡∏£.</button>
            <button class="btn-save-admin" onclick="saveAdminData(this)" style="width:100%; padding:15px; font-size:16px; margin-top:20px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

    <div id="exec-pages" style="display:none;">
        <h2 style="color: #1e56a0; margin-bottom: 5px;">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</h2>
        <button onclick="fetchFullExecData()" style="width:100%; margin-bottom:15px; background:#17a2b8; display:flex; justify-content:center; align-items:center; gap:5px; border-radius:8px;">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        
        <div class="card" style="background:#f8fafc; border:1px solid #e2e8f0; margin-bottom:15px; padding:15px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div style="flex:1; min-width:140px;">
                    <label style="font-size:12px; font-weight:bold; color:#1e56a0;">üìå ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                    <select id="exec-view-type" onchange="updateExecViewDropdown()" style="margin-bottom:0; background:white;">
                        <option value="school">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                        <option value="grade">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>
                        <option value="class">‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</option>
                    </select>
                </div>
                <div id="exec-sub-filter-container" style="display:none; flex:1; min-width:140px;">
                    <label style="font-size:12px; font-weight:bold; color:#1e56a0;">üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                    <select id="exec-sub-filter" onchange="processExecData()" style="margin-bottom:0; background:white;"></select>
                </div>
            </div>
            <div style="margin-top:10px; border-top:1px dashed #cbd5e1; padding-top:10px;">
                <label style="font-size:12px; font-weight:bold; color:#1e56a0;">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏°‡∏µ‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="exec-date-start" onchange="processExecData()" style="margin-bottom:0; background:white;">
                    <input type="date" id="exec-date-end" onchange="processExecData()" style="margin-bottom:0; background:white;">
                </div>
            </div>
        </div>

        <div class="exec-tabs">
            <div class="exec-tab-btn active" id="btn-exec-tab-att" onclick="switchExecTab('exec-tab-attendance', this)">üìä ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
            <div class="exec-tab-btn" id="btn-exec-tab-beh" onclick="switchExecTab('exec-tab-behavior', this)">üèÜ ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
        </div>

        <div id="exec-tab-attendance" class="exec-tab-content active">
            <div class="ai-exec-box">
                <h3>ü§ñ ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <div id="exec-ai-insight"><p style="text-align:center; color:#64748b;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p></div>
            </div>
            <div class="stat-grid" style="margin-bottom: 10px;">
                <div class="stat-card stat-blue"><h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h3><h2 id="exec-total">0</h2></div>
                <div class="stat-card stat-green"><h3>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><h2 id="exec-present-perc">0%</h2></div>
            </div>
            <div class="card" style="height: 350px;"><canvas id="execChart"></canvas></div>
            <div class="card">
                <h3 style="margin-top:0; color:#1e56a0;">üìã ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (‡∏£‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°)</h3>
                <div style="overflow-x: auto; max-height: 400px;">
                    <table style="white-space: nowrap;">
                        <thead id="exec-detail-head">
                            <tr><th>‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</th><th style="color:#10b981;">‡∏°‡∏≤</th><th style="color:#eab308;">‡∏™‡∏≤‡∏¢</th><th style="color:#f97316;">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th><th style="color:#f43f5e;">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th><th style="color:#991b1b;">‡∏Ç‡∏≤‡∏î</th><th style="color:#3b82f6;">‡∏ô‡∏≠‡∏Å ‡∏£.‡∏£.</th><th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th></tr>
                        </thead>
                        <tbody id="exec-detail-body"><tr><td colspan='8' style='text-align:center;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="exec-tab-behavior" class="exec-tab-content">
            <div class="ai-exec-box" style="border-left-color:#059669; background:#ecfdf5;">
                <h3 style="color:#059669;">ü§ñ ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
                <div id="exec-ai-behavior-insight"><p style="text-align:center; color:#64748b;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°...</p></div>
            </div>
            
            <div class="card" style="background: linear-gradient(180deg, #ffffff 0%, #f0fdf4 100%); border: 2px solid #a7f3d0;">
                <h3 style="margin-top:0; color:#059669; text-align:center;">üèÜ TOP 10 ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡∏µ‡πÄ‡∏î‡πà‡∏ô</h3>
                <p style="text-align:center; font-size:12px; color:#64748b; margin-top:-5px; margin-bottom:15px; font-weight:bold;" id="exec-leaderboard-subtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                <div id="exec-leaderboard-container"></div>
            </div>
            
            <div class="card" style="background: linear-gradient(180deg, #ffffff 0%, #fef2f2 100%); border: 2px solid #fecaca; margin-top:15px;">
                <h3 style="margin-top:0; color:#dc2626; text-align:center;">‚ö†Ô∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö)</h3>
                <div id="exec-risk-container"></div>
            </div>
        </div>
    </div>

    <div id="student-pages" style="display:none;">
        <div style="background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 5px solid #1e56a0;">
            <div style="font-size: 14px; color: #475569; margin-bottom: 6px; display: flex; flex-wrap: wrap; gap: 10px;">
                <span><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</b> <span id="hdr-num" style="color:#ef4444;">-</span></span>
                <span style="color:#cbd5e1;">|</span>
                <span><b>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</b> <span id="hdr-id" style="color:#10b981;">-</span></span>
                <span style="color:#cbd5e1;">|</span>
                <span><b>‡∏ä‡∏±‡πâ‡∏ô:</b> <span id="hdr-class" style="color:#f59e0b;">-</span></span>
            </div>
            <div id="hdr-name" style="font-size: 18px; font-weight: bold; color: #0f172a;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <div id="tab-std-card" class="student-tab-content active">
            <div class="id-card-container">
                <div class="id-card-header">
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgb1oewS_bG2frmr1y3aOrwykh-wBZiipEUv9BbTxGSQh2d-Ergv_Ez4MWoO4AO8_wdCG19Nrravj8iJCc33arzt3ZXi2lmQ2v1hKGvEIBcLdjcCkZdfdZF-p8DWehYl3lzSWhWSOI4NKeNhWRzWkUHRJnMs1KFVMW_BwwUq83DafDaQpwu3-hOs-Ieix0/s225/304789124_573612801071886_7852363760169451884_n.png" alt="Logo" class="id-card-logo">
                    <div class="id-card-title">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤<br><span style="font-size:12px; color:#64748b; font-weight:normal;">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></div>
                </div>
                <div class="id-card-body">
                    <div class="id-card-photo">‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û<br>‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                    <div class="id-card-info">
                        <div><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</b> <span id="id-card-name">-</span></div>
                        <div><b>‡∏£‡∏´‡∏±‡∏™</b> <span id="id-card-id">-</span></div>
                        <div><b>‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b> <span id="id-card-class">-</span></div>
                        <div><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</b> <span id="id-card-number">-</span></div>
                    </div>
                </div>
                <div class="id-card-footer"><span id="id-card-barcode">123456789</span></div>
            </div>
        </div>

        <div id="tab-std-attendance" class="student-tab-content">
            <div class="stat-grid">
                <div class="stat-card stat-green"><h3>‡∏°‡∏≤</h3><h2 id="st-stat-present">0</h2></div>
                <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î</h3><h2 id="st-stat-absent">0</h2></div>
                <div class="stat-card" style="background:#f59e0b;"><h3>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3><h2 id="st-stat-leave">0</h2></div>
            </div>
            <div class="ai-box" style="margin-bottom: 15px;"><p id="ai-assessment-text" style="font-size:13px; margin:0;"></p></div>
            <h3 style="margin-top:0; color:#1e56a0; border-bottom:1px solid #eee; padding-bottom:8px;">üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
            <div style="overflow-x: auto;">
                <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="student-history-body"></tbody></table>
            </div>
        </div>

        <div id="tab-std-leave" class="student-tab-content" style="background:#fffbeb; border:1px solid #fcd34d;">
            <h3 style="margin-top:0; color:#b45309; display:flex; align-items:center; gap:8px;">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</h3>
            <label style="font-size:12px; font-weight:bold; color:#92400e;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏•‡∏≤ (‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</label>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <button onclick="changeStudentMonth(-1)" style="padding:5px 10px; background:#f59e0b; font-size:12px;">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <b id="student-calendar-month-label" style="color:#b45309; font-size:14px;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ</b>
                <button onclick="changeStudentMonth(1)" style="padding:5px 10px; background:#f59e0b; font-size:12px;">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
            </div>
            <div id="student-leave-calendar-container" style="background:#fff; border-radius:8px; padding:10px; margin-bottom:10px; border:1px solid #fde68a;"></div>
            <div id="selected-leave-dates-display" style="font-size:12px; color:#b91c1c; margin-bottom:10px; font-weight:bold; background:#fee2e2; padding:8px; border-radius:6px; display:none;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: </div>
            <label style="font-size:12px; font-weight:bold; color:#92400e;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
            <select id="student-leave-type" style="border-color:#fcd34d;"><option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡∏°‡∏µ‡∏ò‡∏∏‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</option><option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢/‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå)</option></select>
            <label style="font-size:12px; font-weight:bold; color:#92400e;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ó‡∏£‡∏≤‡∏ö)</label>
            <textarea id="student-leave-reason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°‡∏µ‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á..." rows="2" style="border-color:#fcd34d;"></textarea>
            <button onclick="submitLeaveRequest(this)" style="width:100%; background:#f59e0b; font-size:14px;">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</button>
        </div>

        <div id="tab-std-behavior" class="student-tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#059669; display:flex; align-items:center; gap:8px;">üíØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</h3>
                <span style="font-size: 11px; color: #10b981; background: #d1fae5; padding: 4px 10px; border-radius: 12px; font-weight:bold; display:flex; align-items:center; gap:4px; box-shadow: 0 2px 4px rgba(16,185,129,0.2);"><span class="live-dot"></span> ‡∏™‡∏î</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div id="behavior-score-box" style="flex:1; text-align:center; padding: 20px 10px; background: #ecfdf5; border-radius: 12px; border: 2px solid #34d399; transition: 0.3s;">
                    <h1 id="behavior-score-text" style="font-size: 40px; color: #059669; margin: 0; line-height: 1; transition: 0.3s;">100</h1>
                    <p style="margin: 5px 0 0 0; color: #047857; font-weight: bold; font-size:13px;">‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</p>
                </div>
                <div style="flex:1; text-align:center; padding: 20px 10px; background: #fffbeb; border-radius: 12px; border: 2px solid #fcd34d;">
                    <h1 id="merit-score-text" style="font-size: 40px; color: #d97706; margin: 0; line-height: 1;">0</h1>
                    <p style="margin: 5px 0 0 0; color: #b45309; font-weight: bold; font-size:13px;">üåü ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏™‡∏∞‡∏™‡∏°</p>
                </div>
            </div>
            <h3 style="margin-top:20px; font-size:14px; color:#475569; border-bottom:1px solid #eee; padding-bottom:8px;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
            <div style="overflow-x: auto;">
                <table style="width:100%; border-collapse: collapse; font-size:12px;">
                    <thead><tr><th style="background:#f1f5f9;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th style="background:#f1f5f9;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="background:#f1f5f9; color:#1e56a0;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead>
                    <tbody id="student-behavior-history-body"><tr><td colspan='3' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-credit">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ (SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ V.01)<br>
        ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ <b>‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå</b><br>
        ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ
    </div>
</div>

<div id="ai-mascot-container" style="position: fixed; bottom: 85px; right: 15px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end;">
    <div id="ai-help-popup" style="display: none; background: #fff; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 260px; margin-bottom: 15px; border: 2px solid #f59e0b; overflow: hidden; transform-origin: bottom right; animation: popupScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; align-items:center; gap:8px;"><span style="font-size:20px;">üè∫</span> ‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á AI</div>
            <span style="cursor: pointer; font-size:18px; padding:0 5px;" onclick="toggleAiPopup()">‚úñ</span>
        </div>
        <div style="padding: 15px; font-size: 13px; color: #334155; max-height: 300px; overflow-y: auto; background: #fffbeb;">
            <p style="margin-top:0; font-weight:bold; color:#92400e;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?</p>
            <button class="ai-help-btn" onclick="showAiHelp('attendance')">üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
            <button class="ai-help-btn" onclick="showAiHelp('leave')">üì® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</button>
            <button class="ai-help-btn" onclick="showAiHelp('behavior')">üíØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</button>
            <button class="ai-help-btn" onclick="showAiHelp('admin')">‚öôÔ∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>
    <div onclick="toggleAiPopup()" style="width: 65px; height: 65px; background: #fff; border-radius: 50%; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); cursor: pointer; display: flex; justify-content: center; align-items: center; border: 3px solid #f59e0b; animation: floatMascot 3s ease-in-out infinite; overflow: hidden;">
        <span style="font-size: 38px;">üè∫</span>
    </div>
</div>

<div class="nav-menu" id="bottom-nav-teacher">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
    <div class="nav-item" onclick="switchPage('behavior-page', this)"><span>üíØ</span>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
    <div class="nav-item" onclick="switchPage('notifications-page', this)"><span>üîî</span>‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤</div>
</div>

<div class="nav-menu" id="bottom-nav-student">
    <div class="nav-item active" onclick="switchTabMobile('student-pages', 'tab-std-card', this)"><span>ü™™</span>‡∏ö‡∏±‡∏ï‡∏£</div>
    <div class="nav-item" onclick="switchTabMobile('student-pages', 'tab-std-attendance', this)"><span>üìÖ</span>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
    <div class="nav-item" onclick="switchTabMobile('student-pages', 'tab-std-leave', this)"><span>üìù</span>‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤</div>
    <div class="nav-item" onclick="switchTabMobile('student-pages', 'tab-std-behavior', this)"><span>üíØ</span>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
</div>

<div class="nav-menu" id="bottom-nav-admin">
    <div class="nav-item active" onclick="switchTabMobile('admin-pages', 'tab-settings', this)"><span>‚öôÔ∏è</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
    <div class="nav-item" onclick="switchTabMobile('admin-pages', 'tab-users', this)"><span>üë•</span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
    <div class="nav-item" onclick="switchTabMobile('admin-pages', 'tab-students', this)"><span>üéì</span>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
</div>

<div class="nav-menu" id="bottom-nav-exec">
    <div class="nav-item active" onclick="switchTabMobile('exec-pages', 'exec-tab-attendance', this)"><span>üìä</span>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
    <div class="nav-item" onclick="switchTabMobile('exec-pages', 'exec-tab-behavior', this)"><span>üèÜ</span>‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</div>
</div>

<script>
    function toggleAiPopup() { let popup = document.getElementById('ai-help-popup'); if(popup) { if (popup.style.display === 'none' || popup.style.display === '') popup.style.display = 'block'; else popup.style.display = 'none'; } }
    function showAiHelp(topic) {
        toggleAiPopup(); 
        let title = ""; let text = ""; let icon = 'info';
        if (topic === 'attendance') { title = "üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"; text = "<div style='text-align:left; font-size:14px; line-height:1.6;'><b>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô:</b><br>1. ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠'<br>2. ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>3. ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏°‡∏≤, ‡∏™‡∏≤‡∏¢, ‡∏Ç‡∏≤‡∏î, ‡∏•‡∏≤)<br>4. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <b>'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'</b> ‡∏à‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö!</div>"; } 
        else if (topic === 'leave') { title = "üì® ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î"; text = "<div style='text-align:left; font-size:14px; line-height:1.6;'><b>‡∏ù‡∏±‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</b> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π '‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤' > ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô > ‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á<br><br><b>‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏π:</b> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤ ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö '‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤' ‡∏Ñ‡∏£‡∏±‡∏ö</div>"; } 
        else if (topic === 'behavior') { title = "üíØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°"; text = "<div style='text-align:left; font-size:14px; line-height:1.6;'>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° 100 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡πÅ‡∏¢‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏±‡∏ö<br>üî¥ <b>'‡∏Ç‡∏≤‡∏î':</b> ‡∏´‡∏±‡∏Å 5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>üü° <b>'‡∏™‡∏≤‡∏¢':</b> ‡∏´‡∏±‡∏Å 2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô<br>üåü ‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î <b>'‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'</b> ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</div>"; } 
        else if (topic === 'admin') { title = "‚öôÔ∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"; text = "<div style='text-align:left; font-size:14px; line-height:1.6;'><b>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≥‡πÑ‡∏î‡πâ:</b><br>1. ‡∏õ‡∏¥‡∏î-‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠<br>2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå<br>3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô<br>4. ‡∏î‡∏π Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</div>"; }
        Swal.fire({ title: title, html: text, icon: icon, confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#f59e0b' });
    }

    function formatThaiDate(dateStr, useFullMonth = false) {
        if (!dateStr || dateStr === "-") return "-";
        dateStr = String(dateStr).replace(/'/g, '').trim(); 
        let d, m, y;
        if (dateStr.includes('/')) { let parts = dateStr.split('/'); d = parseInt(parts[0], 10); m = parseInt(parts[1], 10); y = parseInt(parts[2], 10); } 
        else if (dateStr.includes('-')) { let parts = dateStr.split('-'); y = parseInt(parts[0], 10); m = parseInt(parts[1], 10); d = parseInt(parts[2], 10); } 
        else { return dateStr; }
        const tShort = ["", "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
        const tFull = ["", "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        if (y < 2500 && y > 1900) y += 543;
        return `${d} ${useFullMonth ? tFull[m] : tShort[m]} ${y}`;
    }

    window.onload = function() { updateClock(); checkSession(); };
    function resetIdleTimer() { if (!localStorage.getItem('sis_user')) return; localStorage.setItem('sis_last_activity', Date.now()); clearTimeout(idleTimer); idleTimer = setTimeout(autoLogout, IDLE_TIMEOUT); }
    function autoLogout() { if(studentDataTimer) clearInterval(studentDataTimer); Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏ö SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', text: '‚è±Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ', icon: 'warning', confirmButtonColor: '#1e56a0', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' }).then(() => { localStorage.removeItem('sis_user'); localStorage.removeItem('sis_last_activity'); localStorage.removeItem('sis_current_page'); location.reload(); }); }
    function setupActivityListeners() { ['mousemove', 'keydown', 'scroll', 'touchstart', 'click'].forEach(evt => document.addEventListener(evt, resetIdleTimer)); }
    
    function checkSession() { 
        let userData = localStorage.getItem('sis_user'); let lastActivity = localStorage.getItem('sis_last_activity'); 
        if (userData && lastActivity) { 
            if (Date.now() - parseInt(lastActivity) > IDLE_TIMEOUT) { 
                localStorage.removeItem('sis_user'); localStorage.removeItem('sis_last_activity'); localStorage.removeItem('sis_current_page'); 
            } else { 
                let data = JSON.parse(userData); routeUser(data); setupActivityListeners(); resetIdleTimer(); 
            } 
        } 
    }
    
    function updateClock() { 
        const now = new Date(); const dateStr = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); 
        if(document.getElementById('login-clock')) { document.getElementById('login-clock').innerHTML = `${dateStr}<br><span style="font-size: 1.3em; color: #1e56a0; letter-spacing: 1px;">${timeStr} ‡∏ô.</span>`; } 
        if(document.getElementById('display-date')) document.getElementById('display-date').innerText = dateStr; 
        if(document.getElementById('display-clock')) document.getElementById('display-clock').innerText = `üïí ${timeStr} ‡∏ô.`; 
    }
    setInterval(updateClock, 1000);

    function cleanName(fullName) { return fullName ? fullName.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.)\s*/g, "").trim() : ""; }

    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "";
    let allAdminStudentsData = [], adminHolidays = [], adminTermStart = "", adminTermEnd = "";
    let timeLimitConfig = { enabled: false, start: "", end: "" }; 
    let execFullAttendance = [], execFullStudents = [], execFullBehavior = [], execChartInstance = null;
    let studentLeaveDates = []; let currentStudentCalendarDate = new Date(); let studentDataTimer = null;

    let toggleEl = document.getElementById('admin-time-limit-toggle');
    if(toggleEl) {
        toggleEl.addEventListener('change', function() { 
            let inputs = document.getElementById('time-limit-inputs'); let text = document.getElementById('time-limit-status-text'); 
            if(this.checked) { inputs.style.display = 'flex'; text.innerText = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠)'; text.style.color = '#10b981'; } 
            else { inputs.style.display = 'none'; text.innerText = '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤)'; text.style.color = '#64748b'; } 
        });
    }

    function switchTabMobile(parentId, tabId, element) {
        let parent = document.getElementById(parentId);
        if(parent) {
            parent.querySelectorAll('.admin-tab-content, .student-tab-content, .exec-tab-content').forEach(t => t.classList.remove('active'));
            let tab = document.getElementById(tabId);
            if(tab) tab.classList.add('active');
        }
        if(element) {
            let siblings = element.parentElement.children;
            for(let i=0; i<siblings.length; i++) siblings[i].classList.remove('active');
            element.classList.add('active');
        }
    }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { 
            let siblings = element.parentElement.children;
            for(let i=0; i<siblings.length; i++) siblings[i].classList.remove('active');
            element.classList.add('active'); 
        }
        let pEl = document.getElementById(pageId);
        if(pEl) pEl.classList.add('active');
        localStorage.setItem('sis_current_page', pageId);
        
        if (pageId === 'daily-page' && currentClass) loadWeeklyData(); 
        if (pageId === 'summary-page' && currentClass) loadSummaryData();
        if (pageId === 'behavior-page' && currentClass) loadClassBehaviorData(); 
        if (pageId === 'notifications-page' && currentClass) loadLeaveNotifications(); 
    }

    // üåü ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    function handleLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const btn = document.getElementById('login-btn');
        if (!u || !p) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return; }
        
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."; 
        btn.disabled = true;
        
        let url = GAS_API_URL.trim() + `?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`;
        
        fetch(url)
            .then(res => res.text()) 
            .then(text => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; 
                btn.disabled = false;
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch(e) {
                    console.error("Parse Error:", text);
                    Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    return;
                }
                
                if (data.status === "success") {
                    data.userId = u;
                    localStorage.setItem('sis_user', JSON.stringify(data));
                    localStorage.setItem('sis_last_activity', Date.now());
                    routeUser(data);
                    setupActivityListeners();
                    resetIdleTimer();
                } else {
                    Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            })
            .catch((err) => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; 
                btn.disabled = false;
                if(document.getElementById('login-page').classList.contains('active') === false) return; 
                console.error("Login Fetch Error:", err);
                Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', `‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï`, 'error');
            });
    }

    function routeUser(data) {
        try {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-menu').forEach(nav => nav.style.display = 'none');
            document.getElementById('login-page').classList.remove('active');

            let uDisplay = document.getElementById('user-display'); if(uDisplay) uDisplay.innerText = `üë§ ${data.name}`; 
            let logBtn = document.getElementById('logout-btn'); if(logBtn) logBtn.style.display = 'block'; 
            let statBar = document.getElementById('status-bar'); if(statBar) statBar.style.display = 'flex';
            
            let role = data.role ? data.role.toString().trim().toLowerCase() : "";

            if (role === "teacher") { 
                currentTeacher = data.name; currentClass = data.className || ""; 
                let cTitle = document.getElementById('class-title'); if(cTitle) cTitle.innerText = `(${currentClass})`; 
                let bTitle = document.getElementById('beh-class-title'); if(bTitle) bTitle.innerText = `(${currentClass})`; 
                let nTitle = document.getElementById('notif-class-title'); if(nTitle) nTitle.innerText = `(${currentClass})`; 
                
                document.getElementById('teacher-pages').style.display = 'block';
                document.getElementById('bottom-nav-teacher').style.display = 'flex';
                
                let savedPage = localStorage.getItem('sis_current_page'); 
                let navMenu = document.getElementById('bottom-nav-teacher');
                let navItems = navMenu ? navMenu.querySelectorAll('.nav-item') : [];
                
                if(savedPage === 'daily-page' && navItems.length > 1) switchPage('daily-page', navItems[1]); 
                else if(savedPage === 'summary-page' && navItems.length > 2) switchPage('summary-page', navItems[2]); 
                else if(savedPage === 'behavior-page' && navItems.length > 3) switchPage('behavior-page', navItems[3]); 
                else if(savedPage === 'notifications-page' && navItems.length > 4) switchPage('notifications-page', navItems[4]); 
                else if(navItems.length > 0) switchPage('checklist-page', navItems[0]);
                else switchPage('checklist-page', null);
                
                fetch(`${GAS_API_URL}?action=get_admin_data`).then(res => res.json()).then(adminData => {
                    if(adminData.status === "success") {
                        adminHolidays = (adminData.config.holidays || []).filter(h => h.trim() !== ""); adminTermStart = adminData.config.startDate; adminTermEnd = adminData.config.endDate; timeLimitConfig = { enabled: adminData.config.timeLimitEnabled, start: adminData.config.startTime, end: adminData.config.endTime };
                        let modalText = document.getElementById('modal-time-limit-text');
                        if (modalText) { if (timeLimitConfig.enabled) modalText.innerHTML = `<b>2. ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</b> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ <b style="color:#ef4444; font-size:15px;">${timeLimitConfig.start} - ${timeLimitConfig.end} ‡∏ô.</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`; else modalText.innerHTML = `<b>2. ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</b> ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö <b style="color:#10b981;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</b>`; }
                        let tModal = document.getElementById('teacher-instruction-modal');
                        if (tModal && !sessionStorage.getItem('teacher_modal_seen')) tModal.style.display = 'flex';
                    }
                    if(!savedPage || savedPage === 'checklist-page') fetchStudents(); 
                }).catch(e => console.log("Admin config fetch error", e));
                
            } else if(role === "admin") { 
                document.getElementById('admin-pages').style.display = 'block';
                document.getElementById('bottom-nav-admin').style.display = 'flex';
                switchTabMobile('admin-pages', 'tab-settings', document.getElementById('bottom-nav-admin').children[0]);
                loadAdminData();

            } else if(role === "executive" || role === "boss") { 
                document.getElementById('exec-pages').style.display = 'block';
                document.getElementById('bottom-nav-exec').style.display = 'flex';
                switchTabMobile('exec-pages', 'exec-tab-attendance', document.getElementById('bottom-nav-exec').children[0]);
                fetchFullExecData();

            } else if(role === "student") { 
                document.getElementById('student-pages').style.display = 'block';
                document.getElementById('bottom-nav-student').style.display = 'flex';
                switchTabMobile('student-pages', 'tab-std-card', document.getElementById('bottom-nav-student').children[0]);

                loadStudentReport(data.userId, false); 
                renderStudentCalendar(); 
                if(studentDataTimer) clearInterval(studentDataTimer); 
                studentDataTimer = setInterval(() => { loadStudentReport(data.userId, true); }, 10000); 

            } else { 
                Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error'); 
            }
        } catch (err) { 
            Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠: ' + err.message, 'error'); 
        }
    }

    function loadLeaveNotifications() {
        let container = document.getElementById('leave-notifications-container');
        if(!container) return;
        container.innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤...</div>`;

        fetch(`${GAS_API_URL}?action=get_class_leaves&className=${encodeURIComponent(currentClass)}`)
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                if(data.data.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:20px; color:#64748b;">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
                    return;
                }
                data.data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                let html = "";
                data.data.forEach(leave => {
                    let badgeColor = leave.leaveType.includes("‡∏õ‡πà‡∏ß‡∏¢") ? "#f43f5e" : "#f59e0b";
                    let badgeBg = leave.leaveType.includes("‡∏õ‡πà‡∏ß‡∏¢") ? "#fff1f2" : "#fffbeb";
                    html += `
                    <div style="background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                            <div>
                                <b style="color:#1e293b; font-size:14px;">${cleanName(leave.studentName)}</b>
                                <div style="font-size:11px; color:#64748b;">‡∏£‡∏´‡∏±‡∏™: ${leave.studentId}</div>
                            </div>
                            <span style="background:${badgeBg}; color:${badgeColor}; font-size:11px; font-weight:bold; padding:3px 8px; border-radius:12px; border:1px solid ${badgeColor}40;">${leave.leaveType}</span>
                        </div>
                        <div style="background:#f8fafc; padding:8px; border-radius:6px; font-size:13px; color:#475569; margin-bottom:8px;">
                            üìÖ <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤:</b> <span style="color:#1e56a0;">${formatThaiDate(leave.leaveDate, true)}</span><br>
                            üìù <b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</b> ${leave.reason}
                        </div>
                        <div style="font-size:10px; color:#94a3b8; text-align:right;">
                            ‚è± ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatThaiDate(leave.timestamp.split(' ')[0])} ${leave.timestamp.split(' ')[1] || ''}
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else { container.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`; }
        }).catch(err => { container.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>`; });
    }

    function loadClassBehaviorData() {
        let tbody = document.getElementById('behavior-body');
        if(!tbody) return;
        tbody.innerHTML = `<tr><td colspan='6' style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°...</td></tr>`;

        fetch(`${GAS_API_URL}?action=get_class_behavior&className=${encodeURIComponent(currentClass)}`)
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                let html = "";
                data.data.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                data.data.forEach(std => {
                    let netColor = std.behaviorScore >= 80 ? '#10b981' : (std.behaviorScore >= 60 ? '#f59e0b' : '#ef4444');
                    let totalDeduction = std.behaviorScore - 100; 
                    html += `<tr>
                        <td style="text-align:center;">${std.number}</td>
                        <td>${cleanName(std.name)}</td>
                        <td style="text-align:center; color:#ef4444; font-weight:bold;">${totalDeduction < 0 ? totalDeduction : '-'}</td>
                        <td style="text-align:center; color:#10b981; font-weight:bold;">${std.meritScore > 0 ? '+' + std.meritScore : '-'}</td>
                        <td style="text-align:center; color:${netColor}; font-weight:bold; font-size:14px;">${std.behaviorScore}</td>
                        <td style="text-align:center;">
                            <button onclick="openBehaviorModal('${std.id}', '${cleanName(std.name)}')" style="background:#f59e0b; padding:4px 8px; font-size:11px; border-radius:6px; box-shadow: 0 2px 4px rgba(245,158,11,0.2);">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
                        </td>
                    </tr>`;
                });
                if (data.data.length === 0) html = `<tr><td colspan='6' style='text-align:center; color:#ef4444;'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`;
                tbody.innerHTML = html;
            }
        });
    }

    async function openBehaviorModal(stdId, stdName) {
        const { value: formValues } = await Swal.fire({
            title: `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${stdName}`,
            html: `
                <div style="text-align:left; font-family:'Prompt';">
                    <label style="font-size:12px; font-weight:bold; color:#1e56a0;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
                    <select id="b-type" class="swal2-select" style="display:flex; width:100%; margin:0 0 15px 0; font-family:'Prompt'; font-size:14px;">
                        <option value="merit">üåü ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ (+)</option>
                        <option value="deduct">üî¥ ‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° (-)</option>
                        <option value="restore">üü¢ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° (+)</option>
                    </select>
                    <label style="font-size:12px; font-weight:bold; color:#1e56a0;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <input id="b-reason" class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ, ‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏ß‡∏¥‡∏ß‡∏≤‡∏ó..." style="display:flex; width:100%; margin:0 0 15px 0; font-family:'Prompt'; font-size:14px; box-sizing:border-box;">
                    <label style="font-size:12px; font-weight:bold; color:#1e56a0;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å)</label>
                    <input id="b-points" type="number" min="1" class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5, 10, 20" style="display:flex; width:100%; margin:0; font-family:'Prompt'; font-size:14px; box-sizing:border-box;">
                </div>
            `,
            focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', confirmButtonColor: '#10b981',
            preConfirm: () => {
                const type = document.getElementById('b-type').value; const reason = document.getElementById('b-reason').value; let points = parseInt(document.getElementById('b-points').value);
                if (!reason || isNaN(points) || points <= 0) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)'); return false; }
                if (type === 'deduct') points = -points;
                return { stdId: stdId, stdName: stdName, type: type, reason: reason, points: points };
            }
        });

        if (formValues) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            fetch(GAS_API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "submit_manual_behavior", studentId: formValues.stdId, studentName: formValues.stdName, className: currentClass, bType: formValues.type, reason: formValues.reason, points: formValues.points, teacherName: currentTeacher })
            }).then(res => res.json()).then(data => {
                if (data.status === "success") { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success'); loadClassBehaviorData(); } 
                else { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error'); }
            }).catch(err => { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error'); });
        }
    }

    function fetchStudents() {
        let dateInput = document.getElementById('check-date');
        if(!dateInput.value) { let d = new Date(); let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; dateInput.value = [year, month, day].join('-'); }
        let selectedDateStr = dateInput.value;
        let dObj = new Date(selectedDateStr); let isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6); let isHoliday = adminHolidays.includes(selectedDateStr); let isOutsideTerm = false;
        if (adminTermStart && adminTermEnd) { let sD = new Date(adminTermStart); sD.setHours(0,0,0,0); let eD = new Date(adminTermEnd); eD.setHours(23,59,59,999); if(dObj < sD || dObj > eD) isOutsideTerm = true; }
        
        let ctn = document.getElementById('student-list-container');
        let sBtn = document.getElementById('save-btn');
        if(!ctn || !sBtn) return;

        if (isOutsideTerm) { ctn.innerHTML = `<div style="background:#f1f5f9; padding:20px; text-align:center; border-radius:10px;"><h3>üìÖ ‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</h3></div>`; sBtn.style.display = 'none'; return; }
        if (isWeekend || isHoliday) { ctn.innerHTML = `<div style="background:#fee2e2; padding:20px; text-align:center; color:#b91c1c; border-radius:10px;"><h3>‚õî ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</h3></div>`; sBtn.style.display = 'none'; return; }
        if (timeLimitConfig && timeLimitConfig.enabled && timeLimitConfig.start && timeLimitConfig.end) { let nowStr = new Date().toLocaleTimeString('th-TH', { hour12: false, hour: '2-digit', minute: '2-digit' }); if (selectedDateStr === new Date().toISOString().split('T')[0]) { if (nowStr < timeLimitConfig.start || nowStr > timeLimitConfig.end) { ctn.innerHTML = `<div style="background:#fff7ed; padding:20px; text-align:center; color:#c2410c; border-radius:10px;"><h3>‚è∞ ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3><p>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ${timeLimitConfig.start} - ${timeLimitConfig.end} ‡∏ô.</p></div>`; sBtn.style.display = 'none'; return; } } }

        ctn.innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>`; sBtn.style.display = 'none'; 
        
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`).then(res => res.text()).then(text => { try { return JSON.parse(text); } catch(e) { throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Deploy ‡πÄ‡∏õ‡πá‡∏ô New Version ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á"); } }).then(data => {
            if(data.status === "success") {
                students = data.data;
                if(students.length === 0) { ctn.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${currentClass}</div>`; return; }
                Promise.all([
                    fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${selectedDateStr}`).then(r => r.json()).catch(e => ({status: "not_found"})),
                    fetch(`${GAS_API_URL}?action=get_leaves_for_date&className=${encodeURIComponent(currentClass)}&date=${selectedDateStr}`).then(r => r.json()).catch(e => ({status: "error", data: {}}))
                ]).then(([check, leaves]) => {
                    let existingData = check.status === "found" ? check.data : null; let leaveData = leaves.status === "success" ? leaves.data : {}; renderChecklist(existingData, check.recordedBy, leaveData); loadQuickAIInsight(); 
                    if (!existingData && Object.keys(leaveData).length > 0) { let leaveListHTML = ""; let count = 0; students.forEach(std => { if(leaveData[std.id]) { count++; leaveListHTML += `<div style="padding: 5px 0; border-bottom: 1px dashed #eee;"><b>${count}. ${cleanName(std.name)}</b> <span style="color:#ef4444; font-size:12px;">(${leaveData[std.id].type})</span></div>`; } }); if (count > 0) { Swal.fire({ title: 'üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î', html: `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${count}</b> ‡∏Ñ‡∏ô<br><br><div style="text-align:left; background:#f8fafc; padding:10px; border-radius:8px; max-height:150px; overflow-y:auto; font-size:14px;">${leaveListHTML}</div><br><span style="color:#10b981; font-size:13px; font-weight:bold;">‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>`, icon: 'info', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö', confirmButtonColor: '#1e56a0' }); } }
                }).catch(err => { console.log("Secondary fetch error:", err); renderChecklist(null, "", {}); loadQuickAIInsight(); });
            } else { ctn.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.message}</div>`; }
        }).catch(err => { ctn.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444; font-weight:bold;">‚ùå ${err.message}</div>`; });
    }

    function renderChecklist(existing, recorder, leaveData) {
        const container = document.getElementById('student-list-container'); if(!container) return; container.innerHTML = "";
        let sBtn = document.getElementById('save-btn');
        if(existing) { container.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; font-size:13px; text-align:center;">‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recorder} <br><span style="font-weight:normal; font-size:12px; color:#666;">(‡∏Å‡∏î "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)</span></div>`; if(sBtn) sBtn.style.display = 'none'; } else { if(sBtn) sBtn.style.display = 'block'; }
        students.forEach(std => {
            let st = '‡∏°‡∏≤'; let nt = ''; let hasLeave = false;
            if (existing && existing[std.id]) { st = existing[std.id].status; nt = existing[std.id].note; } else if (leaveData && leaveData[std.id]) { st = leaveData[std.id].type; nt = "[‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤] " + leaveData[std.id].reason; hasLeave = true; }
            attendanceData[std.id] = { status: st, note: nt }; const displayName = cleanName(std.name); const imgUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1e56a0&color=fff&size=128&rounded=true`;
            let row = document.createElement('div'); row.className = `student-row row-${st}`; row.id = `row-${std.id}`; row.style.flexWrap = "wrap"; 
            let leaveBadge = hasLeave ? `<br><span style="background:#fef3c7; border:1px solid #f59e0b; color:#ea580c; font-size:10px; padding:2px 6px; border-radius:10px;">‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</span>` : ''; let btnNoteColor = nt ? "background:#f59e0b; color:white; border:none;" : "background:none; border:1px solid #ccc; color:#666;";
            if (existing) { let c = st==='‡∏°‡∏≤'?'#10b981':st==='‡∏Ç‡∏≤‡∏î'?'#ef4444':st==='‡∏™‡∏≤‡∏¢'?'#eab308':st==='‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'?'#3b82f6':'#f97316'; row.innerHTML = `<div class="student-number">${std.number}</div><img src="${imgUrl}" class="student-img"><div class="student-name">${displayName}${leaveBadge}</div><div id="view-${std.id}" style="display:flex; align-items:center; gap:10px; margin-left:auto;"><div style="text-align:right; font-size:13px; font-weight:bold; color:${c};">${st}</div><button onclick="enableEdit('${std.id}')" style="background:#f1f5f9; border:1px solid #cbd5e1; color:#475569; padding:5px 10px; border-radius:6px; font-size:12px; cursor:pointer;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div><div id="edit-${std.id}" style="display:none; width:100%; margin-top:10px; padding-top:10px; border-top:1px dashed #e2e8f0; flex-direction:column; gap:8px;"><div style="display:flex; gap:8px; width:100%;"><select id="sel-${std.id}" class="status-dropdown" style="flex:1;"><option value="‡∏°‡∏≤" ${st==='‡∏°‡∏≤'?'selected':''}>‚úÖ ‡∏°‡∏≤</option><option value="‡∏™‡∏≤‡∏¢" ${st==='‡∏™‡∏≤‡∏¢'?'selected':''}>‚è∞ ‡∏™‡∏≤‡∏¢</option><option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à" ${st==='‡∏•‡∏≤‡∏Å‡∏¥‡∏à'?'selected':''}>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option><option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" ${st==='‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'?'selected':''}>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option><option value="‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ${st==='‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'?'selected':''}>üåç ‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option><option value="‡∏Ç‡∏≤‡∏î" ${st==='‡∏Ç‡∏≤‡∏î'?'selected':''}>‚ùå ‡∏Ç‡∏≤‡∏î</option></select><input type="text" id="nt-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." value="${nt}" style="flex:2; font-size:13px; padding:6px; border:1px solid #ccc; border-radius:6px;"></div><div style="display:flex; gap:8px; width:100%;"><button id="btn-save-${std.id}" onclick="saveSingleUpdate('${std.id}')" style="flex:1; background:#10b981; padding:8px; font-size:13px; color:white; border:none; border-radius:6px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="cancelEdit('${std.id}')" style="flex:1; background:#ef4444; padding:8px; font-size:13px; color:white; border:none; border-radius:6px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div>`; } 
            else { row.innerHTML = `<div class="student-number">${std.number}</div><img src="${imgUrl}" class="student-img"><div class="student-name">${displayName}${leaveBadge}</div><select class="status-dropdown" onchange="setStatus('${std.id}', this.value)" style="margin-left:auto;"><option value="‡∏°‡∏≤" ${st==='‡∏°‡∏≤'?'selected':''}>‚úÖ ‡∏°‡∏≤</option><option value="‡∏™‡∏≤‡∏¢" ${st==='‡∏™‡∏≤‡∏¢'?'selected':''}>‚è∞ ‡∏™‡∏≤‡∏¢</option><option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à" ${st==='‡∏•‡∏≤‡∏Å‡∏¥‡∏à'?'selected':''}>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option><option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" ${st==='‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'?'selected':''}>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option><option value="‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ${st==='‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'?'selected':''}>üåç ‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option><option value="‡∏Ç‡∏≤‡∏î" ${st==='‡∏Ç‡∏≤‡∏î'?'selected':''}>‚ùå ‡∏Ç‡∏≤‡∏î</option></select><button class="btn-note" style="${btnNoteColor}" onclick="toggleNote('${std.id}')">üìù</button><div id="note-box-${std.id}" style="display:none; position:absolute; right:10px; top:50px; z-index:100; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.15); width:220px; border:1px solid #eee;"><textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">${nt}</textarea><button onclick="toggleNote('${std.id}')" style="width:100%; margin-top:8px; background:var(--primary); font-size:12px; padding:6px; color:white; border:none; border-radius:6px;">‡∏ï‡∏Å‡∏•‡∏á</button></div>`; }
            container.appendChild(row);
        });
    }

    function enableEdit(id) { let v=document.getElementById(`view-${id}`); let e=document.getElementById(`edit-${id}`); if(v && e) { v.style.display='none'; e.style.display='flex'; } }
    function cancelEdit(id) { let v=document.getElementById(`view-${id}`); let e=document.getElementById(`edit-${id}`); if(v && e) { v.style.display='flex'; e.style.display='none'; } }
    function saveSingleUpdate(id) { let btn = document.getElementById(`btn-save-${id}`); btn.innerText = "‚è≥..."; btn.disabled = true; fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "update_single", date: document.getElementById('check-date').value, id: id, className: currentClass, status: document.getElementById(`sel-${id}`).value, note: document.getElementById(`nt-${id}`).value, teacherName: currentTeacher }) }).then(res => res.json()).then(data => { if(data.status === "success") { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); fetchStudents(); } else { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ' + data.message, 'error'); btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"; btn.disabled = false; } }); }
    function setStatus(id, s) { attendanceData[id].status = s; let r=document.getElementById(`row-${id}`); if(r) r.className = `student-row row-${s}`; }
    function toggleNote(id) { let b = document.getElementById(`note-box-${id}`); if(b) b.style.display = b.style.display === 'none' ? 'block' : 'none'; }

    function saveAttendance() {
        const btn = document.getElementById('save-btn'); btn.innerText = "‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; btn.disabled = true;
        let records = []; students.forEach(s => records.push({ id: s.id, name: s.name, className: currentClass, status: attendanceData[s.id].status, note: document.getElementById(`note-${s.id}`).value }));
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "save_bulk", date: document.getElementById('check-date').value, teacherName: currentTeacher, records: records }) }).then(res => res.json()).then(data => { btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false; if(data.status === "success") { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n(‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡∏≤‡∏î/‡∏™‡∏≤‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)', 'success'); fetchStudents(); } else Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', "‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message, 'error'); });
    }

    function loadQuickAIInsight() {
        let aiText = document.getElementById('teacher-quick-ai');
        if(!aiText) return;
        aiText.innerHTML = "‚è≥ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                if(data.data.length === 0) { aiText.innerHTML = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‚úåÔ∏è"; return; }
                let sumTotal = 0, sumPres = 0, riskList = [];
                data.data.forEach(d => { let stTotal = d.present + d.personal_leave + d.sick_leave + d.absent + d.late + d.outside; if(stTotal > 0) { sumTotal += stTotal; sumPres += d.present; if((d.present / stTotal) * 100 < 80) riskList.push(cleanName(d.name)); } });
                let avgPerc = sumTotal > 0 ? ((sumPres / sumTotal) * 100).toFixed(1) : 0; let aiMsg = `üìä <b>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°:</b> <b style="color:${avgPerc>=80?'green':'red'};">${avgPerc}%</b><br>`; aiMsg += riskList.length > 0 ? `‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${riskList.length} ‡∏Ñ‡∏ô: <span style="color:red;">${riskList.slice(0,3).join(', ')}${riskList.length>3?'...':''}</span>` : `üåü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80% ‡∏Ñ‡∏£‡∏±‡∏ö`; aiText.innerHTML = aiMsg;
            }
        });
    }

    function renderStudentCalendar() { let container = document.getElementById('student-leave-calendar-container'); if(!container) return; let d = new Date(currentStudentCalendarDate.getFullYear(), currentStudentCalendarDate.getMonth(), 1); document.getElementById('student-calendar-month-label').innerText = formatThaiDate(d.toLocaleDateString('en-US'), true).replace(/^[0-9]+\s/, ''); let html = `<div class="calendar-grid">`; const thDays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"]; thDays.forEach(day => html += `<div class="calendar-header">${day}</div>`); let firstDay = d.getDay(); let daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate(); for(let i=0; i<firstDay; i++) html += `<div class="calendar-day blank"></div>`; for(let i=1; i<=daysInMonth; i++) { let dateObj = new Date(d.getFullYear(), d.getMonth(), i); let dStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`; let isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6); let isSelected = studentLeaveDates.includes(dStr); let cssClass = isSelected ? "selected-leave" : ""; let bgStyle = isWeekend && !isSelected ? 'style="background:#fee2e2; color:#b91c1c;"' : ''; html += `<div class="calendar-day ${cssClass}" ${bgStyle} onclick="toggleStudentLeave('${dStr}', ${isWeekend})">${i}</div>`; } html += `</div>`; container.innerHTML = html; updateSelectedLeaveDisplay(); }
    function changeStudentMonth(dir) { currentStudentCalendarDate.setMonth(currentStudentCalendarDate.getMonth() + dir); renderStudentCalendar(); }
    function toggleStudentLeave(dateStr, isWeekend) { if(isWeekend) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö', 'info'); return; } let idx = studentLeaveDates.indexOf(dateStr); if(idx > -1) studentLeaveDates.splice(idx, 1); else studentLeaveDates.push(dateStr); studentLeaveDates.sort(); renderStudentCalendar(); }
    function updateSelectedLeaveDisplay() { let display = document.getElementById('selected-leave-dates-display'); if(!display) return; if(studentLeaveDates.length === 0) { display.style.display = 'none'; } else { display.style.display = 'block'; let formattedDates = studentLeaveDates.map(d => formatThaiDate(d, false)).join(', '); display.innerText = `üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏≤ (${studentLeaveDates.length} ‡∏ß‡∏±‡∏ô): ${formattedDates}`; } }

    function submitLeaveRequest(btn) {
        if(studentLeaveDates.length === 0) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }
        let sType = document.getElementById('student-leave-type').value; let sReason = document.getElementById('student-leave-reason').value;
        if(!sReason) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ó‡∏£‡∏≤‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }
        let uData = JSON.parse(localStorage.getItem('sis_user')); let originalText = btn.innerText; btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; btn.disabled = true;
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "submit_leave", dates: studentLeaveDates, studentId: uData.userId, studentName: uData.name, className: uData.className, leaveType: sType, reason: sReason }) }).then(res => res.json()).then(data => { btn.innerText = originalText; btn.disabled = false; if(data.status === 'success') { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'success'); document.getElementById('student-leave-reason').value = ""; studentLeaveDates = []; renderStudentCalendar(); } }).catch(err => { btn.innerText = originalText; btn.disabled = false; Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error'); });
    }

    function loadWeeklyData() {
        let tbody = document.getElementById('daily-body'); if(!tbody) return; tbody.innerHTML = `<tr><td colspan='7' style='text-align:center; padding:20px;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≠‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå...</td></tr>`; let aiText = document.getElementById('teacher-daily-ai'); if(aiText) aiText.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ...";
        let curr = new Date(); let day = curr.getDay(); let diffToMon = curr.getDate() - day + (day === 0 ? -6 : 1); let monDate = new Date(curr.setDate(diffToMon)); monDate.setHours(0,0,0,0);
        let weekDates = []; let thElements = ['th-mon', 'th-tue', 'th-wed', 'th-thu', 'th-fri']; let dayNames = ['‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.'];
        for(let i=0; i<5; i++) { let d = new Date(monDate); d.setDate(monDate.getDate() + i); let yyyy = d.getFullYear(); let mm = String(d.getMonth() + 1).padStart(2, '0'); let dd = String(d.getDate()).padStart(2, '0'); weekDates.push(`${yyyy}-${mm}-${dd}`); let th = document.getElementById(thElements[i]); if(th) th.innerHTML = `${dayNames[i]}<br><span style="font-size:10px; font-weight:normal;">${dd}/${mm}</span>`; }
        let wRange = document.getElementById('weekly-date-range'); if(wRange) wRange.innerText = `${formatThaiDate(weekDates[0], true)} - ${formatThaiDate(weekDates[4], true)}`;
        let fetches = weekDates.map(dateStr => fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${dateStr}`).then(res => res.json()).catch(e => ({ status: 'error' })));
        Promise.all(fetches).then(results => {
            let weeklyData = {}; if(students && students.length > 0) students.forEach(std => { weeklyData[std.id] = { name: std.name, status: ['-', '-', '-', '-', '-'] }; }); let totalAbs = 0;
            results.forEach((res, dayIndex) => { if(res && res.status === 'success' && res.data) { res.data.forEach(d => { if(!weeklyData[d.id]) weeklyData[d.id] = { name: d.name, status: ['-', '-', '-', '-', '-'] }; let sText = d.status; let shortStat = '-'; if(sText === '‡∏°‡∏≤') shortStat = '<b style="color:#10b981;">‡∏°</b>'; else if(sText === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') shortStat = '<b style="color:#f97316;">‡∏•</b>'; else if(sText === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') shortStat = '<b style="color:#f43f5e;">‡∏õ</b>'; else if(sText === '‡∏Ç‡∏≤‡∏î') { shortStat = '<b style="color:#991b1b;">‡∏Ç</b>'; totalAbs++; } else if(sText === '‡∏™‡∏≤‡∏¢') shortStat = '<b style="color:#eab308;">‡∏™</b>'; else if(sText === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') shortStat = '<b style="color:#3b82f6;">‡∏ô</b>'; weeklyData[d.id].status[dayIndex] = shortStat; }); } });
            tbody.innerHTML = ""; let index = 1; for(let id in weeklyData) { let st = weeklyData[id]; tbody.innerHTML += `<tr><td style="text-align:center;">${index++}</td><td>${cleanName(st.name)}</td><td style="text-align:center; background:#f8fafc;">${st.status[0]}</td><td style="text-align:center;">${st.status[1]}</td><td style="text-align:center; background:#f8fafc;">${st.status[2]}</td><td style="text-align:center;">${st.status[3]}</td><td style="text-align:center; background:#f8fafc;">${st.status[4]}</td></tr>`; }
            if(Object.keys(weeklyData).length === 0) tbody.innerHTML = `<tr><td colspan='7' style='text-align:center; padding:20px;'>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>`; 
            if(aiText) { if (totalAbs > 0) aiText.innerHTML = `‚ö†Ô∏è <b>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:</b> ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏° <b>${totalAbs} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</b>`; else aiText.innerHTML = `üåü <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</b> ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å`; }
        });
    }

    function loadSummaryData() {
        let tbody = document.getElementById('summary-body'); if(!tbody) return; tbody.innerHTML = `<tr><td colspan='9' style='text-align:center;'>‚è≥ ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</td></tr>`;
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                let totalStudents = data.data.length, sumTotal = 0, sumPres = 0, riskCount = 0, html = "";
                if(totalStudents === 0) { tbody.innerHTML = `<tr><td colspan='9' style='text-align:center;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
                data.data.forEach((d, index) => {
                    let stTotal = d.present + d.personal_leave + d.sick_leave + d.absent + d.late + d.outside; let perc = stTotal > 0 ? (d.present / stTotal) * 100 : 0; if(stTotal > 0) { sumTotal += stTotal; sumPres += d.present; }
                    let percStr = perc.toFixed(1) + '%'; let rowClass = ''; let warnIcon = ''; if(stTotal > 0 && perc < 80) { riskCount++; rowClass = 'risk-row'; warnIcon = '‚ö†Ô∏è '; percStr = `<span style="color:#ef4444; font-weight:bold;">${percStr}</span>`; } else { percStr = `<span style="color:#10b981; font-weight:bold;">${percStr}</span>`; }
                    html += `<tr class="${rowClass}"><td style="text-align:center;">${index+1}</td><td>${warnIcon}${cleanName(d.name)}</td><td style="color:#10b981; text-align:center; font-weight:bold;">${d.present}</td><td style="color:#eab308; text-align:center;">${d.late}</td><td style="color:#f97316; text-align:center;">${d.personal_leave}</td><td style="color:#f43f5e; text-align:center;">${d.sick_leave}</td><td style="color:#991b1b; text-align:center; font-weight:bold;">${d.absent}</td><td style="color:#3b82f6; text-align:center;">${d.outside}</td><td style="text-align:center;">${percStr}</td></tr>`;
                });
                tbody.innerHTML = html; 
                let sGrid = document.getElementById('teacher-stat-grid'); if(sGrid) sGrid.style.display = 'flex'; 
                let tTot = document.getElementById('tc-total-std'); if(tTot) tTot.innerText = totalStudents; 
                let tRisk = document.getElementById('tc-risk-std'); if(tRisk) tRisk.innerText = riskCount; 
                let classAvg = sumTotal > 0 ? ((sumPres / sumTotal) * 100).toFixed(1) + "%" : "0%"; 
                let tAvg = document.getElementById('tc-avg-perc'); if(tAvg) tAvg.innerText = classAvg; 
                let aiText = document.getElementById('teacher-summary-ai');
                if(aiText) aiText.innerHTML = `‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠ <b>${classAvg}</b> ${riskCount>0?`<br>‚ö†Ô∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${riskCount} ‡∏Ñ‡∏ô (‡πÅ‡∏ñ‡∏ö‡πÅ‡∏î‡∏á)`:`üåü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80%`}`;
            }
        });
    }

    function loadAdminData() {
        fetch(`${GAS_API_URL}?action=get_admin_data`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                function toFormatDate(dStr) { if (!dStr) return ""; let d = new Date(dStr); if (isNaN(d)) return dStr; return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
                document.getElementById('admin-time-limit-toggle').checked = data.config.timeLimitEnabled; document.getElementById('admin-start-time').value = data.config.startTime || "07:30"; document.getElementById('admin-end-time').value = data.config.endTime || "08:30"; document.getElementById('admin-time-limit-toggle').dispatchEvent(new Event('change'));
                document.getElementById('admin-start').value = toFormatDate(data.config.startDate); document.getElementById('admin-end').value = toFormatDate(data.config.endDate); adminHolidays = (data.config.holidays || []).filter(h => h.trim() !== ""); renderAdminCalendar(); 
                let uBody = document.getElementById('admin-users-body'); uBody.innerHTML = "";
                data.users.forEach((u, i) => { uBody.innerHTML += `<tr><td><input type="text" value="${u[0]}"></td><td><input type="text" value="${u[1]}"></td><td><select><option value="teacher" ${u[2]=='teacher'?'selected':''}>‡∏Ñ‡∏£‡∏π (Teacher)</option><option value="admin" ${u[2]=='admin'?'selected':''}>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</option><option value="executive" ${u[2]=='executive'?'selected':''}>‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</option><option value="student" ${u[2]=='student'?'selected':''}>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student)</option></select></td><td><input type="text" value="${u[3]}"></td><td><input type="text" value="${u[4]||''}"></td><td><button style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; });
                allAdminStudentsData = data.students; updateClassDropdown(); renderAdminStudents();
            }
        });
    }

    function renderAdminCalendar() {
        let container = document.getElementById('admin-calendar-container'); let startVal = document.getElementById('admin-start').value; let endVal = document.getElementById('admin-end').value;
        if(!startVal || !endVal) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>"; document.getElementById('working-days-text').innerText = "0"; return; }
        let sArr = startVal.split('-'); let startDate = new Date(sArr[0], sArr[1]-1, sArr[2]); let eArr = endVal.split('-'); let endDate = new Date(eArr[0], eArr[1]-1, eArr[2]);
        if(startDate > endDate) { container.innerHTML = "<div style='color:red;'>‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</div>"; return; }
        let html = ""; let currMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1); let endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1); const thDays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"]; let totalWorkingDays = 0;
        while(currMonth <= endMonth) {
            let monthName = currMonth.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); html += `<div class="calendar-month"><h4>${monthName}</h4><div class="calendar-grid">`; thDays.forEach(d => html += `<div class="calendar-header">${d}</div>`);
            let firstDay = new Date(currMonth.getFullYear(), currMonth.getMonth(), 1).getDay(); let daysInMonth = new Date(currMonth.getFullYear(), currMonth.getMonth() + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) html += `<div class="calendar-day blank"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                let dateObj = new Date(currMonth.getFullYear(), currMonth.getMonth(), i); let dStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                if(dateObj < startDate || dateObj > endDate) { html += `<div class="calendar-day blank">${i}</div>`; } else {
                    let isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6); let isHoliday = adminHolidays.includes(dStr);
                    if(!isWeekend && !isHoliday) totalWorkingDays++; 
                    let cssClass = (isHoliday || isWeekend) ? 'holiday' : ''; let tooltip = isWeekend ? ' title="‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"' : '';
                    html += `<div class="calendar-day ${cssClass}" onclick="toggleHoliday('${dStr}', ${isWeekend})" ${tooltip}>${i}</div>`;
                }
            }
            html += `</div></div>`; currMonth.setMonth(currMonth.getMonth() + 1);
        }
        container.innerHTML = html; document.getElementById('working-days-text').innerText = totalWorkingDays;
    }
    
    function toggleHoliday(dateStr, isWeekend) { if(isWeekend) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö', 'info'); return; } let idx = adminHolidays.indexOf(dateStr); if(idx > -1) adminHolidays.splice(idx, 1); else adminHolidays.push(dateStr); renderAdminCalendar(); }
    
    async function fetchPublicHolidays() {
        let startVal = document.getElementById('admin-start').value; if(!startVal) { Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }
        let year = startVal.split('-')[0]; let btn = document.getElementById('fetch-holidays-btn'); btn.innerText = '‚è≥ ‡πÇ‡∏´‡∏•‡∏î...'; btn.disabled = true;
        try { let res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/TH`); let holidays = await res.json(); let addedCount = 0; holidays.forEach(h => { if(!adminHolidays.includes(h.date)) { adminHolidays.push(h.date); addedCount++; } }); renderAdminCalendar(); btn.innerText = 'üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢'; btn.disabled = false; Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', `‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ${addedCount} ‡∏ß‡∏±‡∏ô`, 'success'); } catch(e) { btn.innerText = 'üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢'; btn.disabled = false; Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); }
    }
    
    function updateClassDropdown() { let f = document.getElementById('admin-class-filter'); let s = new Set(); allAdminStudentsData.forEach(x => s.add(x[3])); f.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...s].sort().forEach(c => f.innerHTML += `<option value="${c}">${c}</option>`); }
    function renderAdminStudents() { let b = document.getElementById('admin-students-body'); b.innerHTML = ""; let f = document.getElementById('admin-class-filter').value; allAdminStudentsData.forEach((s, i) => { if (f==='all'||s[3]===f) b.innerHTML += `<tr><td>${s[0]}</td><td>${s[1]}</td><td>${s[2]}</td><td>${s[3]}</td><td><button style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="removeStudent(${i})">‡∏•‡∏ö</button></td></tr>`; }); }
    function removeStudent(i) { Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏ö SIS', text: "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?", icon: 'warning', showCancelButton: true, confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢' }).then((result) => { if(result.isConfirmed) { allAdminStudentsData.splice(i,1); renderAdminStudents(); }}); }
    
    function addUserRow() { document.getElementById('admin-users-body').innerHTML += `<tr><td><input type="text"></td><td><input type="text"></td><td><select><option value="teacher">‡∏Ñ‡∏£‡∏π (Teacher)</option><option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</option><option value="executive">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</option><option value="student">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student)</option></select></td><td><input type="text"></td><td><input type="text"></td><td><button style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; }
    function addStudentRow() { allAdminStudentsData.push(['','','',document.getElementById('admin-class-filter').value==='all'?'':document.getElementById('admin-class-filter').value]); renderAdminStudents(); }
    
    function saveAdminData(btn) {
        let originalText = btn.innerText; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true; let u = []; document.querySelectorAll('#admin-users-body tr').forEach(tr => { let i = tr.querySelectorAll('input, select'); u.push([i[0].value, i[1].value, i[2].value, i[3].value, i[4].value]); });
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "admin_update", settings: { startDate: document.getElementById('admin-start').value, endDate: document.getElementById('admin-end').value, holidays: adminHolidays, timeLimitEnabled: document.getElementById('admin-time-limit-toggle').checked, startTime: document.getElementById('admin-start-time').value, endTime: document.getElementById('admin-end-time').value }, users: u, students: allAdminStudentsData }) })
        .then(res => res.json()).then(data => { btn.innerText = originalText; btn.disabled = false; if(data.status === "success") Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); }).catch(err => { btn.innerText = originalText; btn.disabled = false; Swal.fire('‡∏£‡∏∞‡∏ö‡∏ö SIS', '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'); });
    }

    function fetchFullExecData() { document.getElementById('exec-ai-insight').innerHTML = "<p style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>"; fetch(`${GAS_API_URL}?action=get_full_exec_data`).then(res=>res.json()).then(data=>{execFullAttendance=data.attendance; execFullStudents=data.students; execFullBehavior=data.behavior || []; updateExecViewDropdown();}); }
    function updateExecViewDropdown() { let v = document.getElementById('exec-view-type').value, c = document.getElementById('exec-sub-filter-container'), s = document.getElementById('exec-sub-filter'), i = document.getElementById('exec-sub-input'); s.style.display = 'none'; i.style.display = 'none'; c.style.display = v === 'school' ? 'none' : 'block'; if(v === 'grade') { s.style.display='block'; let g = new Set(); execFullStudents.forEach(x=>g.add(x[3].split('/')[0])); s.innerHTML='<option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>'; [...g].sort().forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`); } else if(v === 'class') { s.style.display='block'; let cl = new Set(); execFullStudents.forEach(x=>cl.add(x[3])); s.innerHTML='<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...cl].sort().forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`); } else if(v === 'student') i.style.display='block'; processExecData(); }
    
    function processExecData() {
        let v = document.getElementById('exec-view-type').value, sub = v==='student'?document.getElementById('exec-sub-input').value:document.getElementById('exec-sub-filter').value; let st = document.getElementById('exec-date-start').valueAsDate||new Date(0), en = document.getElementById('exec-date-end').valueAsDate||new Date(); 
        
        let stats = {p:0, late:0, pleave:0, sleave:0, abs:0, out:0, total:0}, gStat = {};
        let studentsMap = {}; 

        execFullStudents.forEach(std => {
            let stdGrade = std[3].split('/')[0]; let stdClass = std[3];
            let match = (v==='school')||(v==='grade'&&(sub==='all'||stdClass.startsWith(sub)))||(v==='class'&&(sub==='all'||stdClass===sub))||(v==='student'&&std[1]===sub);
            if(match) {
                let cleanId = String(std[1]).trim().replace(/'/g, '').replace(/^0+/, '');
                studentsMap[cleanId] = { id: std[1], name: std[2], className: std[3], behaviorScore: 100, meritScore: 0 };
            }
        });

        execFullAttendance.forEach(row => { 
            let dArr = row[0].split('/'); let rD = new Date(dArr[2], dArr[1]-1, dArr[0]); 
            if(rD >= st && rD <= en) { 
                let match = (v==='school')||(v==='grade'&&(sub==='all'||row[3].startsWith(sub)))||(v==='class'&&(sub==='all'||row[3]===sub))||(v==='student'&&row[1]===sub); 
                if(match) { 
                    stats.total++; let key = v==='school'?row[3]:(v==='class'?row[2]:row[0]); if(!gStat[key]) gStat[key] = {‡∏°‡∏≤:0, ‡∏™‡∏≤‡∏¢:0, ‡∏•‡∏≤‡∏Å‡∏¥‡∏à:0, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:0, ‡∏ô‡∏≠‡∏Å‡∏£_‡∏£:0, ‡∏Ç‡∏≤‡∏î:0, total:0}; 
                    let statText = row[4]; gStat[key].total++; if(statText === '‡∏°‡∏≤') { stats.p++; gStat[key].‡∏°‡∏≤++; } else if(statText === '‡∏™‡∏≤‡∏¢') { stats.late++; gStat[key].‡∏™‡∏≤‡∏¢++; } else if(statText === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') { stats.pleave++; gStat[key].‡∏•‡∏≤‡∏Å‡∏¥‡∏à++; } else if(statText === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') { stats.sleave++; gStat[key].‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢++; } else if(statText === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') { stats.out++; gStat[key].‡∏ô‡∏≠‡∏Å‡∏£_‡∏£++; } else { stats.abs++; gStat[key].‡∏Ç‡∏≤‡∏î++; } 
                } 
            } 
        });

        execFullBehavior.forEach(log => {
            let cleanId = String(log[1]).trim().replace(/'/g, '').replace(/^0+/, '');
            if(studentsMap[cleanId]) {
                let actionTxt = String(log[4]); let pts = parseInt(log[5]) || 0;
                if(actionTxt.indexOf('[‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ]') > -1) { studentsMap[cleanId].meritScore += pts; } 
                else { studentsMap[cleanId].behaviorScore += pts; if(studentsMap[cleanId].behaviorScore > 100) studentsMap[cleanId].behaviorScore = 100; }
            }
        });

        let exTot = document.getElementById('exec-total'); if(exTot) exTot.innerText = stats.total; 
        let overallPerc = stats.total > 0 ? ((stats.p / stats.total) * 100).toFixed(1) : 0; 
        let exPerc = document.getElementById('exec-present-perc'); if(exPerc) exPerc.innerText = overallPerc + '%';
        let ctx = document.getElementById('execChart').getContext('2d'); if(execChartInstance) execChartInstance.destroy(); let labels = Object.keys(gStat).sort(); let d1 = labels.map(k=>gStat[k].‡∏°‡∏≤), d2 = labels.map(k=>gStat[k].‡∏™‡∏≤‡∏¢), d3 = labels.map(k=>gStat[k].‡∏•‡∏≤‡∏Å‡∏¥‡∏à), d4 = labels.map(k=>gStat[k].‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢), d5 = labels.map(k=>gStat[k].‡∏ô‡∏≠‡∏Å‡∏£_‡∏£), d6 = labels.map(k=>gStat[k].‡∏Ç‡∏≤‡∏î);
        execChartInstance = new Chart(ctx, { type:'bar', data:{ labels:labels, datasets:[{label:'‡∏°‡∏≤', data:d1, backgroundColor:'#10b981'},{label:'‡∏™‡∏≤‡∏¢', data:d2, backgroundColor:'#eab308'},{label:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', data:d3, backgroundColor:'#f97316'},{label:'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', data:d4, backgroundColor:'#f43f5e'},{label:'‡∏ô‡∏≠‡∏Å ‡∏£.‡∏£.', data:d5, backgroundColor:'#3b82f6'},{label:'‡∏Ç‡∏≤‡∏î', data:d6, backgroundColor:'#991b1b'}] }, options:{ responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}} } });
        let tBody = document.getElementById('exec-detail-body'); if(tBody) { tBody.innerHTML = ""; if(labels.length === 0) { tBody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>"; } else { labels.forEach(k => { let g = gStat[k]; let p = g.total > 0 ? ((g.‡∏°‡∏≤ / g.total) * 100).toFixed(1) : 0; let color = p >= 80 ? '#10b981' : '#ef4444'; tBody.innerHTML += `<tr><td style="text-align:left; font-weight:bold;">${k}</td><td style="color:#10b981;">${g.‡∏°‡∏≤}</td><td style="color:#eab308;">${g.‡∏™‡∏≤‡∏¢}</td><td style="color:#f97316;">${g.‡∏•‡∏≤‡∏Å‡∏¥‡∏à}</td><td style="color:#f43f5e;">${g.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢}</td><td style="color:#991b1b; font-weight:bold;">${g.‡∏Ç‡∏≤‡∏î}</td><td style="color:#3b82f6;">${g.‡∏ô‡∏≠‡∏Å‡∏£_‡∏£}</td><td style="color:${color}; font-weight:bold;">${p}%</td></tr>`; }); } }
        generateExecutiveAIInsight(stats, gStat, v, overallPerc);

        let studentsArray = Object.values(studentsMap);
        let topStudents = [...studentsArray].sort((a,b) => { if(b.behaviorScore !== a.behaviorScore) return b.behaviorScore - a.behaviorScore; return b.meritScore - a.meritScore; }).slice(0, 10);
        let riskStudents = [...studentsArray].filter(s => s.behaviorScore < 100).sort((a,b) => { if(a.behaviorScore !== b.behaviorScore) return a.behaviorScore - b.behaviorScore; return a.meritScore - b.meritScore; }).slice(0, 10);

        let lbHTML = "";
        topStudents.forEach((std, index) => {
            let rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : 'rank-other'));
            let rankText = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : (index === 2 ? 'ü•â' : (index + 1)));
            lbHTML += `<div class="leaderboard-row"><div class="rank-badge ${rankClass}">${rankText}</div><div class="std-lb-info"><span class="std-lb-name">${cleanName(std.name)}</span><span class="std-lb-class">‡∏ä‡∏±‡πâ‡∏ô: ${std.className} | ‡∏£‡∏´‡∏±‡∏™: ${std.id.replace(/'/g,'')}</span></div>${std.meritScore > 0 ? `<div class="std-lb-merit">+${std.meritScore} ‡∏î‡∏µ</div>` : ''}<div class="std-lb-score">${std.behaviorScore}</div></div>`;
        });
        if(topStudents.length === 0) lbHTML = "<p style='text-align:center; color:#64748b;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>";
        let elLbCtn = document.getElementById('exec-leaderboard-container'); if(elLbCtn) elLbCtn.innerHTML = lbHTML;

        let riskHTML = "";
        riskStudents.forEach((std, index) => {
            riskHTML += `<div class="leaderboard-row" style="border-color:#fecaca; background:#fff5f5;"><div class="rank-badge" style="background:#ef4444;">${index + 1}</div><div class="std-lb-info"><span class="std-lb-name">${cleanName(std.name)}</span><span class="std-lb-class">‡∏ä‡∏±‡πâ‡∏ô: ${std.className}</span></div><div class="std-lb-score" style="color:#ef4444;">${std.behaviorScore}</div></div>`;
        });
        if(riskStudents.length === 0) riskHTML = "<p style='text-align:center; color:#10b981; font-weight:bold; padding:15px 0;'>üéâ ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</p>";
        let elRskCtn = document.getElementById('exec-risk-container'); if(elRskCtn) elRskCtn.innerHTML = riskHTML;

        let avgBeh = studentsArray.length > 0 ? (studentsArray.reduce((acc, s) => acc + s.behaviorScore, 0) / studentsArray.length).toFixed(1) : 0;
        let totalMerits = studentsArray.reduce((acc, s) => acc + s.meritScore, 0);
        let aiBehHTML = `<p><b>üéØ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</b> <span style="font-size:16px; font-weight:bold; color:${avgBeh >= 80 ? '#10b981' : '#ef4444'};">${avgBeh} / 100</span></p><ul><li>üåü <b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏£‡∏ß‡∏°:</b> ${totalMerits} ‡πÅ‡∏ï‡πâ‡∏°</li>`;
        if(riskStudents.length > 0) aiBehHTML += `<li>‚ö†Ô∏è <b>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô):</b> ${studentsArray.filter(s => s.behaviorScore < 100).length} ‡∏Ñ‡∏ô (‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°)</li></ul>`;
        else aiBehHTML += `<li>‚úÖ <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°:</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ 100% ‡πÄ‡∏ï‡πá‡∏°</li></ul>`;
        let elAiBeh = document.getElementById('exec-ai-behavior-insight'); if(elAiBeh) elAiBeh.innerHTML = aiBehHTML;

        let targetText = v === 'school' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : (v === 'grade' ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ${sub}` : `‡∏´‡πâ‡∏≠‡∏á ${sub}`);
        let elLbSub = document.getElementById('exec-leaderboard-subtitle'); if(elLbSub) elLbSub.innerText = targetText;
    }

    function generateExecutiveAIInsight(totalStats, groupStats, viewType, overallPerc) {
        let aiBox = document.getElementById('exec-ai-insight'); if(!aiBox) return; if (totalStats.total === 0) { aiBox.innerHTML = "<p style='color:#ef4444;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</p>"; return; }
        let html = `<p><b>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:</b> ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <span style="color:${overallPerc >= 80 ? '#10b981' : '#ef4444'}; font-weight:bold; font-size:16px;">${overallPerc}%</span> (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${totalStats.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>`;
        if (viewType === 'school' || viewType === 'grade' || viewType === 'class') {
            let best = { name: '', rate: -1 }, worst = { name: '', rate: 101 }, riskCount = 0;
            for (let k in groupStats) { let rate = (groupStats[k].‡∏°‡∏≤ / groupStats[k].total) * 100; if (rate > best.rate) { best.rate = rate; best.name = k; } if (rate < worst.rate) { worst.rate = rate; worst.name = k; } if (rate < 80) riskCount++; }
            html += `<ul>`; if (best.name) html += `<li>üèÜ <b>‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:</b> ${best.name} (${best.rate.toFixed(1)}%)</li>`; if (worst.name && worst.rate < 100) html += `<li>‚ö†Ô∏è <b>‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ${worst.name} (${worst.rate.toFixed(1)}%)</li>`; html += `</ul>`;
            let issues = [ { name: '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', val: totalStats.abs }, { name: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', val: totalStats.sleave }, { name: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', val: totalStats.pleave }, { name: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', val: totalStats.late } ].sort((a,b) => b.val - a.val); let topIssue = issues[0];
            html += `<p style="margin-top:10px;"><b>üí° ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</b></p><ul>`; if (overallPerc < 80) html += `<li>üî¥ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80% ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô</li>`; else html += `<li>üü¢ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ</li>`; if (riskCount > 0) html += `<li>üî¥ ‡∏°‡∏µ ${riskCount} ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå</li>`; if (topIssue.val > 0) html += `<li>üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠ <b>"${topIssue.name}" (${topIssue.val} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b></li>`; html += `</ul>`;
        } else { if (overallPerc >= 80) html += `<br>üí° <b>‡∏™‡∏£‡∏∏‡∏õ:</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö`; else html += `<br>üí° <b>‡∏™‡∏£‡∏∏‡∏õ:</b> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö`; }
        aiBox.innerHTML = html;
    }

    function loadStudentReport(id, isSilent = false) {
        let hdrName = document.getElementById('hdr-name');
        if(!isSilent && hdrName) { hdrName.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; }
        fetch(`${GAS_API_URL}?action=get_student_report&studentId=${id}`).then(res=>res.json()).then(data => {
            if(data.info) {
                let cardId = document.getElementById('id-card-id'); if(cardId) cardId.innerText = data.info.id; 
                let cardCls = document.getElementById('id-card-class'); if(cardCls) cardCls.innerText = data.info.className; 
                let cardNum = document.getElementById('id-card-number'); if(cardNum) cardNum.innerText = data.info.number;
                if(data.info.name) { 
                    let cName = document.getElementById('id-card-name'); if(cName) cName.innerText = data.info.name; 
                    if(hdrName) hdrName.innerText = data.info.name; 
                }
                let cBar = document.getElementById('id-card-barcode'); if(cBar) cBar.innerText = `*${data.info.id}*`; 
                let hId = document.getElementById('hdr-id'); if(hId) hId.innerText = data.info.id; 
                let hNum = document.getElementById('hdr-num'); if(hNum) hNum.innerText = data.info.number; 
                let hCls = document.getElementById('hdr-class'); if(hCls) hCls.innerText = data.info.className;
            }
            
            let stPres = document.getElementById('st-stat-present'); if(stPres) stPres.innerText = data.stats.present; 
            let stAbs = document.getElementById('st-stat-absent'); if(stAbs) stAbs.innerText = data.stats.absent; 
            let stLeave = document.getElementById('st-stat-leave'); if(stLeave) stLeave.innerText = data.stats.personal_leave + data.stats.sick_leave;
            
            let p = data.stats.total > 0 ? (data.stats.present / data.stats.total * 100).toFixed(1) : 0; 
            let aiAss = document.getElementById('ai-assessment-text');
            if(aiAss) aiAss.innerHTML = p >= 80 ? `üåü <b>‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!` : `‚ö†Ô∏è <b>‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (${p}%) ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö`;
            
            let hHTML = ""; data.history.reverse().forEach(x => hHTML += `<tr><td>${formatThaiDate(x.date)}</td><td>${x.status}</td><td>${x.note||'-'}</td></tr>`); 
            let stdHist = document.getElementById('student-history-body'); if(stdHist) stdHist.innerHTML = hHTML;

            if(data.behaviorScore !== undefined) {
                let behText = document.getElementById('behavior-score-text'); 
                let behBox = document.getElementById('behavior-score-box');
                let meritTxt = document.getElementById('merit-score-text');
                if(behText) behText.innerText = data.behaviorScore;
                if(meritTxt) meritTxt.innerText = data.meritScore;
                
                if(behBox && behText) {
                    if(data.behaviorScore >= 80) { behText.style.color = '#059669'; behBox.style.background = '#ecfdf5'; behBox.style.borderColor = '#34d399'; } 
                    else if(data.behaviorScore >= 60) { behText.style.color = '#d97706'; behBox.style.background = '#fffbeb'; behBox.style.borderColor = '#fbbf24'; } 
                    else { behText.style.color = '#dc2626'; behBox.style.background = '#fef2f2'; behBox.style.borderColor = '#f87171'; }
                }
                
                let behHTML = "";
                if(data.behaviorHistory && data.behaviorHistory.length > 0) {
                    data.behaviorHistory.reverse().forEach(h => { 
                        let ptsColor = h.isMerit ? '#10b981' : (h.points < 0 ? '#ef4444' : '#10b981'); 
                        let ptsSign = h.points > 0 ? '+' : ''; 
                        behHTML += `<tr><td style="border-bottom:1px solid #eee; padding:8px 5px;">${formatThaiDate(h.date)}</td><td style="border-bottom:1px solid #eee; padding:8px 5px;">${h.action.replace('[‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ] ', '').replace('[‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°] ', '')}<br><span style="font-size:10px; color:#94a3b8;">${h.teacher}</span></td><td style="border-bottom:1px solid #eee; padding:8px 5px; font-weight:bold; color:${ptsColor}; text-align:center;">${ptsSign}${h.points}</td></tr>`; 
                    });
                } else { behHTML = `<tr><td colspan='3' style='text-align:center; padding:15px; color:#64748b;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</td></tr>`; }
                let stdBehHist = document.getElementById('student-behavior-history-body');
                if(stdBehHist) stdBehHist.innerHTML = behHTML;
            }
        });
    }

    function logout() { 
        if(studentDataTimer) clearInterval(studentDataTimer); 
        Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏ö SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', text: "‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", icon: 'question', showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#cbd5e1', confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => { if(result.isConfirmed) { localStorage.removeItem('sis_user'); localStorage.removeItem('sis_last_activity'); localStorage.removeItem('sis_current_page'); location.reload(); } });
    }
</script>

</body>
</html>
