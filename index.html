<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS BCW - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e56a0; --bg: #f3f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .navbar { background: var(--primary); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .container { max-width: 900px; margin: 15px auto; padding: 0 10px; min-height: 80vh;}
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .card { background: #fff; border-radius: 12px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        .nav-menu { position: fixed; bottom: 0; width: 100%; background: white; display: none; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 1000;}
        .nav-item { text-align: center; font-size: 13px; color: #64748b; cursor: pointer; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: 'Prompt'; width: 100%; box-sizing: border-box; margin-bottom: 10px;}
        button { padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Prompt'; font-weight: bold;}
        
        .live-status-bar { background: #fff; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: none; justify-content: space-between; align-items: center; font-size: 13px; font-weight: 600; color: #1e293b; border-bottom: 3px solid var(--primary); }

        .student-row { display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px 10px; margin-bottom: 8px; gap: 8px; position: relative; }
        .student-number { font-size: 13px; font-weight: bold; color: #64748b; min-width: 20px; text-align: center; flex-shrink: 0; }
        .student-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; border: 1.5px solid #e2e8f0; flex-shrink: 0; }
        .student-name { flex: 1; font-size: 14px; color: #15283c; font-weight: 500; line-height: 1.3; white-space: normal; word-wrap: break-word;}
        
        .status-dropdown { width: auto; min-width: 105px; margin-bottom: 0 !important; padding: 6px 4px !important; font-size: 13px !important; border-radius: 6px; flex-shrink: 0; cursor: pointer;}
        
        .row-‡∏°‡∏≤ { border-left: 5px solid #10b981; background-color: #f0fdf4; }
        .row-‡∏•‡∏≤‡∏Å‡∏¥‡∏à { border-left: 5px solid #f59e0b; background-color: #fffbeb; }
        .row-‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ { border-left: 5px solid #f43f5e; background-color: #fff1f2; }
        .row-‡∏Ç‡∏≤‡∏î { border-left: 5px solid #991b1b; background-color: #fee2e2; }
        .row-‡∏™‡∏≤‡∏¢ { border-left: 5px solid #eab308; background-color: #fef9c3; }
        .row-‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô { border-left: 5px solid #3b82f6; background-color: #eff6ff; }

        .btn-note { background: none; border: 1px solid #ccc; color: #666; border-radius: 50%; width: 32px; height: 32px; padding: 0; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer;}
        .behavior-note { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Prompt'; font-size: 13px; box-sizing: border-box; resize: vertical; min-height: 40px;}

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; background: white;}
        th, td { padding: 8px 6px; border-bottom: 1px solid #eee; text-align: center; }
        th:nth-child(2), td:nth-child(2) { text-align: left; } 
        th { background: #f8f9fa; font-weight: 600;}
        .risk-row { background-color: #fee2e2 !important; }

        .stat-grid { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;}
        .stat-card { flex: 1; min-width:70px; padding: 12px; border-radius: 10px; color: white; text-align: center; }
        .stat-blue { background: linear-gradient(135deg, #1e56a0, #2a6fcc); }
        .stat-green { background: #10b981; }
        .stat-red { background: #ef4444; }
        .stat-card h3 { margin: 0; font-size: 12px; opacity: 0.9; }
        .stat-card h2 { margin: 3px 0 0 0; font-size: 20px; }

        .ai-box { background: #f0f7ff; border-left: 5px solid #1e56a0; padding: 15px; border-radius: 8px; margin-bottom: 15px;}
        .ai-box h3 { margin-top: 0; color: #1e56a0; display:flex; align-items:center; gap:8px; font-size:15px; margin-bottom: 5px;}

        .ai-exec-box { background: #fff; border: 1px solid #e2e8f0; border-left: 6px solid #8b5cf6; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03);}
        .ai-exec-box h3 { margin-top: 0; color: #6d28d9; display:flex; align-items:center; gap:8px; font-size:16px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .ai-exec-box p { margin: 0; line-height: 1.6; font-size: 14px; color: #334155; }
        .ai-exec-box ul { margin: 10px 0 0 0; padding-left: 20px; }
        .ai-exec-box li { margin-bottom: 8px; }

        .calendar-month { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px;}
        .calendar-month h4 { margin: 0 0 10px 0; text-align: center; color: #1e56a0; font-size: 14px;}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-header { font-weight: bold; font-size: 11px; color: #64748b; padding-bottom: 5px; }
        .calendar-day { padding: 8px 0; border-radius: 6px; font-size: 12px; cursor: pointer; background: #f1f5f9; border: 1px solid #e2e8f0; transition: 0.2s; }
        .calendar-day:hover:not(.blank) { background: #cbd5e1; }
        .calendar-day.holiday { background: #ef4444; color: white; border-color: #ef4444; font-weight: bold; box-shadow: 0 2px 5px rgba(239,68,68,0.3);}
        .calendar-day.blank { background: transparent; border: none; cursor: default; color: #cbd5e1; }

        .footer-credit { text-align: center; padding: 25px; margin-top: 40px; color: #64748b; font-size: 13px; border-top: 1px dashed #ddd; line-height: 1.8; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold;">üè´ SIS ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
    <div id="user-display" style="font-size: 12px; cursor: pointer;" onclick="logout()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
</div>

<div class="container">
    
    <div id="status-bar" class="live-status-bar">
        <span id="display-date"></span>
        <span id="display-clock" style="color:var(--primary);"></span>
    </div>

    <div id="login-page" class="page active">
        <div class="card" style="text-align: center; max-width: 400px; margin: 40px auto;">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgb1oewS_bG2frmr1y3aOrwykh-wBZiipEUv9BbTxGSQh2d-Ergv_Ez4MWoO4AO8_wdCG19Nrravj8iJCc33arzt3ZXi2lmQ2v1hKGvEIBcLdjcCkZdfdZF-p8DWehYl3lzSWhWSOI4NKeNhWRzWkUHRJnMs1KFVMW_BwwUq83DafDaQpwu3-hOs-Ieix0/s225/304789124_573612801071886_7852363760169451884_n.png" 
                 alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" 
                 style="width: 120px; height: auto; margin-bottom: 15px;">
            <p id="login-clock" style="font-size:14px; font-weight:bold; color:#475569; margin-bottom:20px;"></p>
            <input type="text" id="username" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <input type="password" id="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button id="login-btn" onclick="handleLogin()" style="width: 100%; font-size:16px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="checklist-page" class="page">
        <div class="toolbar">
            <h2 style="margin: 0; font-size: 18px;">üìù ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ <span id="class-title" style="color:var(--primary);"></span></h2>
            <input type="date" id="check-date" class="date-picker" style="padding: 6px; font-size: 14px;" onchange="fetchStudents()">
        </div>
        <div class="ai-box">
            <h3>ü§ñ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô</h3>
            <p id="teacher-quick-ai" style="font-size:13px; margin:0; line-height:1.5; color:#333;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
        </div>
        <div id="student-list-container"></div>
        <button class="save-btn" id="save-btn" onclick="saveAttendance()" style="width:100%; padding:15px; font-size: 16px; margin-top: 10px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="daily-page" class="page">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin:0; font-size: 18px; color: #1e56a0;">üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                <span id="weekly-date-range" style="font-size:12px; font-weight:bold; background:#e0f2fe; color:#0369a1; padding:5px 10px; border-radius:6px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
            <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                <h3 style="font-size:14px;">ü§ñ AI ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                <p id="teacher-daily-ai" style="font-size:13px; margin:0;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            <div style="overflow-x:auto;">
                <table style="margin-top:0;">
                    <thead>
                        <tr>
                            <th style="width:30px;">‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th id="th-mon" style="width:40px;">‡∏à.</th>
                            <th id="th-tue" style="width:40px;">‡∏≠.</th>
                            <th id="th-wed" style="width:40px;">‡∏û.</th>
                            <th id="th-thu" style="width:40px;">‡∏û‡∏§.</th>
                            <th id="th-fri" style="width:40px;">‡∏®.</th>
                        </tr>
                    </thead>
                    <tbody id="daily-body"></tbody>
                </table>
            </div>
            <p style="font-size: 11px; color:#666; margin-top:10px;">*‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠: ‡∏°=‡∏°‡∏≤, ‡∏™=‡∏™‡∏≤‡∏¢, ‡∏•=‡∏•‡∏≤‡∏Å‡∏¥‡∏à, ‡∏õ=‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢, ‡∏Ç=‡∏Ç‡∏≤‡∏î, ‡∏ô=‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
        </div>
    </div>

    <div id="summary-page" class="page">
        <h2 style="color: #1e56a0; margin-bottom: 10px; margin-top:0;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß (‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á)</h2>
        <div class="stat-grid" id="teacher-stat-grid" style="display:none;">
            <div class="stat-card stat-blue"><h3>‡∏ô‡∏£. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><h2 id="tc-total-std">0</h2></div>
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><h2 id="tc-avg-perc">0%</h2></div>
            <div class="stat-card stat-red"><h3>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (<80%)</h3><h2 id="tc-risk-std">0</h2></div>
        </div>
        <div class="card" style="padding-top:10px;">
            <div class="ai-box" style="margin-bottom:10px; padding:10px;">
                <h3 style="font-size:14px;">ü§ñ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                <p id="teacher-summary-ai" style="font-size:13px; margin:0;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</p>
            </div>
            <div style="overflow-x:auto;">
                <table style="margin-top:0; border: 1px solid #eee; white-space: nowrap;">
                    <thead>
                        <tr>
                            <th style="width: 30px;">‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th style="color:#10b981;">‡∏°‡∏≤</th>
                            <th style="color:#eab308;">‡∏™‡∏≤‡∏¢</th>
                            <th style="color:#f97316;">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
                            <th style="color:#f43f5e;">‡∏õ‡πà‡∏ß‡∏¢</th>
                            <th style="color:#991b1b;">‡∏Ç‡∏≤‡∏î</th>
                            <th style="color:#3b82f6;">‡∏ô‡∏≠‡∏Å‡∏£.‡∏£.</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="admin-page" class="page">
        <h2 style="color: #1e56a0;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h2>
        <div class="card">
            <h3>üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ & ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label style="font-size:12px; font-weight:bold;">‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</label><input type="date" id="admin-start" onchange="renderAdminCalendar()"></div>
                <div style="flex:1"><label style="font-size:12px; font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</label><input type="date" id="admin-end" onchange="renderAdminCalendar()"></div>
            </div>
            
            <div id="school-days-count" style="margin-top: 15px; font-weight: bold; color: #1e56a0; background: #e0f2fe; padding: 12px; border-radius: 8px; border-left: 5px solid #1e56a0; display: flex; justify-content: space-between; align-items: center;">
                <div>üéì ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏´‡∏¢‡∏∏‡∏î): <span id="working-days-text" style="font-size:18px; color:#ef4444;">0</span> ‡∏ß‡∏±‡∏ô</div>
            </div>

            <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top:15px;">
                <label style="font-weight:bold; color:#ef4444; display:block; margin-bottom:10px;">‚õî ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô)</label>
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; font-size:12px; flex-wrap: wrap;">
                    <div style="width:15px; height:15px; background:#f1f5f9; border:1px solid #ccc; border-radius:3px;"></div> ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
                    <div style="width:15px; height:15px; background:#ef4444; border-radius:3px; margin-left:10px;"></div> ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î / ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
                    <button id="fetch-holidays-btn" onclick="fetchPublicHolidays()" style="background:#10b981; margin-left:auto; font-size:12px; padding:6px 12px; border-radius: 6px;">üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢</button>
                </div>
                <div id="admin-calendar-container" style="max-height: 400px; overflow-y: auto; padding-right:5px;"></div>
            </div>
        </div>

        <div class="card">
            <h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
            <div style="overflow-x: auto;"><table id="admin-users-table"><thead><tr><th>User</th><th>Pass</th><th>Role</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="admin-users-body"></tbody></table></div>
            <button onclick="addUserRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0;">üéì ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><select id="admin-class-filter" onchange="renderAdminStudents()" style="width:120px; margin:0;"><option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option></select></div>
            <div style="overflow-x: auto; max-height:300px; margin-top:10px;"><table id="admin-students-table"><thead><tr><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="admin-students-body"></tbody></table></div>
            <button onclick="addStudentRow()" style="background:#28a745; margin-top:10px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ô‡∏£.</button>
        </div>
        <button onclick="saveAdminData()" style="width:100%; padding:15px; font-size:16px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div id="exec-page" class="page">
        <h2 style="color: #1e56a0; margin-bottom: 5px;">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive)</h2>
        <button onclick="fetchFullExecData()" style="width:100%; margin-bottom:15px; background:#17a2b8;">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        
        <div class="exec-filters">
            <div><label>üìå ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label><select id="exec-view-type" onchange="updateExecViewDropdown()"><option value="school">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option><option value="grade">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option><option value="class">‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</option><option value="student">‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</option></select></div>
            <div id="exec-sub-filter-container" style="display:none;"><label>üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><select id="exec-sub-filter" onchange="processExecData()"></select><input type="text" id="exec-sub-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" style="display:none;" onkeyup="if(event.keyCode===13) processExecData()"></div>
            <div><label>üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><div style="display:flex; gap:5px;"><input type="date" id="exec-date-start" onchange="processExecData()"><input type="date" id="exec-date-end" onchange="processExecData()"></div></div>
        </div>

        <div class="ai-exec-box">
            <h3>ü§ñ ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive Summary)</h3>
            <div id="exec-ai-insight">
                <p style="text-align:center; color:#64748b;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
            </div>
        </div>

        <div class="stat-grid" style="margin-bottom: 10px;">
            <div class="stat-card stat-blue"><h3>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏° (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h3><h2 id="exec-total">0</h2></div>
            <div class="stat-card stat-green"><h3>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3><h2 id="exec-present-perc">0%</h2></div>
        </div>

        <div class="card" style="height: 350px;"><canvas id="execChart"></canvas></div>

        <div class="card">
            <h3 style="margin-top:0; color:#1e56a0;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Detail Data)</h3>
            <div style="overflow-x: auto; max-height: 400px;">
                <table style="white-space: nowrap;">
                    <thead id="exec-detail-head">
                        <tr>
                            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</th>
                            <th style="color:#10b981;">‡∏°‡∏≤</th>
                            <th style="color:#eab308;">‡∏™‡∏≤‡∏¢</th>
                            <th style="color:#f97316;">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
                            <th style="color:#f43f5e;">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
                            <th style="color:#991b1b;">‡∏Ç‡∏≤‡∏î</th>
                            <th style="color:#3b82f6;">‡∏ô‡∏≠‡∏Å ‡∏£.‡∏£.</th>
                            <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="exec-detail-body">
                        <tr><td colspan='8' style='text-align:center;'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="student-page" class="page">
        <h2 style="color: #1e56a0;">üéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</h2>
        <div class="card stat-blue">
            <h3 id="st-name-display" style="margin:0; font-size: 18px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <p id="st-id-display" style="margin:5px 0 0 0; font-size:13px;"></p>
        </div>
        <div class="stat-grid">
            <div class="stat-card stat-green"><h3>‡∏°‡∏≤</h3><h2 id="st-stat-present">0</h2></div>
            <div class="stat-card stat-red"><h3>‡∏Ç‡∏≤‡∏î</h3><h2 id="st-stat-absent">0</h2></div>
            <div class="stat-card" style="background:#f59e0b;"><h3>‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3><h2 id="st-stat-leave">0</h2></div>
        </div>
        <div class="ai-box"><p id="ai-assessment-text" style="font-size:13px; margin:0;"></p></div>
        <div class="card">
            <h3>üìÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
            <div style="overflow-x: auto;">
                <table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th></tr></thead><tbody id="student-history-body"></tbody></table>
            </div>
        </div>
    </div>

    <div class="footer-credit">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢<br><b>‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Ñ‡∏£‡πÄ‡∏î‡∏ä ‡πÇ‡∏û‡∏ò‡∏¥‡∏ç‡∏≤‡∏ì‡πå</b><br>‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div>
</div>

<div class="nav-menu" id="bottom-nav">
    <div class="nav-item active" onclick="switchPage('checklist-page', this)"><span>üìù</span><br>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
    <div class="nav-item" onclick="switchPage('daily-page', this)"><span>üìÖ</span><br>‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
    <div class="nav-item" onclick="switchPage('summary-page', this)"><span>üìä</span><br>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
</div>

<script>
    // üîó API (‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á‡∏Ø ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz1Pi37ZXLJJQGvnfz20a_aH2y4sSDjt8dCmyqgdhaF3gin7jRhTh7jY1ajDRdnw1E2/exec";
    
    // --- ‚è∞ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ ---
    function updateClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('th-TH');
        if(document.getElementById('login-clock')) document.getElementById('login-clock').innerHTML = `${dateStr}<br>${timeStr} ‡∏ô.`;
        if(document.getElementById('display-date')) document.getElementById('display-date').innerText = dateStr;
        if(document.getElementById('display-clock')) document.getElementById('display-clock').innerText = `üïí ${timeStr} ‡∏ô.`;
    }
    setInterval(updateClock, 1000); updateClock();

    function cleanName(fullName) { return fullName ? fullName.replace(/^(‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢|‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á|‡∏ô‡∏≤‡∏¢|‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß|‡∏î\.‡∏ä\.|‡∏î\.‡∏ç\.)\s*/g, "").trim() : ""; }

    // üåü ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    let students = [], attendanceData = {}, currentTeacher = "", currentClass = "";
    let allAdminStudentsData = [], adminHolidays = [], adminTermStart = "", adminTermEnd = "";
    let execFullAttendance = [], execFullStudents = [], execChartInstance = null;

    function handleLogin() {
        const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim(), btn = document.getElementById('login-btn');
        if (!u || !p) return;
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."; btn.disabled = true;
        
        fetch(`${GAS_API_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
            .then(res => res.json()).then(data => {
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false;
                if (data.status === "success") {
                    document.getElementById('user-display').innerText = `${data.name} - ‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö`;
                    document.getElementById('status-bar').style.display = 'flex';
                    
                    if (data.role === "teacher") { 
                        currentTeacher = data.name; currentClass = data.className; 
                        document.getElementById('class-title').innerText = `(${currentClass})`;
                        document.getElementById('bottom-nav').style.display = 'flex';
                        switchPage('checklist-page', document.querySelectorAll('.nav-item')[0]);
                        
                        // üåü ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏à‡∏≤‡∏Å Admin ‡∏°‡∏≤‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                        fetch(`${GAS_API_URL}?action=get_admin_data`).then(res => res.json()).then(adminData => {
                            if(adminData.status === "success") {
                                adminHolidays = (adminData.config.holidays || []).filter(h => h.trim() !== "");
                                adminTermStart = adminData.config.startDate;
                                adminTermEnd = adminData.config.endDate;
                            }
                            fetchStudents(); 
                        });
                        
                    } else if(data.role === "admin") {
                        switchPage('admin-page'); loadAdminData();
                    } else if(data.role === "executive" || data.role === "boss") {
                        switchPage('exec-page'); fetchFullExecData();
                    } else if(data.role === "student") {
                        switchPage('student-page'); document.getElementById('st-name-display').innerText = data.name; loadStudentReport(u);
                    }
                } else alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }).catch(() => { btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; btn.disabled = false; });
    }

    function switchPage(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        if(element) { document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); element.classList.add('active'); }
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'daily-page' && currentClass) loadWeeklyData(); 
        if (pageId === 'summary-page' && currentClass) loadSummaryData();
    }

    // --- üìù TEACHER CHECKLIST (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î) ---
    function fetchStudents() {
        let dateInput = document.getElementById('check-date');
        if(!dateInput.value) dateInput.valueAsDate = new Date();
        let selectedDateStr = dateInput.value;
        
        let dObj = new Date(selectedDateStr);
        let isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6);
        let isHoliday = adminHolidays.includes(selectedDateStr);
        
        let isOutsideTerm = false;
        if (adminTermStart && adminTermEnd) {
            let sD = new Date(adminTermStart); sD.setHours(0,0,0,0);
            let eD = new Date(adminTermEnd); eD.setHours(23,59,59,999);
            if(dObj < sD || dObj > eD) isOutsideTerm = true;
        }

        // üõë ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏ô‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°
        if (isOutsideTerm) {
            document.getElementById('student-list-container').innerHTML = `<div style="background:#f1f5f9; color:#475569; padding:20px; border-radius:10px; text-align:center; border: 2px dashed #cbd5e1;"><h3 style="margin:0 0 5px 0;">üìÖ ‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</h3><p style="margin:0;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p></div>`;
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('teacher-quick-ai').innerHTML = "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö";
            return;
        }

        // üõë ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
        if (isWeekend || isHoliday) {
            let reason = isWeekend ? "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå" : "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏© / ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå";
            document.getElementById('student-list-container').innerHTML = `
                <div style="background:#fee2e2; color:#b91c1c; padding:20px; border-radius:10px; text-align:center; border: 2px dashed #f87171;">
                    <h3 style="margin:0 0 5px 0;">‚õî ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</h3>
                    <p style="margin:0;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö <b>${reason}</b><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö</p>
                </div>`;
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('teacher-quick-ai').innerHTML = "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π ‚òï";
            return;
        }

        document.getElementById('student-list-container').innerHTML = `<div style="text-align:center; padding:20px;">‚è≥ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>`;
        document.getElementById('save-btn').style.display = 'none'; 
        
        fetch(`${GAS_API_URL}?action=get_students&className=${encodeURIComponent(currentClass)}`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                students = data.data;
                fetch(`${GAS_API_URL}?action=check_existing&className=${encodeURIComponent(currentClass)}&date=${selectedDateStr}`)
                    .then(res => res.json()).then(check => {
                        renderChecklist(check.status === "found" ? check.data : null, check.recordedBy);
                        loadQuickAIInsight(); 
                    });
            }
        });
    }

    function renderChecklist(existing, recorder) {
        const container = document.getElementById('student-list-container'); container.innerHTML = "";
        if(existing) {
            container.innerHTML = `<div style="background:#fff3cd; color:#856404; padding:10px; border-radius:8px; margin-bottom:15px; font-weight:bold; font-size:13px;">‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${document.getElementById('check-date').value} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢: ${recorder}</div>`;
            document.getElementById('save-btn').style.display = 'none'; 
        } else document.getElementById('save-btn').style.display = 'block'; 

        students.forEach(std => {
            let st = existing && existing[std.id] ? existing[std.id].status : '‡∏°‡∏≤';
            let nt = existing && existing[std.id] ? existing[std.id].note : '';
            attendanceData[std.id] = { status: st, note: nt };
            const displayName = cleanName(std.name);
            const imgUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=1e56a0&color=fff&size=128&rounded=true`;

            let row = document.createElement('div');
            row.className = `student-row row-${st}`; row.id = `row-${std.id}`;
            let displayModeHtml = existing ? `<div style="text-align:right; font-size:13px; font-weight:bold; width:90px;">${st}</div>` : `
                <select class="status-dropdown" onchange="setStatus('${std.id}', this.value)">
                    <option value="‡∏°‡∏≤" ${st==='‡∏°‡∏≤'?'selected':''}>‚úÖ ‡∏°‡∏≤</option>
                    <option value="‡∏™‡∏≤‡∏¢" ${st==='‡∏™‡∏≤‡∏¢'?'selected':''}>‚è∞ ‡∏™‡∏≤‡∏¢</option>
                    <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à" ${st==='‡∏•‡∏≤‡∏Å‡∏¥‡∏à'?'selected':''}>üìù ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                    <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" ${st==='‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'?'selected':''}>ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                    <option value="‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ${st==='‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'?'selected':''}>üåç ‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                    <option value="‡∏Ç‡∏≤‡∏î" ${st==='‡∏Ç‡∏≤‡∏î'?'selected':''}>‚ùå ‡∏Ç‡∏≤‡∏î</option>
                </select>
                <button class="btn-note" onclick="toggleNote('${std.id}')">üìù</button>
            `;
            row.innerHTML = `<div class="student-number">${std.number}</div><img src="${imgUrl}" class="student-img" alt="student"><div class="student-name">${displayName}</div>${displayModeHtml}<div id="note-box-${std.id}" style="display:none; position:absolute; right:10px; top:50px; z-index:100; background:white; padding:10px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.15); width:220px; border:1px solid #eee;"><textarea class="behavior-note" id="note-${std.id}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">${nt}</textarea><button onclick="toggleNote('${std.id}')" style="width:100%; margin-top:8px; background:var(--primary); font-size:12px; padding:6px;">‡∏ï‡∏Å‡∏•‡∏á</button></div>`;
            container.appendChild(row);
        });
    }

    function setStatus(id, s) { attendanceData[id].status = s; document.getElementById(`row-${id}`).className = `student-row row-${s}`; }
    function toggleNote(id) { let b = document.getElementById(`note-box-${id}`); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }

    function saveAttendance() {
        const btn = document.getElementById('save-btn'); btn.innerText = "‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."; btn.disabled = true;
        let records = [];
        students.forEach(s => records.push({ id: s.id, name: s.name, className: currentClass, status: attendanceData[s.id].status, note: document.getElementById(`note-${s.id}`).value }));
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "save_bulk", date: document.getElementById('check-date').value, teacherName: currentTeacher, records: records }) })
        .then(res => res.json()).then(data => {
            btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
            if(data.status === "success") { alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); fetchStudents(); } else alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
        });
    }

    function loadQuickAIInsight() {
        document.getElementById('teacher-quick-ai').innerHTML = "‚è≥ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                if(data.data.length === 0) { document.getElementById('teacher-quick-ai').innerHTML = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‚úåÔ∏è"; return; }
                let sumTotal = 0, sumPres = 0, riskList = [];
                data.data.forEach(d => {
                    let stTotal = d.present + d.personal_leave + d.sick_leave + d.absent + d.late + d.outside;
                    if(stTotal > 0) { sumTotal += stTotal; sumPres += d.present; if((d.present / stTotal) * 100 < 80) riskList.push(cleanName(d.name)); }
                });
                let avgPerc = sumTotal > 0 ? ((sumPres / sumTotal) * 100).toFixed(1) : 0;
                let aiMsg = `üìä <b>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏∞‡∏™‡∏°:</b> <b style="color:${avgPerc>=80?'green':'red'};">${avgPerc}%</b><br>`;
                aiMsg += riskList.length > 0 ? `‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${riskList.length} ‡∏Ñ‡∏ô: <span style="color:red;">${riskList.slice(0,3).join(', ')}${riskList.length>3?'...':''}</span>` : `üåü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80% ‡∏Ñ‡∏£‡∏±‡∏ö`;
                document.getElementById('teacher-quick-ai').innerHTML = aiMsg;
            }
        });
    }

    function loadWeeklyData() {
        let tbody = document.getElementById('daily-body'); tbody.innerHTML = `<tr><td colspan='7' style='text-align:center; padding:20px;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏•‡∏≠‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå...</td></tr>`;
        document.getElementById('teacher-daily-ai').innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ...";
        let curr = new Date(); let day = curr.getDay(); let diffToMon = curr.getDate() - day + (day === 0 ? -6 : 1);
        let monDate = new Date(curr.setDate(diffToMon)); monDate.setHours(0,0,0,0);
        let weekDates = []; let thElements = ['th-mon', 'th-tue', 'th-wed', 'th-thu', 'th-fri']; let dayNames = ['‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.'];
        for(let i=0; i<5; i++) {
            let d = new Date(monDate); d.setDate(monDate.getDate() + i);
            let yyyy = d.getFullYear(); let mm = String(d.getMonth() + 1).padStart(2, '0'); let dd = String(d.getDate()).padStart(2, '0');
            weekDates.push(`${yyyy}-${mm}-${dd}`); 
            document.getElementById(thElements[i]).innerHTML = `${dayNames[i]}<br><span style="font-size:10px; font-weight:normal;">${dd}/${mm}</span>`;
            if(i===0) document.getElementById('weekly-date-range').innerText = `${dd}/${mm} - `;
            if(i===4) document.getElementById('weekly-date-range').innerText += `${dd}/${mm}/${yyyy}`;
        }
        let fetches = weekDates.map(dateStr => fetch(`${GAS_API_URL}?action=get_daily&className=${encodeURIComponent(currentClass)}&date=${dateStr}`).then(res => res.json()).catch(e => ({ status: 'error' })));
        Promise.all(fetches).then(results => {
            let weeklyData = {};
            if(students && students.length > 0) students.forEach(std => { weeklyData[std.id] = { name: std.name, status: ['-', '-', '-', '-', '-'] }; });
            let totalAbs = 0;
            results.forEach((res, dayIndex) => {
                if(res && res.status === 'success' && res.data) {
                    res.data.forEach(d => {
                        if(!weeklyData[d.id]) weeklyData[d.id] = { name: d.name, status: ['-', '-', '-', '-', '-'] };
                        let sText = d.status; let shortStat = '-';
                        if(sText === '‡∏°‡∏≤') shortStat = '<b style="color:#10b981;">‡∏°</b>'; else if(sText === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') shortStat = '<b style="color:#f97316;">‡∏•</b>'; else if(sText === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') shortStat = '<b style="color:#f43f5e;">‡∏õ</b>'; else if(sText === '‡∏Ç‡∏≤‡∏î') { shortStat = '<b style="color:#991b1b;">‡∏Ç</b>'; totalAbs++; } else if(sText === '‡∏™‡∏≤‡∏¢') shortStat = '<b style="color:#eab308;">‡∏™</b>'; else if(sText === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') shortStat = '<b style="color:#3b82f6;">‡∏ô</b>';
                        weeklyData[d.id].status[dayIndex] = shortStat;
                    });
                }
            });
            tbody.innerHTML = ""; let index = 1;
            for(let id in weeklyData) {
                let st = weeklyData[id];
                tbody.innerHTML += `<tr><td style="text-align:center;">${index++}</td><td>${cleanName(st.name)}</td><td style="text-align:center; background:#f8fafc;">${st.status[0]}</td><td style="text-align:center;">${st.status[1]}</td><td style="text-align:center; background:#f8fafc;">${st.status[2]}</td><td style="text-align:center;">${st.status[3]}</td><td style="text-align:center; background:#f8fafc;">${st.status[4]}</td></tr>`;
            }
            if(Object.keys(weeklyData).length === 0) tbody.innerHTML = `<tr><td colspan='7' style='text-align:center; padding:20px;'>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>`; 
            if (totalAbs > 0) document.getElementById('teacher-daily-ai').innerHTML = `‚ö†Ô∏è <b>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ:</b> ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏° <b>${totalAbs} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</b> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö`; else document.getElementById('teacher-daily-ai').innerHTML = `üåü <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!</b> ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`;
        });
    }

    function loadSummaryData() {
        let tbody = document.getElementById('summary-body'); tbody.innerHTML = `<tr><td colspan='9' style='text-align:center;'>‚è≥ ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</td></tr>`;
        fetch(`${GAS_API_URL}?action=get_summary&className=${encodeURIComponent(currentClass)}`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                let totalStudents = data.data.length, sumTotal = 0, sumPres = 0, riskCount = 0, html = "";
                if(totalStudents === 0) { tbody.innerHTML = `<tr><td colspan='9' style='text-align:center;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; return; }
                data.data.forEach((d, index) => {
                    let stTotal = d.present + d.personal_leave + d.sick_leave + d.absent + d.late + d.outside;
                    let perc = stTotal > 0 ? (d.present / stTotal) * 100 : 0;
                    if(stTotal > 0) { sumTotal += stTotal; sumPres += d.present; }
                    let percStr = perc.toFixed(1) + '%';
                    let rowClass = ''; let warnIcon = '';
                    if(stTotal > 0 && perc < 80) { riskCount++; rowClass = 'risk-row'; warnIcon = '‚ö†Ô∏è '; percStr = `<span style="color:#ef4444; font-weight:bold;">${percStr}</span>`; } else { percStr = `<span style="color:#10b981; font-weight:bold;">${percStr}</span>`; }
                    html += `<tr class="${rowClass}"><td style="text-align:center;">${index+1}</td><td>${warnIcon}${cleanName(d.name)}</td><td style="color:#10b981; text-align:center; font-weight:bold;">${d.present}</td><td style="color:#eab308; text-align:center;">${d.late}</td><td style="color:#f97316; text-align:center;">${d.personal_leave}</td><td style="color:#f43f5e; text-align:center;">${d.sick_leave}</td><td style="color:#991b1b; text-align:center; font-weight:bold;">${d.absent}</td><td style="color:#3b82f6; text-align:center;">${d.outside}</td><td style="text-align:center;">${percStr}</td></tr>`;
                });
                tbody.innerHTML = html;
                document.getElementById('teacher-stat-grid').style.display = 'flex';
                document.getElementById('tc-total-std').innerText = totalStudents;
                document.getElementById('tc-risk-std').innerText = riskCount;
                let classAvg = sumTotal > 0 ? ((sumPres / sumTotal) * 100).toFixed(1) + "%" : "0%"; document.getElementById('tc-avg-perc').innerText = classAvg;
                document.getElementById('teacher-summary-ai').innerHTML = `‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠ <b>${classAvg}</b> ${riskCount>0?`<br>‚ö†Ô∏è ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${riskCount} ‡∏Ñ‡∏ô (‡πÅ‡∏ñ‡∏ö‡πÅ‡∏î‡∏á)`:`üåü ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 80%`}`;
            }
        });
    }

    // --- ‚öôÔ∏è ADMIN ---
    function loadAdminData() {
        fetch(`${GAS_API_URL}?action=get_admin_data`).then(res => res.json()).then(data => {
            if(data.status === "success") {
                function toFormatDate(dStr) { if (!dStr) return ""; let d = new Date(dStr); if (isNaN(d)) return dStr; return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
                document.getElementById('admin-start').value = toFormatDate(data.config.startDate); document.getElementById('admin-end').value = toFormatDate(data.config.endDate);
                adminHolidays = (data.config.holidays || []).filter(h => h.trim() !== ""); renderAdminCalendar(); 
                let uBody = document.getElementById('admin-users-body'); uBody.innerHTML = "";
                data.users.forEach((u, i) => { uBody.innerHTML += `<tr><td><input type="text" value="${u[0]}"></td><td><input type="text" value="${u[1]}"></td><td><select><option value="teacher" ${u[2]=='teacher'?'selected':''}>Teacher</option><option value="admin" ${u[2]=='admin'?'selected':''}>Admin</option><option value="executive" ${u[2]=='executive'?'selected':''}>Executive</option></select></td><td><input type="text" value="${u[3]}"></td><td><input type="text" value="${u[4]||''}"></td><td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; });
                allAdminStudentsData = data.students; updateClassDropdown(); renderAdminStudents();
            }
        });
    }
    function renderAdminCalendar() {
        let container = document.getElementById('admin-calendar-container'); let startVal = document.getElementById('admin-start').value; let endVal = document.getElementById('admin-end').value;
        if(!startVal || !endVal) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#94a3b8;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>"; document.getElementById('working-days-text').innerText = "0"; return; }
        let sArr = startVal.split('-'); let startDate = new Date(sArr[0], sArr[1]-1, sArr[2]);
        let eArr = endVal.split('-'); let endDate = new Date(eArr[0], eArr[1]-1, eArr[2]);
        if(startDate > endDate) { container.innerHTML = "<div style='color:red;'>‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°</div>"; return; }
        let html = ""; let currMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1); let endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1); const thDays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];
        let totalWorkingDays = 0;
        while(currMonth <= endMonth) {
            let monthName = currMonth.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); html += `<div class="calendar-month"><h4>${monthName}</h4><div class="calendar-grid">`; thDays.forEach(d => html += `<div class="calendar-header">${d}</div>`);
            let firstDay = new Date(currMonth.getFullYear(), currMonth.getMonth(), 1).getDay(); let daysInMonth = new Date(currMonth.getFullYear(), currMonth.getMonth() + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) html += `<div class="calendar-day blank"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                let dateObj = new Date(currMonth.getFullYear(), currMonth.getMonth(), i); let dStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                if(dateObj < startDate || dateObj > endDate) { html += `<div class="calendar-day blank">${i}</div>`; } else {
                    let isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6); let isHoliday = adminHolidays.includes(dStr);
                    if(!isWeekend && !isHoliday) totalWorkingDays++; 
                    let cssClass = (isHoliday || isWeekend) ? 'holiday' : ''; let tooltip = isWeekend ? ' title="‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"' : '';
                    html += `<div class="calendar-day ${cssClass}" onclick="toggleHoliday('${dStr}', ${isWeekend})" ${tooltip}>${i}</div>`;
                }
            }
            html += `</div></div>`; currMonth.setMonth(currMonth.getMonth() + 1);
        }
        container.innerHTML = html; document.getElementById('working-days-text').innerText = totalWorkingDays;
    }
    function toggleHoliday(dateStr, isWeekend) { if(isWeekend) { alert('üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö'); return; } let idx = adminHolidays.indexOf(dateStr); if(idx > -1) adminHolidays.splice(idx, 1); else adminHolidays.push(dateStr); renderAdminCalendar(); }
    async function fetchPublicHolidays() {
        let startVal = document.getElementById('admin-start').value; if(!startVal) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'); return; }
        let year = startVal.split('-')[0]; let btn = document.getElementById('fetch-holidays-btn'); btn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; btn.disabled = true;
        try {
            let res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/TH`); let holidays = await res.json(); let addedCount = 0;
            holidays.forEach(h => { if(!adminHolidays.includes(h.date)) { adminHolidays.push(h.date); addedCount++; } });
            renderAdminCalendar(); btn.innerText = 'üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢'; btn.disabled = false; alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ${addedCount} ‡∏ß‡∏±‡∏ô`);
        } catch(e) { btn.innerText = 'üáπüá≠ ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢'; btn.disabled = false; alert('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
    }
    function updateClassDropdown() { let f = document.getElementById('admin-class-filter'); let s = new Set(); allAdminStudentsData.forEach(x => s.add(x[3])); f.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...s].sort().forEach(c => f.innerHTML += `<option value="${c}">${c}</option>`); }
    function renderAdminStudents() { let b = document.getElementById('admin-students-body'); b.innerHTML = ""; let f = document.getElementById('admin-class-filter').value; allAdminStudentsData.forEach((s, i) => { if (f==='all'||s[3]===f) b.innerHTML += `<tr><td>${s[0]}</td><td>${s[1]}</td><td>${s[2]}</td><td>${s[3]}</td><td><button style="background:red;" onclick="removeStudent(${i})">‡∏•‡∏ö</button></td></tr>`; }); }
    function removeStudent(i) { if(confirm("‡∏•‡∏ö?")) { allAdminStudentsData.splice(i,1); renderAdminStudents(); } }
    function addUserRow() { document.getElementById('admin-users-body').innerHTML += `<tr><td><input type="text"></td><td><input type="text"></td><td><select><option value="teacher">Teacher</option><option value="admin">Admin</option></select></td><td><input type="text"></td><td><input type="text"></td><td><button style="background:red;" onclick="this.parentElement.parentElement.remove()">‡∏•‡∏ö</button></td></tr>`; }
    function addStudentRow() { allAdminStudentsData.push(['','','',document.getElementById('admin-class-filter').value==='all'?'':document.getElementById('admin-class-filter').value]); renderAdminStudents(); }
    function saveAdminData() {
        let btn = document.querySelector('#admin-page > button:last-child'); btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        let u = []; document.querySelectorAll('#admin-users-body tr').forEach(tr => { let i = tr.querySelectorAll('input, select'); u.push([i[0].value, i[1].value, i[2].value, i[3].value, i[4].value]); });
        fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ action: "admin_update", settings: { startDate: document.getElementById('admin-start').value, endDate: document.getElementById('admin-end').value, holidays: adminHolidays }, users: u, students: allAdminStudentsData }) })
        .then(res => res.json()).then(data => { btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"; btn.disabled = false; if(data.status === "success") alert("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); });
    }

    // --- üìä EXECUTIVE ---
    function fetchFullExecData() { 
        document.getElementById('exec-ai-insight').innerHTML = "<p style='text-align:center;'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>";
        fetch(`${GAS_API_URL}?action=get_full_exec_data`).then(res=>res.json()).then(data=>{execFullAttendance=data.attendance; execFullStudents=data.students; updateExecViewDropdown();}); 
    }
    
    function updateExecViewDropdown() {
        let v = document.getElementById('exec-view-type').value, c = document.getElementById('exec-sub-filter-container'), s = document.getElementById('exec-sub-filter'), i = document.getElementById('exec-sub-input');
        s.style.display = 'none'; i.style.display = 'none'; c.style.display = v === 'school' ? 'none' : 'block';
        if(v === 'grade') { s.style.display='block'; let g = new Set(); execFullStudents.forEach(x=>g.add(x[3].split('/')[0])); s.innerHTML='<option value="all">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>'; [...g].sort().forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`); }
        else if(v === 'class') { s.style.display='block'; let cl = new Set(); execFullStudents.forEach(x=>cl.add(x[3])); s.innerHTML='<option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á</option>'; [...cl].sort().forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`); }
        else if(v === 'student') i.style.display='block';
        processExecData();
    }

    function processExecData() {
        let v = document.getElementById('exec-view-type').value, sub = v==='student'?document.getElementById('exec-sub-input').value:document.getElementById('exec-sub-filter').value;
        let st = document.getElementById('exec-date-start').valueAsDate||new Date(0), en = document.getElementById('exec-date-end').valueAsDate||new Date();
        let stats = {p:0, late:0, pleave:0, sleave:0, abs:0, out:0, total:0}, gStat = {};
        
        execFullAttendance.forEach(row => {
            let dArr = row[0].split('/'); let rD = new Date(dArr[2], dArr[1]-1, dArr[0]);
            if(rD >= st && rD <= en) {
                let match = (v==='school')||(v==='grade'&&(sub==='all'||row[3].startsWith(sub)))||(v==='class'&&(sub==='all'||row[3]===sub))||(v==='student'&&row[1]===sub);
                if(match) {
                    stats.total++; let key = v==='school'?row[3]:(v==='class'?row[2]:row[0]);
                    if(!gStat[key]) gStat[key] = {‡∏°‡∏≤:0, ‡∏™‡∏≤‡∏¢:0, ‡∏•‡∏≤‡∏Å‡∏¥‡∏à:0, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢:0, ‡∏ô‡∏≠‡∏Å‡∏£_‡∏£:0, ‡∏Ç‡∏≤‡∏î:0, total:0};
                    
                    let statText = row[4];
                    gStat[key].total++;
                    if(statText === '‡∏°‡∏≤') { stats.p++; gStat[key].‡∏°‡∏≤++; }
                    else if(statText === '‡∏™‡∏≤‡∏¢') { stats.late++; gStat[key].‡∏™‡∏≤‡∏¢++; }
                    else if(statText === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à') { stats.pleave++; gStat[key].‡∏•‡∏≤‡∏Å‡∏¥‡∏à++; }
                    else if(statText === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') { stats.sleave++; gStat[key].‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢++; }
                    else if(statText === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') { stats.out++; gStat[key].‡∏ô‡∏≠‡∏Å‡∏£_‡∏£++; }
                    else { stats.abs++; gStat[key].‡∏Ç‡∏≤‡∏î++; } 
                }
            }
        });
        
        document.getElementById('exec-total').innerText = stats.total; 
        let overallPerc = stats.total > 0 ? ((stats.p / stats.total) * 100).toFixed(1) : 0;
        document.getElementById('exec-present-perc').innerText = overallPerc + '%';
        
        let ctx = document.getElementById('execChart').getContext('2d'); if(execChartInstance) execChartInstance.destroy();
        let labels = Object.keys(gStat).sort();
        let d1 = labels.map(k=>gStat[k].‡∏°‡∏≤), d2 = labels.map(k=>gStat[k].‡∏™‡∏≤‡∏¢), d3 = labels.map(k=>gStat[k].‡∏•‡∏≤‡∏Å‡∏¥‡∏à);
        let d4 = labels.map(k=>gStat[k].‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢), d5 = labels.map(k=>gStat[k].‡∏ô‡∏≠‡∏Å‡∏£_‡∏£), d6 = labels.map(k=>gStat[k].‡∏Ç‡∏≤‡∏î);

        execChartInstance = new Chart(ctx, { 
            type:'bar', 
            data:{ labels:labels, datasets:[{label:'‡∏°‡∏≤', data:d1, backgroundColor:'#10b981'},{label:'‡∏™‡∏≤‡∏¢', data:d2, backgroundColor:'#eab308'},{label:'‡∏•‡∏≤‡∏Å‡∏¥‡∏à', data:d3, backgroundColor:'#f97316'},{label:'‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', data:d4, backgroundColor:'#f43f5e'},{label:'‡∏ô‡∏≠‡∏Å ‡∏£.‡∏£.', data:d5, backgroundColor:'#3b82f6'},{label:'‡∏Ç‡∏≤‡∏î', data:d6, backgroundColor:'#991b1b'}] }, 
            options:{ responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}} } 
        });

        let tBody = document.getElementById('exec-detail-body'); tBody.innerHTML = "";
        if(labels.length === 0) { tBody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>"; }
        else {
            labels.forEach(k => {
                let g = gStat[k];
                let p = g.total > 0 ? ((g.‡∏°‡∏≤ / g.total) * 100).toFixed(1) : 0;
                let color = p >= 80 ? '#10b981' : '#ef4444';
                tBody.innerHTML += `<tr>
                    <td style="text-align:left; font-weight:bold;">${k}</td>
                    <td style="color:#10b981;">${g.‡∏°‡∏≤}</td><td style="color:#eab308;">${g.‡∏™‡∏≤‡∏¢}</td>
                    <td style="color:#f97316;">${g.‡∏•‡∏≤‡∏Å‡∏¥‡∏à}</td><td style="color:#f43f5e;">${g.‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢}</td>
                    <td style="color:#991b1b; font-weight:bold;">${g.‡∏Ç‡∏≤‡∏î}</td><td style="color:#3b82f6;">${g.‡∏ô‡∏≠‡∏Å‡∏£_‡∏£}</td>
                    <td style="color:${color}; font-weight:bold;">${p}%</td>
                </tr>`;
            });
        }

        generateExecutiveAIInsight(stats, gStat, v, overallPerc);
    }

    function generateExecutiveAIInsight(totalStats, groupStats, viewType, overallPerc) {
        let aiBox = document.getElementById('exec-ai-insight');
        if (totalStats.total === 0) { aiBox.innerHTML = "<p style='color:#ef4444;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö</p>"; return; }

        let html = `<p><b>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</b> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <span style="color:${overallPerc >= 80 ? '#10b981' : '#ef4444'}; font-weight:bold; font-size:16px;">${overallPerc}%</span> (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalStats.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>`;

        if (viewType === 'school' || viewType === 'grade' || viewType === 'class') {
            let best = { name: '', rate: -1 }, worst = { name: '', rate: 101 }, riskCount = 0;
            
            for (let k in groupStats) {
                let g = groupStats[k];
                let rate = (g.‡∏°‡∏≤ / g.total) * 100;
                if (rate > best.rate) { best.rate = rate; best.name = k; }
                if (rate < worst.rate) { worst.rate = rate; worst.name = k; }
                if (rate < 80) riskCount++;
            }

            html += `<ul>`;
            if (best.name) html += `<li>üèÜ <b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:</b> ${best.name} ‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏π‡∏á‡∏ñ‡∏∂‡∏á ${best.rate.toFixed(1)}%</li>`;
            if (worst.name && worst.rate < 100) html += `<li>‚ö†Ô∏è <b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ${worst.name} ‡∏°‡∏µ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà ${worst.rate.toFixed(1)}%</li>`;
            html += `</ul>`;

            let issues = [
                { name: '‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', val: totalStats.abs }, { name: '‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', val: totalStats.sleave },
                { name: '‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à', val: totalStats.pleave }, { name: '‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢', val: totalStats.late }
            ];
            issues.sort((a,b) => b.val - a.val);
            let topIssue = issues[0];

            html += `<p style="margin-top:10px;"><b>üí° ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive Action Plan):</b></p><ul>`;
            
            if (overallPerc < 80) html += `<li>üî¥ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <b>‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 80%</b> ‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏≠‡∏á‡∏Ø ‡∏Ñ‡∏ß‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏≤‡∏£‡∏∞‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö</li>`;
            else html += `<li>üü¢ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏±‡πâ‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</li>`;
            
            if (riskCount > 0) html += `<li>üî¥ ‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ñ‡∏∂‡∏á <b>${riskCount} ‡∏Å‡∏•‡∏∏‡πà‡∏°</b> (‡∏ô‡∏≥‡πÇ‡∏î‡∏¢ ${worst.name}) ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö</li>`;

            if (topIssue.val > 0) {
                if (topIssue.name === '‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') html += `<li>üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>"‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" (${topIssue.val} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b> ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡∏ö</li>`;
                else if (topIssue.name === '‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') html += `<li>üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>"‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" (${topIssue.val} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•‡∏Ñ‡∏£‡∏±‡∏ö</li>`;
                else if (topIssue.name === '‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢') html += `<li>üîç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>"‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢" (${topIssue.val} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</b> ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö</li>`;
            }
            html += `</ul>`;
        } else {
             if (overallPerc >= 80) html += `<br>üí° <b>‡∏™‡∏£‡∏∏‡∏õ:</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`;
             else html += `<br>üí° <b>‡∏™‡∏£‡∏∏‡∏õ:</b> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á <b>‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö</b> ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏ç‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
        }
        aiBox.innerHTML = html;
    }

    // --- üßë‚Äçüéì STUDENT ---
    function loadStudentReport(id) {
        fetch(`${GAS_API_URL}?action=get_student_report&studentId=${id}`).then(res=>res.json()).then(data => {
            document.getElementById('st-stat-present').innerText = data.stats.present; document.getElementById('st-stat-absent').innerText = data.stats.absent; document.getElementById('st-stat-leave').innerText = data.stats.personal_leave + data.stats.sick_leave;
            let p = data.stats.total > 0 ? (data.stats.present / data.stats.total * 100).toFixed(1) : 0;
            document.getElementById('ai-assessment-text').innerHTML = p >= 80 ? `üåü <b>‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°:</b> ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!` : `‚ö†Ô∏è <b>‡∏£‡∏∞‡∏ß‡∏±‡∏á:</b> ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (${p}%) ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö`;
            let b = document.getElementById('student-history-body'); b.innerHTML = "";
            data.history.reverse().forEach(x => b.innerHTML += `<tr><td>${x.date}</td><td>${x.status}</td><td>${x.note||'-'}</td></tr>`);
        });
    }

    function logout() { 
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) location.reload(); 
    }
</script>

</body>
</html>
